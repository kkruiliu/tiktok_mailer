<html>
<head>
<title>resolver.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
resolver.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (C) Dnspython Contributors, see LICENSE for text of ISC license</span>

<span class="s0"># Copyright (C) 2003-2017 Nominum, Inc.</span>
<span class="s0">#</span>
<span class="s0"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="s0"># documentation for any purpose with or without fee is hereby granted,</span>
<span class="s0"># provided that the above copyright notice and this permission notice</span>
<span class="s0"># appear in all copies.</span>
<span class="s0">#</span>
<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND NOMINUM DISCLAIMS ALL WARRANTIES</span>
<span class="s0"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="s0"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL NOMINUM BE LIABLE FOR</span>
<span class="s0"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="s0"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="s0"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="s0"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="s2">&quot;&quot;&quot;DNS stub resolver.&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">random</span>
<span class="s3">import </span><span class="s1">socket</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">threading</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">import </span><span class="s1">warnings</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">Iterator</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Sequence</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span>
<span class="s3">from </span><span class="s1">urllib</span><span class="s4">.</span><span class="s1">parse </span><span class="s3">import </span><span class="s1">urlparse</span>

<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_ddr</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">ipv4</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">ipv6</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">query</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">svcbbase</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">reversename</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span>

<span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform </span><span class="s4">== </span><span class="s5">&quot;win32&quot;</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
    <span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">win32util</span>


<span class="s3">class </span><span class="s1">NXDOMAIN</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The DNS query name does not exist.&quot;&quot;&quot;</span>

    <span class="s1">supp_kwargs </span><span class="s4">= {</span><span class="s5">&quot;qnames&quot;</span><span class="s4">, </span><span class="s5">&quot;responses&quot;</span><span class="s4">}</span>
    <span class="s1">fmt </span><span class="s4">= </span><span class="s3">None  </span><span class="s0"># we have our own __str__ implementation</span>

    <span class="s0"># pylint: disable=arguments-differ</span>

    <span class="s0"># We do this as otherwise mypy complains about unexpected keyword argument</span>
    <span class="s0"># idna_exception</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_check_kwargs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">qnames</span><span class="s4">, </span><span class="s1">responses</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">, (</span><span class="s1">list</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">, </span><span class="s1">set</span><span class="s4">)):</span>
            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span><span class="s5">&quot;qnames must be a list, tuple or set&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span><span class="s5">&quot;qnames must contain at least one element&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">responses </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">responses </span><span class="s4">= {}</span>
        <span class="s3">elif not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">responses</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span><span class="s5">&quot;responses must be a dict(qname=response)&quot;</span><span class="s4">)</span>
        <span class="s1">kwargs </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">=</span><span class="s1">qnames</span><span class="s4">, </span><span class="s1">responses</span><span class="s4">=</span><span class="s1">responses</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">kwargs</span>

    <span class="s3">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s5">&quot;qnames&quot; </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">__str__</span><span class="s4">()</span>
        <span class="s1">qnames </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;qnames&quot;</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;None of DNS query names exist&quot;</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;The DNS query name does not exist&quot;</span>
        <span class="s1">qnames </span><span class="s4">= </span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">map</span><span class="s4">(</span><span class="s1">str</span><span class="s4">, </span><span class="s1">qnames</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">msg</span><span class="s3">}</span><span class="s5">: </span><span class="s3">{</span><span class="s1">qnames</span><span class="s3">}</span><span class="s5">&quot;</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Return the unresolved canonical name.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s5">&quot;qnames&quot; </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s5">&quot;parametrized exception required&quot;</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">qname </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;qnames&quot;</span><span class="s4">]:</span>
            <span class="s1">response </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;responses&quot;</span><span class="s4">][</span><span class="s1">qname</span><span class="s4">]</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">cname </span><span class="s4">= </span><span class="s1">response</span><span class="s4">.</span><span class="s1">canonical_name</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">cname </span><span class="s4">!= </span><span class="s1">qname</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">cname</span>
            <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
                <span class="s0"># We can just eat this exception as it means there was</span>
                <span class="s0"># something wrong with the response.</span>
                <span class="s3">pass</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;qnames&quot;</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__add__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">e_nx</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Augment by results from another NXDOMAIN exception.&quot;&quot;&quot;</span>
        <span class="s1">qnames0 </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;qnames&quot;</span><span class="s4">, []))</span>
        <span class="s1">responses0 </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;responses&quot;</span><span class="s4">, {}))</span>
        <span class="s1">responses1 </span><span class="s4">= </span><span class="s1">e_nx</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;responses&quot;</span><span class="s4">, {})</span>
        <span class="s3">for </span><span class="s1">qname1 </span><span class="s3">in </span><span class="s1">e_nx</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;qnames&quot;</span><span class="s4">, []):</span>
            <span class="s3">if </span><span class="s1">qname1 </span><span class="s3">not in </span><span class="s1">qnames0</span><span class="s4">:</span>
                <span class="s1">qnames0</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">qname1</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">qname1 </span><span class="s3">in </span><span class="s1">responses1</span><span class="s4">:</span>
                <span class="s1">responses0</span><span class="s4">[</span><span class="s1">qname1</span><span class="s4">] = </span><span class="s1">responses1</span><span class="s4">[</span><span class="s1">qname1</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">NXDOMAIN</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">=</span><span class="s1">qnames0</span><span class="s4">, </span><span class="s1">responses</span><span class="s4">=</span><span class="s1">responses0</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">qnames</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;All of the names that were tried. 
 
        Returns a list of ``dns.name.Name``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;qnames&quot;</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">responses</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;A map from queried names to their NXDOMAIN responses. 
 
        Returns a dict mapping a ``dns.name.Name`` to a 
        ``dns.message.Message``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;responses&quot;</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">response</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;The response for query *qname*. 
 
        Returns a ``dns.message.Message``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;responses&quot;</span><span class="s4">][</span><span class="s1">qname</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">YXDOMAIN</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The DNS query name is too long after DNAME substitution.&quot;&quot;&quot;</span>


<span class="s1">ErrorTuple </span><span class="s4">= </span><span class="s1">Tuple</span><span class="s4">[</span>
    <span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">bool</span><span class="s4">,</span>
    <span class="s1">int</span><span class="s4">,</span>
    <span class="s1">Union</span><span class="s4">[</span><span class="s1">Exception</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">],</span>
<span class="s4">]</span>


<span class="s3">def </span><span class="s1">_errors_to_text</span><span class="s4">(</span><span class="s1">errors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">ErrorTuple</span><span class="s4">]) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Turn a resolution errors trace into a list of text.&quot;&quot;&quot;</span>
    <span class="s1">texts </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">err </span><span class="s3">in </span><span class="s1">errors</span><span class="s4">:</span>
        <span class="s1">texts</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s5">f&quot;Server </span><span class="s3">{</span><span class="s1">err</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span><span class="s3">} </span><span class="s5">answered </span><span class="s3">{</span><span class="s1">err</span><span class="s4">[</span><span class="s6">3</span><span class="s4">]</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">texts</span>


<span class="s3">class </span><span class="s1">LifetimeTimeout</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">Timeout</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The resolution lifetime expired.&quot;&quot;&quot;</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;The resolution lifetime expired.&quot;</span>
    <span class="s1">fmt </span><span class="s4">= </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">msg</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]</span><span class="s3">} </span><span class="s5">after </span><span class="s3">{{</span><span class="s5">timeout:.3f</span><span class="s3">}} </span><span class="s5">seconds: </span><span class="s3">{{</span><span class="s5">errors</span><span class="s3">}}</span><span class="s5">&quot;</span>
    <span class="s1">supp_kwargs </span><span class="s4">= {</span><span class="s5">&quot;timeout&quot;</span><span class="s4">, </span><span class="s5">&quot;errors&quot;</span><span class="s4">}</span>

    <span class="s0"># We do this as otherwise mypy complains about unexpected keyword argument</span>
    <span class="s0"># idna_exception</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_fmt_kwargs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">srv_msgs </span><span class="s4">= </span><span class="s1">_errors_to_text</span><span class="s4">(</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;errors&quot;</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">_fmt_kwargs</span><span class="s4">(</span>
            <span class="s1">timeout</span><span class="s4">=</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;timeout&quot;</span><span class="s4">], </span><span class="s1">errors</span><span class="s4">=</span><span class="s5">&quot;; &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">srv_msgs</span><span class="s4">)</span>
        <span class="s4">)</span>


<span class="s0"># We added more detail to resolution timeouts, but they are still</span>
<span class="s0"># subclasses of dns.exception.Timeout for backwards compatibility.  We also</span>
<span class="s0"># keep dns.resolver.Timeout defined for backwards compatibility.</span>
<span class="s1">Timeout </span><span class="s4">= </span><span class="s1">LifetimeTimeout</span>


<span class="s3">class </span><span class="s1">NoAnswer</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The DNS response does not contain an answer to the question.&quot;&quot;&quot;</span>

    <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;The DNS response does not contain an answer to the question: {query}&quot;</span>
    <span class="s1">supp_kwargs </span><span class="s4">= {</span><span class="s5">&quot;response&quot;</span><span class="s4">}</span>

    <span class="s0"># We do this as otherwise mypy complains about unexpected keyword argument</span>
    <span class="s0"># idna_exception</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_fmt_kwargs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">_fmt_kwargs</span><span class="s4">(</span><span class="s1">query</span><span class="s4">=</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;response&quot;</span><span class="s4">].</span><span class="s1">question</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">response</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;response&quot;</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">NoNameservers</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;All nameservers failed to answer the query. 
 
    errors: list of servers and respective errors 
    The type of errors is 
    [(server IP address, any object convertible to string)]. 
    Non-empty errors list will add explanatory message () 
    &quot;&quot;&quot;</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s5">&quot;All nameservers failed to answer the query.&quot;</span>
    <span class="s1">fmt </span><span class="s4">= </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">msg</span><span class="s4">[:-</span><span class="s6">1</span><span class="s4">]</span><span class="s3">} {{</span><span class="s5">query</span><span class="s3">}}</span><span class="s5">: </span><span class="s3">{{</span><span class="s5">errors</span><span class="s3">}}</span><span class="s5">&quot;</span>
    <span class="s1">supp_kwargs </span><span class="s4">= {</span><span class="s5">&quot;request&quot;</span><span class="s4">, </span><span class="s5">&quot;errors&quot;</span><span class="s4">}</span>

    <span class="s0"># We do this as otherwise mypy complains about unexpected keyword argument</span>
    <span class="s0"># idna_exception</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_fmt_kwargs</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">srv_msgs </span><span class="s4">= </span><span class="s1">_errors_to_text</span><span class="s4">(</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;errors&quot;</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">_fmt_kwargs</span><span class="s4">(</span>
            <span class="s1">query</span><span class="s4">=</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;request&quot;</span><span class="s4">].</span><span class="s1">question</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s5">&quot;; &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">srv_msgs</span><span class="s4">)</span>
        <span class="s4">)</span>


<span class="s3">class </span><span class="s1">NotAbsolute</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;An absolute domain name is required but a relative name was provided.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoRootSOA</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;There is no SOA RR at the DNS root name. This should never happen!&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoMetaqueries</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;DNS metaqueries are not allowed.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoResolverConfiguration</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Resolver configuration could not be read or specified no nameservers.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">Answer</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;DNS stub resolver answer. 
 
    Instances of this class bundle up the result of a successful DNS 
    resolution. 
 
    For convenience, the answer object implements much of the sequence 
    protocol, forwarding to its ``rrset`` attribute.  E.g. 
    ``for a in answer`` is equivalent to ``for a in answer.rrset``. 
    ``answer[i]`` is equivalent to ``answer.rrset[i]``, and 
    ``answer[i:j]`` is equivalent to ``answer.rrset[i:j]``. 
 
    Note that CNAMEs or DNAMEs in the response may mean that answer 
    RRset's name might not be the query name. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">qname</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">,</span>
        <span class="s1">response</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">QueryMessage</span><span class="s4">,</span>
        <span class="s1">nameserver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">port</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">qname </span><span class="s4">= </span><span class="s1">qname</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">= </span><span class="s1">rdtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass </span><span class="s4">= </span><span class="s1">rdclass</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">response </span><span class="s4">= </span><span class="s1">response</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver </span><span class="s4">= </span><span class="s1">nameserver</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">port </span><span class="s4">= </span><span class="s1">port</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">chaining_result </span><span class="s4">= </span><span class="s1">response</span><span class="s4">.</span><span class="s1">resolve_chaining</span><span class="s4">()</span>
        <span class="s0"># Copy some attributes out of chaining_result for backwards</span>
        <span class="s0"># compatibility and convenience.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">canonical_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">chaining_result</span><span class="s4">.</span><span class="s1">canonical_name</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">chaining_result</span><span class="s4">.</span><span class="s1">answer</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">chaining_result</span><span class="s4">.</span><span class="s1">minimum_ttl</span>

    <span class="s3">def </span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">attr</span><span class="s4">):  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">if </span><span class="s1">attr </span><span class="s4">== </span><span class="s5">&quot;name&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s3">elif </span><span class="s1">attr </span><span class="s4">== </span><span class="s5">&quot;ttl&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">ttl</span>
        <span class="s3">elif </span><span class="s1">attr </span><span class="s4">== </span><span class="s5">&quot;covers&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">covers</span>
        <span class="s3">elif </span><span class="s1">attr </span><span class="s4">== </span><span class="s5">&quot;rdclass&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdclass</span>
        <span class="s3">elif </span><span class="s1">attr </span><span class="s4">== </span><span class="s5">&quot;rdtype&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdtype</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">AttributeError</span><span class="s4">(</span><span class="s1">attr</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__len__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">) </span><span class="s3">or </span><span class="s6">0</span>

    <span class="s3">def </span><span class="s1">__iter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">Rdata</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">and </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">) </span><span class="s3">or </span><span class="s1">iter</span><span class="s4">(</span><span class="s1">tuple</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">IndexError</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__delitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">IndexError</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">Answers</span><span class="s4">(</span><span class="s1">dict</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A dict of DNS stub resolver answers, indexed by type.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">HostAnswers</span><span class="s4">(</span><span class="s1">Answers</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A dict of DNS stub resolver answers to a host name lookup, indexed by 
    type. 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">make</span><span class="s4">(</span>
        <span class="s1">cls</span><span class="s4">,</span>
        <span class="s1">v6</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">v4</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">add_empty</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s5">&quot;HostAnswers&quot;</span><span class="s4">:</span>
        <span class="s1">answers </span><span class="s4">= </span><span class="s1">HostAnswers</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">v6 </span><span class="s3">is not None and </span><span class="s4">(</span><span class="s1">add_empty </span><span class="s3">or </span><span class="s1">v6</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">):</span>
            <span class="s1">answers</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AAAA</span><span class="s4">] = </span><span class="s1">v6</span>
        <span class="s3">if </span><span class="s1">v4 </span><span class="s3">is not None and </span><span class="s4">(</span><span class="s1">add_empty </span><span class="s3">or </span><span class="s1">v4</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">):</span>
            <span class="s1">answers</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">] = </span><span class="s1">v4</span>
        <span class="s3">return </span><span class="s1">answers</span>

    <span class="s0"># Returns pairs of (address, family) from this result, potentially</span>
    <span class="s0"># filtering by address family.</span>
    <span class="s3">def </span><span class="s1">addresses_and_families</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span>
    <span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]]:</span>
        <span class="s3">if </span><span class="s1">family </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">:</span>
            <span class="s3">yield from </span><span class="s1">self</span><span class="s4">.</span><span class="s1">addresses_and_families</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span><span class="s4">)</span>
            <span class="s3">yield from </span><span class="s1">self</span><span class="s4">.</span><span class="s1">addresses_and_families</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span><span class="s4">)</span>
            <span class="s3">return</span>
        <span class="s3">elif </span><span class="s1">family </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span><span class="s4">:</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AAAA</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">family </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span><span class="s4">:</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s5">f&quot;unknown address family </span><span class="s3">{</span><span class="s1">family</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">answer</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">answer</span><span class="s4">:</span>
                <span class="s3">yield </span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">address</span><span class="s4">, </span><span class="s1">family</span><span class="s4">)</span>

    <span class="s0"># Returns addresses from this result, potentially filtering by</span>
    <span class="s0"># address family.</span>
    <span class="s3">def </span><span class="s1">addresses</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">pair</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] </span><span class="s3">for </span><span class="s1">pair </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">addresses_and_families</span><span class="s4">(</span><span class="s1">family</span><span class="s4">))</span>

    <span class="s0"># Returns the canonical name from this result.</span>
    <span class="s3">def </span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">:</span>
        <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AAAA</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">canonical_name</span>


<span class="s3">class </span><span class="s1">CacheStatistics</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Cache Statistics&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">hits</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">, </span><span class="s1">misses</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">= </span><span class="s1">hits</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">misses </span><span class="s4">= </span><span class="s1">misses</span>

    <span class="s3">def </span><span class="s1">reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">misses </span><span class="s4">= </span><span class="s6">0</span>

    <span class="s3">def </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s5">&quot;CacheStatistics&quot;</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">CacheStatistics</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">hits</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">misses</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">CacheBase</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">lock </span><span class="s4">= </span><span class="s1">threading</span><span class="s4">.</span><span class="s1">Lock</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics </span><span class="s4">= </span><span class="s1">CacheStatistics</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">reset_statistics</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Reset all statistics to zero.&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">hits</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;How many hits has the cache had?&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">hits</span>

    <span class="s3">def </span><span class="s1">misses</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;How many misses has the cache had?&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">misses</span>

    <span class="s3">def </span><span class="s1">get_statistics_snapshot</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; CacheStatistics</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return a consistent snapshot of all the statistics. 
 
        If running with multiple threads, it's better to take a 
        snapshot than to call statistics methods such as hits() and 
        misses() individually. 
        &quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">clone</span><span class="s4">()</span>


<span class="s1">CacheKey </span><span class="s4">= </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">Cache</span><span class="s4">(</span><span class="s1">CacheBase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Simple thread-safe DNS answer cache.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">cleaning_interval</span><span class="s4">: </span><span class="s1">float </span><span class="s4">= </span><span class="s6">300.0</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;*cleaning_interval*, a ``float`` is the number of seconds between 
        periodic cleanings. 
        &quot;&quot;&quot;</span>

        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">CacheKey</span><span class="s4">, </span><span class="s1">Answer</span><span class="s4">] = {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">cleaning_interval </span><span class="s4">= </span><span class="s1">cleaning_interval</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">next_cleaning</span><span class="s4">: </span><span class="s1">float </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">cleaning_interval</span>

    <span class="s3">def </span><span class="s1">_maybe_clean</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Clean the cache if it's time to do so.&quot;&quot;&quot;</span>

        <span class="s1">now </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">next_cleaning </span><span class="s4">&lt;= </span><span class="s1">now</span><span class="s4">:</span>
            <span class="s1">keys_to_delete </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">v</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">&lt;= </span><span class="s1">now</span><span class="s4">:</span>
                    <span class="s1">keys_to_delete</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">k</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">keys_to_delete</span><span class="s4">:</span>
                <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">k</span><span class="s4">]</span>
            <span class="s1">now </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">next_cleaning </span><span class="s4">= </span><span class="s1">now </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">cleaning_interval</span>

    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">CacheKey</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Get the answer associated with *key*. 
 
        Returns None if no answer is cached for the key. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
 
        Returns a ``dns.resolver.Answer`` or ``None``. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_maybe_clean</span><span class="s4">()</span>
            <span class="s1">v </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">v </span><span class="s3">is None or </span><span class="s1">v</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">&lt;= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">():</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">misses </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s3">return None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">return </span><span class="s1">v</span>

    <span class="s3">def </span><span class="s1">put</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">CacheKey</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">Answer</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Associate key and value in the cache. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
 
        *value*, a ``dns.resolver.Answer``, the answer. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_maybe_clean</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">flush</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">CacheKey</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Flush the cache. 
 
        If *key* is not ``None``, only that item is flushed.  Otherwise the entire cache 
        is flushed. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">key </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">:</span>
                    <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= {}</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">next_cleaning </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() + </span><span class="s1">self</span><span class="s4">.</span><span class="s1">cleaning_interval</span>


<span class="s3">class </span><span class="s1">LRUCacheNode</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;LRUCache node.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">key </span><span class="s4">= </span><span class="s1">key</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">value </span><span class="s4">= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">prev </span><span class="s4">= </span><span class="s1">self</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">next </span><span class="s4">= </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">link_after</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">node</span><span class="s4">: </span><span class="s5">&quot;LRUCacheNode&quot;</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">prev </span><span class="s4">= </span><span class="s1">node</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">next </span><span class="s4">= </span><span class="s1">node</span><span class="s4">.</span><span class="s1">next</span>
        <span class="s1">node</span><span class="s4">.</span><span class="s1">next</span><span class="s4">.</span><span class="s1">prev </span><span class="s4">= </span><span class="s1">self</span>
        <span class="s1">node</span><span class="s4">.</span><span class="s1">next </span><span class="s4">= </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">unlink</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">next</span><span class="s4">.</span><span class="s1">prev </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">prev</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">prev</span><span class="s4">.</span><span class="s1">next </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">next</span>


<span class="s3">class </span><span class="s1">LRUCache</span><span class="s4">(</span><span class="s1">CacheBase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Thread-safe, bounded, least-recently-used DNS answer cache. 
 
    This cache is better than the simple cache (above) if you're 
    running a web crawler or other process that does a lot of 
    resolutions.  The LRUCache has a maximum number of nodes, and when 
    it is full, the least-recently used node is removed to make space 
    for a new one. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">max_size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">100000</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;*max_size*, an ``int``, is the maximum number of nodes to cache; 
        it must be greater than 0. 
        &quot;&quot;&quot;</span>

        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">CacheKey</span><span class="s4">, </span><span class="s1">LRUCacheNode</span><span class="s4">] = {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">set_max_size</span><span class="s4">(</span><span class="s1">max_size</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">: </span><span class="s1">LRUCacheNode </span><span class="s4">= </span><span class="s1">LRUCacheNode</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">.</span><span class="s1">prev </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">.</span><span class="s1">next </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span>

    <span class="s3">def </span><span class="s1">set_max_size</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">max_size</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">max_size </span><span class="s4">&lt; </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">max_size </span><span class="s4">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">max_size </span><span class="s4">= </span><span class="s1">max_size</span>

    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">CacheKey</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Get the answer associated with *key*. 
 
        Returns None if no answer is cached for the key. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
 
        Returns a ``dns.resolver.Answer`` or ``None``. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">node </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">node </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">misses </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s3">return None</span>
            <span class="s0"># Unlink because we're either going to move the node to the front</span>
            <span class="s0"># of the LRU list or we're going to free it.</span>
            <span class="s1">node</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">&lt;= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">():</span>
                <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">node</span><span class="s4">.</span><span class="s1">key</span><span class="s4">]</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">misses </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s3">return None</span>
            <span class="s1">node</span><span class="s4">.</span><span class="s1">link_after</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">statistics</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s1">node</span><span class="s4">.</span><span class="s1">hits </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">return </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">get_hits_for_key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">CacheKey</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return the number of cache hits associated with the specified key.&quot;&quot;&quot;</span>
        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">node </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">node </span><span class="s3">is None or </span><span class="s1">node</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">&lt;= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">():</span>
                <span class="s3">return </span><span class="s6">0</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">node</span><span class="s4">.</span><span class="s1">hits</span>

    <span class="s3">def </span><span class="s1">put</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">CacheKey</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">Answer</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Associate key and value in the cache. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
 
        *value*, a ``dns.resolver.Answer``, the answer. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s1">node </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">node </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">node</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>
                <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">node</span><span class="s4">.</span><span class="s1">key</span><span class="s4">]</span>
            <span class="s3">while </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">) &gt;= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">max_size</span><span class="s4">:</span>
                <span class="s1">gnode </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">.</span><span class="s1">prev</span>
                <span class="s1">gnode</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>
                <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">gnode</span><span class="s4">.</span><span class="s1">key</span><span class="s4">]</span>
            <span class="s1">node </span><span class="s4">= </span><span class="s1">LRUCacheNode</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>
            <span class="s1">node</span><span class="s4">.</span><span class="s1">link_after</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">node</span>

    <span class="s3">def </span><span class="s1">flush</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">CacheKey</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Flush the cache. 
 
        If *key* is not ``None``, only that item is flushed.  Otherwise the entire cache 
        is flushed. 
 
        *key*, a ``(dns.name.Name, dns.rdatatype.RdataType, dns.rdataclass.RdataClass)`` 
        tuple whose values are the query name, rdtype, and rdclass respectively. 
        &quot;&quot;&quot;</span>

        <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lock</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">node </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">node </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">node</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>
                    <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">node</span><span class="s4">.</span><span class="s1">key</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">gnode </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">.</span><span class="s1">next</span>
                <span class="s3">while </span><span class="s1">gnode </span><span class="s4">!= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sentinel</span><span class="s4">:</span>
                    <span class="s1">next </span><span class="s4">= </span><span class="s1">gnode</span><span class="s4">.</span><span class="s1">next</span>
                    <span class="s1">gnode</span><span class="s4">.</span><span class="s1">unlink</span><span class="s4">()</span>
                    <span class="s1">gnode </span><span class="s4">= </span><span class="s1">next</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= {}</span>


<span class="s3">class </span><span class="s1">_Resolution</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Helper class for dns.resolver.Resolver.resolve(). 
 
    All of the &quot;business logic&quot; of resolution is encapsulated in this 
    class, allowing us to have multiple resolve() implementations 
    using different I/O schemes without copying all of the 
    complicated logic. 
 
    This class is a &quot;friend&quot; to dns.resolver.Resolver and manipulates 
    resolver data structures directly. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">resolver</span><span class="s4">: </span><span class="s5">&quot;BaseResolver&quot;</span><span class="s4">,</span>
        <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool</span><span class="s4">,</span>
        <span class="s1">search</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">qname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdtype</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">is_metatype</span><span class="s4">(</span><span class="s1">rdtype</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">NoMetaqueries</span>
        <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">is_metaclass</span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">NoMetaqueries</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver </span><span class="s4">= </span><span class="s1">resolver</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">qnames_to_try </span><span class="s4">= </span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">_get_qnames_to_try</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">search</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">qnames </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">qnames_to_try</span><span class="s4">[:]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">= </span><span class="s1">rdtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass </span><span class="s4">= </span><span class="s1">rdclass</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp </span><span class="s4">= </span><span class="s1">tcp</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">raise_on_no_answer </span><span class="s4">= </span><span class="s1">raise_on_no_answer</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nxdomain_responses</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">QueryMessage</span><span class="s4">] = {}</span>
        <span class="s0"># Initialize other things to help analysis tools</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">qname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">empty</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">] = []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">current_nameservers</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">] = []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">ErrorTuple</span><span class="s4">] = []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">retry_with_tcp </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">request</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">QueryMessage</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">backoff </span><span class="s4">= </span><span class="s6">0.0</span>

    <span class="s3">def </span><span class="s1">next_request</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">QueryMessage</span><span class="s4">], </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Get the next request to send, and check the cache. 
 
        Returns a (request, answer) tuple.  At most one of request or 
        answer will not be None. 
        &quot;&quot;&quot;</span>

        <span class="s0"># We return a tuple instead of Union[Message,Answer] as it lets</span>
        <span class="s0"># the caller avoid isinstance().</span>

        <span class="s3">while </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qnames</span><span class="s4">) &gt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">qname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">qnames</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>

            <span class="s0"># Do we know the answer?</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">:</span>
                <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span>
                    <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">answer </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">is None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">raise_on_no_answer</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">NoAnswer</span><span class="s4">(</span><span class="s1">response</span><span class="s4">=</span><span class="s1">answer</span><span class="s4">.</span><span class="s1">response</span><span class="s4">)</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s1">answer</span><span class="s4">)</span>
                <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span>
                    <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">answer </span><span class="s3">is not None and </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">response</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">() == </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">:</span>
                    <span class="s0"># cached NXDOMAIN; record it and continue to next</span>
                    <span class="s0"># name.</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nxdomain_responses</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">] = </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">response</span>
                    <span class="s3">continue</span>

            <span class="s0"># Build the request</span>
            <span class="s1">request </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">make_query</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">keyname </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">request</span><span class="s4">.</span><span class="s1">use_tsig</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">keyname</span><span class="s4">,</span>
                    <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">keyalgorithm</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s1">request</span><span class="s4">.</span><span class="s1">use_edns</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">ednsflags</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">payload</span><span class="s4">,</span>
                <span class="s1">options</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">ednsoptions</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">flags </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">request</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">flags</span>

            <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">_enrich_nameservers</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">_nameservers</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">nameserver_ports</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">port</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">rotate</span><span class="s4">:</span>
                <span class="s1">random</span><span class="s4">.</span><span class="s1">shuffle</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">current_nameservers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">[:]</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">errors </span><span class="s4">= []</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">retry_with_tcp </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">request </span><span class="s4">= </span><span class="s1">request</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">backoff </span><span class="s4">= </span><span class="s6">0.10</span>

            <span class="s3">return </span><span class="s4">(</span><span class="s1">request</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

        <span class="s0">#</span>
        <span class="s0"># We've tried everything and only gotten NXDOMAINs.  (We know</span>
        <span class="s0"># it's only NXDOMAINs as anything else would have returned</span>
        <span class="s0"># before now.)</span>
        <span class="s0">#</span>
        <span class="s3">raise </span><span class="s1">NXDOMAIN</span><span class="s4">(</span><span class="s1">qnames</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qnames_to_try</span><span class="s4">, </span><span class="s1">responses</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nxdomain_responses</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">next_nameserver</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">retry_with_tcp</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver </span><span class="s3">is not None</span>
            <span class="s3">assert not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">is_always_max_size</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">retry_with_tcp </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>

        <span class="s1">backoff </span><span class="s4">= </span><span class="s6">0.0</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">current_nameservers</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s0"># Out of things to try!</span>
                <span class="s3">raise </span><span class="s1">NoNameservers</span><span class="s4">(</span><span class="s1">request</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">request</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">current_nameservers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">[:]</span>
            <span class="s1">backoff </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">backoff</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">backoff </span><span class="s4">= </span><span class="s1">min</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">backoff </span><span class="s4">* </span><span class="s6">2</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">current_nameservers</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tcp </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">is_always_max_size</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">, </span><span class="s1">backoff</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">query_result</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">response</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">], </span><span class="s1">ex</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Exception</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Answer</span><span class="s4">], </span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s0">#</span>
        <span class="s0"># returns an (answer: Answer, end_loop: bool) tuple.</span>
        <span class="s0">#</span>
        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver </span><span class="s3">is not None</span>
        <span class="s3">if </span><span class="s1">ex</span><span class="s4">:</span>
            <span class="s0"># Exception during I/O or from_wire()</span>
            <span class="s3">assert </span><span class="s1">response </span><span class="s3">is None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                <span class="s4">(</span>
                    <span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">),</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                    <span class="s1">ex</span><span class="s4">,</span>
                    <span class="s1">response</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ex</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">)</span>
                <span class="s3">or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ex</span><span class="s4">, </span><span class="s1">EOFError</span><span class="s4">)</span>
                <span class="s3">or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ex</span><span class="s4">, </span><span class="s1">OSError</span><span class="s4">)</span>
                <span class="s3">or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ex</span><span class="s4">, </span><span class="s1">NotImplementedError</span><span class="s4">)</span>
            <span class="s4">):</span>
                <span class="s0"># This nameserver is no good, take it out of the mix.</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">ex</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Truncated</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">:</span>
                    <span class="s0"># Truncation with TCP is no good!</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">retry_with_tcp </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s0"># We got an answer!</span>
        <span class="s3">assert </span><span class="s1">response </span><span class="s3">is not None</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">QueryMessage</span><span class="s4">)</span>
        <span class="s1">rcode </span><span class="s4">= </span><span class="s1">response</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">rcode </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">NOERROR</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">answer </span><span class="s4">= </span><span class="s1">Answer</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">,</span>
                    <span class="s1">response</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_nameserver</span><span class="s4">(),</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                <span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                    <span class="s4">(</span>
                        <span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">),</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">,</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                        <span class="s1">e</span><span class="s4">,</span>
                        <span class="s1">response</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s0"># The nameserver is no good, take it out of the mix.</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">)</span>
                <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">.</span><span class="s1">put</span><span class="s4">((</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">), </span><span class="s1">answer</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">is None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">raise_on_no_answer</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">NoAnswer</span><span class="s4">(</span><span class="s1">response</span><span class="s4">=</span><span class="s1">answer</span><span class="s4">.</span><span class="s1">response</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">answer</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">rcode </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">:</span>
            <span class="s0"># Further validate the response by making an Answer, even</span>
            <span class="s0"># if we aren't going to cache it.</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">answer </span><span class="s4">= </span><span class="s1">Answer</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">, </span><span class="s1">response</span>
                <span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                    <span class="s4">(</span>
                        <span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">),</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">,</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                        <span class="s1">e</span><span class="s4">,</span>
                        <span class="s1">response</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s0"># The nameserver is no good, take it out of the mix.</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">)</span>
                <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">nxdomain_responses</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">] = </span><span class="s1">response</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">cache</span><span class="s4">.</span><span class="s1">put</span><span class="s4">(</span>
                    <span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">), </span><span class="s1">answer</span>
                <span class="s4">)</span>
            <span class="s0"># Make next_nameserver() return None, so caller breaks its</span>
            <span class="s0"># inner loop and calls next_request().</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">rcode </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">YXDOMAIN</span><span class="s4">:</span>
            <span class="s1">yex </span><span class="s4">= </span><span class="s1">YXDOMAIN</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                <span class="s4">(</span>
                    <span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">),</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                    <span class="s1">yex</span><span class="s4">,</span>
                    <span class="s1">response</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">raise </span><span class="s1">yex</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0">#</span>
            <span class="s0"># We got a response, but we're not happy with the</span>
            <span class="s0"># rcode in it.</span>
            <span class="s0">#</span>
            <span class="s3">if </span><span class="s1">rcode </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">SERVFAIL </span><span class="s3">or not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">retry_servfail</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">remove</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                <span class="s4">(</span>
                    <span class="s1">str</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">),</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">tcp_attempt</span><span class="s4">,</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">answer_port</span><span class="s4">(),</span>
                    <span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">rcode</span><span class="s4">),</span>
                    <span class="s1">response</span><span class="s4">,</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">BaseResolver</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;DNS stub resolver.&quot;&quot;&quot;</span>

    <span class="s0"># We initialize in reset()</span>
    <span class="s0">#</span>
    <span class="s0"># pylint: disable=attribute-defined-outside-init</span>

    <span class="s1">domain</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span>
    <span class="s1">nameserver_ports</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int</span>
    <span class="s1">search</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">]</span>
    <span class="s1">use_search_by_default</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">float</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">float</span>
    <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">]</span>
    <span class="s1">keyname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]]</span>
    <span class="s1">keyalgorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]</span>
    <span class="s1">edns</span><span class="s4">: </span><span class="s1">int</span>
    <span class="s1">ednsflags</span><span class="s4">: </span><span class="s1">int</span>
    <span class="s1">ednsoptions</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">Option</span><span class="s4">]]</span>
    <span class="s1">payload</span><span class="s4">: </span><span class="s1">int</span>
    <span class="s1">cache</span><span class="s4">: </span><span class="s1">Any</span>
    <span class="s1">flags</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]</span>
    <span class="s1">retry_servfail</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s1">rotate</span><span class="s4">: </span><span class="s1">bool</span>
    <span class="s1">ndots</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]</span>
    <span class="s1">_nameservers</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">filename</span><span class="s4">: </span><span class="s1">str </span><span class="s4">= </span><span class="s5">&quot;/etc/resolv.conf&quot;</span><span class="s4">, </span><span class="s1">configure</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;*filename*, a ``str`` or file object, specifying a file 
        in standard /etc/resolv.conf format.  This parameter is meaningful 
        only when *configure* is true and the platform is POSIX. 
 
        *configure*, a ``bool``.  If True (the default), the resolver 
        instance is configured in the normal fashion for the operating 
        system the resolver is running on.  (I.e. by reading a 
        /etc/resolv.conf file on POSIX systems and from the registry 
        on Windows systems.) 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">reset</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">configure</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform </span><span class="s4">== </span><span class="s5">&quot;win32&quot;</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">read_registry</span><span class="s4">()</span>
            <span class="s3">elif </span><span class="s1">filename</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">read_resolv_conf</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">reset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Reset all resolver configuration to the defaults.&quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostname</span><span class="s4">())[</span><span class="s6">1</span><span class="s4">:])</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">domain</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_nameservers </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver_ports </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">port </span><span class="s4">= </span><span class="s6">53</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">search </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">use_search_by_default </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">timeout </span><span class="s4">= </span><span class="s6">2.0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">lifetime </span><span class="s4">= </span><span class="s6">5.0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyname </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyalgorithm </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">default_algorithm</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsoptions </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">payload </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">cache </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">retry_servfail </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rotate </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ndots </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">def </span><span class="s1">read_resolv_conf</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">f</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Process *f* as a file in the /etc/resolv.conf format.  If f is 
        a ``str``, it is used as the name of the file to open; otherwise it 
        is treated as the file itself. 
 
        Interprets the following items: 
 
        - nameserver - name server IP address 
 
        - domain - local domain name 
 
        - search - search list for host-name lookup 
 
        - options - supported options are rotate, timeout, edns0, and ndots 
 
        &quot;&quot;&quot;</span>

        <span class="s1">nameservers </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">open</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">OSError</span><span class="s4">:</span>
                <span class="s0"># /etc/resolv.conf doesn't exist, can't be read, etc.</span>
                <span class="s3">raise </span><span class="s1">NoResolverConfiguration</span><span class="s4">(</span><span class="s5">f&quot;cannot open </span><span class="s3">{</span><span class="s1">f</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">cm </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">l </span><span class="s3">in </span><span class="s1">f</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">l</span><span class="s4">) == </span><span class="s6">0 </span><span class="s3">or </span><span class="s1">l</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;#&quot; </span><span class="s3">or </span><span class="s1">l</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;;&quot;</span><span class="s4">:</span>
                    <span class="s3">continue</span>
                <span class="s1">tokens </span><span class="s4">= </span><span class="s1">l</span><span class="s4">.</span><span class="s1">split</span><span class="s4">()</span>

                <span class="s0"># Any line containing less than 2 tokens is malformed</span>
                <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">tokens</span><span class="s4">) &lt; </span><span class="s6">2</span><span class="s4">:</span>
                    <span class="s3">continue</span>

                <span class="s3">if </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;nameserver&quot;</span><span class="s4">:</span>
                    <span class="s1">nameservers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">1</span><span class="s4">])</span>
                <span class="s3">elif </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;domain&quot;</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">1</span><span class="s4">])</span>
                    <span class="s0"># domain and search are exclusive</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">search </span><span class="s4">= []</span>
                <span class="s3">elif </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;search&quot;</span><span class="s4">:</span>
                    <span class="s0"># the last search wins</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">search </span><span class="s4">= []</span>
                    <span class="s3">for </span><span class="s1">suffix </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">search</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">suffix</span><span class="s4">))</span>
                    <span class="s0"># We don't set domain as it is not used if</span>
                    <span class="s0"># len(self.search) &gt; 0</span>
                <span class="s3">elif </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;options&quot;</span><span class="s4">:</span>
                    <span class="s3">for </span><span class="s1">opt </span><span class="s3">in </span><span class="s1">tokens</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:]:</span>
                        <span class="s3">if </span><span class="s1">opt </span><span class="s4">== </span><span class="s5">&quot;rotate&quot;</span><span class="s4">:</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">rotate </span><span class="s4">= </span><span class="s3">True</span>
                        <span class="s3">elif </span><span class="s1">opt </span><span class="s4">== </span><span class="s5">&quot;edns0&quot;</span><span class="s4">:</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">use_edns</span><span class="s4">()</span>
                        <span class="s3">elif </span><span class="s5">&quot;timeout&quot; </span><span class="s3">in </span><span class="s1">opt</span><span class="s4">:</span>
                            <span class="s3">try</span><span class="s4">:</span>
                                <span class="s1">self</span><span class="s4">.</span><span class="s1">timeout </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;:&quot;</span><span class="s4">)[</span><span class="s6">1</span><span class="s4">])</span>
                            <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">IndexError</span><span class="s4">):</span>
                                <span class="s3">pass</span>
                        <span class="s3">elif </span><span class="s5">&quot;ndots&quot; </span><span class="s3">in </span><span class="s1">opt</span><span class="s4">:</span>
                            <span class="s3">try</span><span class="s4">:</span>
                                <span class="s1">self</span><span class="s4">.</span><span class="s1">ndots </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;:&quot;</span><span class="s4">)[</span><span class="s6">1</span><span class="s4">])</span>
                            <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">IndexError</span><span class="s4">):</span>
                                <span class="s3">pass</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">nameservers</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NoResolverConfiguration</span><span class="s4">(</span><span class="s5">&quot;no nameservers&quot;</span><span class="s4">)</span>
        <span class="s0"># Assigning directly instead of appending means we invoke the</span>
        <span class="s0"># setter logic, with additonal checking and enrichment.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers </span><span class="s4">= </span><span class="s1">nameservers</span>

    <span class="s3">def </span><span class="s1">read_registry</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s2">&quot;&quot;&quot;Extract resolver configuration from the Windows registry.&quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">info </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">win32util</span><span class="s4">.</span><span class="s1">get_dns_info</span><span class="s4">()  </span><span class="s0"># type: ignore</span>
            <span class="s3">if </span><span class="s1">info</span><span class="s4">.</span><span class="s1">domain </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">domain</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">nameservers</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">search </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">search</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span>

    <span class="s3">def </span><span class="s1">_compute_timeout</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">start</span><span class="s4">: </span><span class="s1">float</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">errors</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">ErrorTuple</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; float</span><span class="s4">:</span>
        <span class="s1">lifetime </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lifetime </span><span class="s3">if </span><span class="s1">lifetime </span><span class="s3">is None else </span><span class="s1">lifetime</span>
        <span class="s1">now </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s1">duration </span><span class="s4">= </span><span class="s1">now </span><span class="s4">- </span><span class="s1">start</span>
        <span class="s3">if </span><span class="s1">errors </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">errors </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">duration </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">duration </span><span class="s4">&lt; -</span><span class="s6">1</span><span class="s4">:</span>
                <span class="s0"># Time going backwards is bad.  Just give up.</span>
                <span class="s3">raise </span><span class="s1">LifetimeTimeout</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">=</span><span class="s1">duration</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s1">errors</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># Time went backwards, but only a little.  This can</span>
                <span class="s0"># happen, e.g. under vmware with older linux kernels.</span>
                <span class="s0"># Pretend it didn't happen.</span>
                <span class="s1">duration </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">if </span><span class="s1">duration </span><span class="s4">&gt;= </span><span class="s1">lifetime</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">LifetimeTimeout</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">=</span><span class="s1">duration</span><span class="s4">, </span><span class="s1">errors</span><span class="s4">=</span><span class="s1">errors</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">min</span><span class="s4">(</span><span class="s1">lifetime </span><span class="s4">- </span><span class="s1">duration</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">timeout</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_qnames_to_try</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">search</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">]:</span>
        <span class="s0"># This is a separate method so we can unit test the search</span>
        <span class="s0"># rules without requiring the Internet.</span>
        <span class="s3">if </span><span class="s1">search </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">search </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">use_search_by_default</span>
        <span class="s1">qnames_to_try </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">qname</span><span class="s4">.</span><span class="s1">is_absolute</span><span class="s4">():</span>
            <span class="s1">qnames_to_try</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">abs_qname </span><span class="s4">= </span><span class="s1">qname</span><span class="s4">.</span><span class="s1">concatenate</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">search</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">search</span><span class="s4">) &gt; </span><span class="s6">0</span><span class="s4">:</span>
                    <span class="s0"># There is a search list, so use it exclusively</span>
                    <span class="s1">search_list </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">search</span><span class="s4">[:]</span>
                <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">domain </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s0"># We have some notion of a domain that isn't the root, so</span>
                    <span class="s0"># use it as the search list.</span>
                    <span class="s1">search_list </span><span class="s4">= [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">domain</span><span class="s4">]</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">search_list </span><span class="s4">= []</span>
                <span class="s0"># Figure out the effective ndots (default is 1)</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ndots </span><span class="s3">is None</span><span class="s4">:</span>
                    <span class="s1">ndots </span><span class="s4">= </span><span class="s6">1</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">ndots </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ndots</span>
                <span class="s3">for </span><span class="s1">suffix </span><span class="s3">in </span><span class="s1">search_list</span><span class="s4">:</span>
                    <span class="s1">qnames_to_try</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">qname </span><span class="s4">+ </span><span class="s1">suffix</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">) &gt; </span><span class="s1">ndots</span><span class="s4">:</span>
                    <span class="s0"># The name has at least ndots dots, so we should try an</span>
                    <span class="s0"># absolute query first.</span>
                    <span class="s1">qnames_to_try</span><span class="s4">.</span><span class="s1">insert</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">abs_qname</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s0"># The name has less than ndots dots, so we should search</span>
                    <span class="s0"># first, then try the absolute name.</span>
                    <span class="s1">qnames_to_try</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">abs_qname</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">qnames_to_try</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">abs_qname</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">qnames_to_try</span>

    <span class="s3">def </span><span class="s1">use_tsig</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
        <span class="s1">keyname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">default_algorithm</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Add a TSIG signature to each query. 
 
        The parameters are passed to ``dns.message.Message.use_tsig()``; 
        see its documentation for details. 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s4">= </span><span class="s1">keyring</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyname </span><span class="s4">= </span><span class="s1">keyname</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyalgorithm </span><span class="s4">= </span><span class="s1">algorithm</span>

    <span class="s3">def </span><span class="s1">use_edns</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">edns</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]] = </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">ednsflags</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">payload</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">DEFAULT_EDNS_PAYLOAD</span><span class="s4">,</span>
        <span class="s1">options</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">Option</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Configure EDNS behavior. 
 
        *edns*, an ``int``, is the EDNS level to use.  Specifying 
        ``None``, ``False``, or ``-1`` means &quot;do not use EDNS&quot;, and in this case 
        the other parameters are ignored.  Specifying ``True`` is 
        equivalent to specifying 0, i.e. &quot;use EDNS0&quot;. 
 
        *ednsflags*, an ``int``, the EDNS flag values. 
 
        *payload*, an ``int``, is the EDNS sender's payload field, which is the 
        maximum size of UDP datagram the sender can handle.  I.e. how big 
        a response to this message can be. 
 
        *options*, a list of ``dns.edns.Option`` objects or ``None``, the EDNS 
        options. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">edns </span><span class="s3">is None or </span><span class="s1">edns </span><span class="s3">is False</span><span class="s4">:</span>
            <span class="s1">edns </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s3">elif </span><span class="s1">edns </span><span class="s3">is True</span><span class="s4">:</span>
            <span class="s1">edns </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= </span><span class="s1">edns</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">= </span><span class="s1">ednsflags</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">payload </span><span class="s4">= </span><span class="s1">payload</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsoptions </span><span class="s4">= </span><span class="s1">options</span>

    <span class="s3">def </span><span class="s1">set_flags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Overrides the default flags with your own. 
 
        *flags*, an ``int``, the message flags to use. 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">flags</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">_enrich_nameservers</span><span class="s4">(</span>
        <span class="s1">cls</span><span class="s4">,</span>
        <span class="s1">nameservers</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]],</span>
        <span class="s1">nameserver_ports</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">],</span>
        <span class="s1">default_port</span><span class="s4">: </span><span class="s1">int</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]:</span>
        <span class="s1">enriched_nameservers </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">nameservers</span><span class="s4">, </span><span class="s1">list</span><span class="s4">):</span>
            <span class="s3">for </span><span class="s1">nameserver </span><span class="s3">in </span><span class="s1">nameservers</span><span class="s4">:</span>
                <span class="s1">enriched_nameserver</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span>
                <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">nameserver</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">):</span>
                    <span class="s1">enriched_nameserver </span><span class="s4">= </span><span class="s1">nameserver</span>
                <span class="s3">elif </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_address</span><span class="s4">(</span><span class="s1">nameserver</span><span class="s4">):</span>
                    <span class="s1">port </span><span class="s4">= </span><span class="s1">nameserver_ports</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">nameserver</span><span class="s4">, </span><span class="s1">default_port</span><span class="s4">)</span>
                    <span class="s1">enriched_nameserver </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Do53Nameserver</span><span class="s4">(</span>
                        <span class="s1">nameserver</span><span class="s4">, </span><span class="s1">port</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">urlparse</span><span class="s4">(</span><span class="s1">nameserver</span><span class="s4">).</span><span class="s1">scheme </span><span class="s4">!= </span><span class="s5">&quot;https&quot;</span><span class="s4">:</span>
                            <span class="s3">raise </span><span class="s1">NotImplementedError</span>
                    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                            <span class="s5">f&quot;nameserver </span><span class="s3">{</span><span class="s1">nameserver</span><span class="s3">} </span><span class="s5">is not a &quot;</span>
                            <span class="s5">&quot;dns.nameserver.Nameserver instance or text form, &quot;</span>
                            <span class="s5">&quot;IP address, nor a valid https URL&quot;</span>
                        <span class="s4">)</span>
                    <span class="s1">enriched_nameserver </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">DoHNameserver</span><span class="s4">(</span><span class="s1">nameserver</span><span class="s4">)</span>
                <span class="s1">enriched_nameservers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">enriched_nameserver</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s5">f&quot;nameservers must be a list or tuple (not a </span><span class="s3">{</span><span class="s1">type</span><span class="s4">(</span><span class="s1">nameservers</span><span class="s4">)</span><span class="s3">}</span><span class="s5">)&quot;</span>
            <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">enriched_nameservers</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">nameservers</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]]:</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_nameservers</span>

    <span class="s4">@</span><span class="s1">nameservers</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">nameservers</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">nameservers</span><span class="s4">: </span><span class="s1">Sequence</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]]</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        *nameservers*, a ``list`` of nameservers, where a nameserver is either 
        a string interpretable as a nameserver, or a ``dns.nameserver.Nameserver`` 
        instance. 
 
        Raises ``ValueError`` if *nameservers* is not a list of nameservers. 
        &quot;&quot;&quot;</span>
        <span class="s0"># We just call _enrich_nameservers() for checking</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_enrich_nameservers</span><span class="s4">(</span><span class="s1">nameservers</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nameserver_ports</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">port</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_nameservers </span><span class="s4">= </span><span class="s1">nameservers</span>


<span class="s3">class </span><span class="s1">Resolver</span><span class="s4">(</span><span class="s1">BaseResolver</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;DNS stub resolver.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">resolve</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
        <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">search</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:  </span><span class="s0"># pylint: disable=arguments-differ</span>
        <span class="s2">&quot;&quot;&quot;Query nameservers to find the answer to the question. 
 
        The *qname*, *rdtype*, and *rdclass* parameters may be objects 
        of the appropriate type, or strings that can be converted into objects 
        of the appropriate type. 
 
        *qname*, a ``dns.name.Name`` or ``str``, the query name. 
 
        *rdtype*, an ``int`` or ``str``,  the query type. 
 
        *rdclass*, an ``int`` or ``str``,  the query class. 
 
        *tcp*, a ``bool``.  If ``True``, use TCP to make the query. 
 
        *source*, a ``str`` or ``None``.  If not ``None``, bind to this IP 
        address when making queries. 
 
        *raise_on_no_answer*, a ``bool``.  If ``True``, raise 
        ``dns.resolver.NoAnswer`` if there's no answer to the question. 
 
        *source_port*, an ``int``, the port from which to send the message. 
 
        *lifetime*, a ``float``, how many seconds a query should run 
        before timing out. 
 
        *search*, a ``bool`` or ``None``, determines whether the 
        search list configured in the system's resolver configuration 
        are used for relative names, and whether the resolver's domain 
        may be added to relative names.  The default is ``None``, 
        which causes the value of the resolver's 
        ``use_search_by_default`` attribute to be used. 
 
        Raises ``dns.resolver.LifetimeTimeout`` if no answers could be found 
        in the specified lifetime. 
 
        Raises ``dns.resolver.NXDOMAIN`` if the query name does not exist. 
 
        Raises ``dns.resolver.YXDOMAIN`` if the query name is too long after 
        DNAME substitution. 
 
        Raises ``dns.resolver.NoAnswer`` if *raise_on_no_answer* is 
        ``True`` and the query name exists but has no RRset of the 
        desired type and class. 
 
        Raises ``dns.resolver.NoNameservers`` if no non-broken 
        nameservers are available to answer the question. 
 
        Returns a ``dns.resolver.Answer`` instance. 
 
        &quot;&quot;&quot;</span>

        <span class="s1">resolution </span><span class="s4">= </span><span class="s1">_Resolution</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">tcp</span><span class="s4">, </span><span class="s1">raise_on_no_answer</span><span class="s4">, </span><span class="s1">search</span>
        <span class="s4">)</span>
        <span class="s1">start </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s3">while True</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">request</span><span class="s4">, </span><span class="s1">answer</span><span class="s4">) = </span><span class="s1">resolution</span><span class="s4">.</span><span class="s1">next_request</span><span class="s4">()</span>
            <span class="s0"># Note we need to say &quot;if answer is not None&quot; and not just</span>
            <span class="s0"># &quot;if answer&quot; because answer implements __len__, and python</span>
            <span class="s0"># will call that.  We want to return if we have an answer</span>
            <span class="s0"># object, including in cases where its length is 0.</span>
            <span class="s3">if </span><span class="s1">answer </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s0"># cache hit!</span>
                <span class="s3">return </span><span class="s1">answer</span>
            <span class="s3">assert </span><span class="s1">request </span><span class="s3">is not None  </span><span class="s0"># needed for type checking</span>
            <span class="s1">done </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s3">while not </span><span class="s1">done</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">nameserver</span><span class="s4">, </span><span class="s1">tcp</span><span class="s4">, </span><span class="s1">backoff</span><span class="s4">) = </span><span class="s1">resolution</span><span class="s4">.</span><span class="s1">next_nameserver</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">backoff</span><span class="s4">:</span>
                    <span class="s1">time</span><span class="s4">.</span><span class="s1">sleep</span><span class="s4">(</span><span class="s1">backoff</span><span class="s4">)</span>
                <span class="s1">timeout </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compute_timeout</span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">, </span><span class="s1">resolution</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">)</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">response </span><span class="s4">= </span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">query</span><span class="s4">(</span>
                        <span class="s1">request</span><span class="s4">,</span>
                        <span class="s1">timeout</span><span class="s4">=</span><span class="s1">timeout</span><span class="s4">,</span>
                        <span class="s1">source</span><span class="s4">=</span><span class="s1">source</span><span class="s4">,</span>
                        <span class="s1">source_port</span><span class="s4">=</span><span class="s1">source_port</span><span class="s4">,</span>
                        <span class="s1">max_size</span><span class="s4">=</span><span class="s1">tcp</span><span class="s4">,</span>
                    <span class="s4">)</span>
                <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">ex</span><span class="s4">:</span>
                    <span class="s4">(</span><span class="s1">_</span><span class="s4">, </span><span class="s1">done</span><span class="s4">) = </span><span class="s1">resolution</span><span class="s4">.</span><span class="s1">query_result</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s1">ex</span><span class="s4">)</span>
                    <span class="s3">continue</span>
                <span class="s4">(</span><span class="s1">answer</span><span class="s4">, </span><span class="s1">done</span><span class="s4">) = </span><span class="s1">resolution</span><span class="s4">.</span><span class="s1">query_result</span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
                <span class="s0"># Note we need to say &quot;if answer is not None&quot; and not just</span>
                <span class="s0"># &quot;if answer&quot; because answer implements __len__, and python</span>
                <span class="s0"># will call that.  We want to return if we have an answer</span>
                <span class="s0"># object, including in cases where its length is 0.</span>
                <span class="s3">if </span><span class="s1">answer </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">answer</span>

    <span class="s3">def </span><span class="s1">query</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
        <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s2">&quot;&quot;&quot;Query nameservers to find the answer to the question. 
 
        This method calls resolve() with ``search=True``, and is 
        provided for backwards compatibility with prior versions of 
        dnspython.  See the documentation for the resolve() method for 
        further details. 
        &quot;&quot;&quot;</span>
        <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
            <span class="s5">&quot;please use dns.resolver.Resolver.resolve() instead&quot;</span><span class="s4">,</span>
            <span class="s1">DeprecationWarning</span><span class="s4">,</span>
            <span class="s1">stacklevel</span><span class="s4">=</span><span class="s6">2</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
            <span class="s1">qname</span><span class="s4">,</span>
            <span class="s1">rdtype</span><span class="s4">,</span>
            <span class="s1">rdclass</span><span class="s4">,</span>
            <span class="s1">tcp</span><span class="s4">,</span>
            <span class="s1">source</span><span class="s4">,</span>
            <span class="s1">raise_on_no_answer</span><span class="s4">,</span>
            <span class="s1">source_port</span><span class="s4">,</span>
            <span class="s1">lifetime</span><span class="s4">,</span>
            <span class="s3">True</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">resolve_address</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">ipaddr</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Use a resolver to run a reverse query for PTR records. 
 
        This utilizes the resolve() method to perform a PTR lookup on the 
        specified IP address. 
 
        *ipaddr*, a ``str``, the IPv4 or IPv6 address you want to get 
        the PTR record for. 
 
        All other arguments that can be passed to the resolve() function 
        except for rdtype and rdclass are also supported by this 
        function. 
        &quot;&quot;&quot;</span>
        <span class="s0"># We make a modified kwargs for type checking happiness, as otherwise</span>
        <span class="s0"># we get a legit warning about possibly having rdtype and rdclass</span>
        <span class="s0"># in the kwargs more than once.</span>
        <span class="s1">modified_kwargs</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {}</span>
        <span class="s1">modified_kwargs</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s1">modified_kwargs</span><span class="s4">[</span><span class="s5">&quot;rdtype&quot;</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">PTR</span>
        <span class="s1">modified_kwargs</span><span class="s4">[</span><span class="s5">&quot;rdclass&quot;</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">reversename</span><span class="s4">.</span><span class="s1">from_address</span><span class="s4">(</span><span class="s1">ipaddr</span><span class="s4">), *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">modified_kwargs</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">resolve_name</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
        <span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">,</span>
        <span class="s4">**</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; HostAnswers</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Use a resolver to query for address records. 
 
        This utilizes the resolve() method to perform A and/or AAAA lookups on 
        the specified name. 
 
        *qname*, a ``dns.name.Name`` or ``str``, the name to resolve. 
 
        *family*, an ``int``, the address family.  If socket.AF_UNSPEC 
        (the default), both A and AAAA records will be retrieved. 
 
        All other arguments that can be passed to the resolve() function 
        except for rdtype and rdclass are also supported by this 
        function. 
        &quot;&quot;&quot;</span>
        <span class="s0"># We make a modified kwargs for type checking happiness, as otherwise</span>
        <span class="s0"># we get a legit warning about possibly having rdtype and rdclass</span>
        <span class="s0"># in the kwargs more than once.</span>
        <span class="s1">modified_kwargs</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {}</span>
        <span class="s1">modified_kwargs</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s1">modified_kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">&quot;rdtype&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">modified_kwargs</span><span class="s4">[</span><span class="s5">&quot;rdclass&quot;</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span>

        <span class="s3">if </span><span class="s1">family </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span><span class="s4">:</span>
            <span class="s1">v4 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">, **</span><span class="s1">modified_kwargs</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">HostAnswers</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">v4</span><span class="s4">=</span><span class="s1">v4</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">family </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span><span class="s4">:</span>
            <span class="s1">v6 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AAAA</span><span class="s4">, **</span><span class="s1">modified_kwargs</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">HostAnswers</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">v6</span><span class="s4">=</span><span class="s1">v6</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">family </span><span class="s4">!= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s5">f&quot;unknown address family </span><span class="s3">{</span><span class="s1">family</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>

        <span class="s1">raise_on_no_answer </span><span class="s4">= </span><span class="s1">modified_kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">&quot;raise_on_no_answer&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
        <span class="s1">lifetime </span><span class="s4">= </span><span class="s1">modified_kwargs</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s5">&quot;lifetime&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">start </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s1">v6 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
            <span class="s1">name</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AAAA</span><span class="s4">,</span>
            <span class="s1">raise_on_no_answer</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
            <span class="s1">lifetime</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compute_timeout</span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">),</span>
            <span class="s4">**</span><span class="s1">modified_kwargs</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s0"># Note that setting name ensures we query the same name</span>
        <span class="s0"># for A as we did for AAAA.  (This is just in case search lists</span>
        <span class="s0"># are active by default in the resolver configuration and</span>
        <span class="s0"># we might be talking to a server that says NXDOMAIN when it</span>
        <span class="s0"># wants to say NOERROR no data.</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">v6</span><span class="s4">.</span><span class="s1">qname</span>
        <span class="s1">v4 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
            <span class="s1">name</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
            <span class="s1">raise_on_no_answer</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
            <span class="s1">lifetime</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compute_timeout</span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">),</span>
            <span class="s4">**</span><span class="s1">modified_kwargs</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">answers </span><span class="s4">= </span><span class="s1">HostAnswers</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">v6</span><span class="s4">=</span><span class="s1">v6</span><span class="s4">, </span><span class="s1">v4</span><span class="s4">=</span><span class="s1">v4</span><span class="s4">, </span><span class="s1">add_empty</span><span class="s4">=</span><span class="s3">not </span><span class="s1">raise_on_no_answer</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">answers</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NoAnswer</span><span class="s4">(</span><span class="s1">response</span><span class="s4">=</span><span class="s1">v6</span><span class="s4">.</span><span class="s1">response</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">answers</span>

    <span class="s0"># pylint: disable=redefined-outer-name</span>

    <span class="s3">def </span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Determine the canonical name of *name*. 
 
        The canonical name is the name the resolver uses for queries 
        after all CNAME and DNAME renamings have been applied. 
 
        *name*, a ``dns.name.Name`` or ``str``, the query name. 
 
        This method can raise any exception that ``resolve()`` can 
        raise, other than ``dns.resolver.NoAnswer`` and 
        ``dns.resolver.NXDOMAIN``. 
 
        Returns a ``dns.name.Name``. 
        &quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">raise_on_no_answer</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
            <span class="s1">canonical_name </span><span class="s4">= </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">canonical_name</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NXDOMAIN </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s1">canonical_name </span><span class="s4">= </span><span class="s1">e</span><span class="s4">.</span><span class="s1">canonical_name</span>
        <span class="s3">return </span><span class="s1">canonical_name</span>

    <span class="s0"># pylint: enable=redefined-outer-name</span>

    <span class="s3">def </span><span class="s1">try_ddr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">: </span><span class="s1">float </span><span class="s4">= </span><span class="s6">5.0</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Try to update the resolver's nameservers using Discovery of Designated 
        Resolvers (DDR).  If successful, the resolver will subsequently use 
        DNS-over-HTTPS or DNS-over-TLS for future queries. 
 
        *lifetime*, a float, is the maximum time to spend attempting DDR.  The default 
        is 5 seconds. 
 
        If the SVCB query is successful and results in a non-empty list of nameservers, 
        then the resolver's nameservers are set to the returned servers in priority 
        order. 
 
        The current implementation does not use any address hints from the SVCB record, 
        nor does it resolve addresses for the SCVB target name, rather it assumes that 
        the bootstrap nameserver will always be one of the addresses and uses it. 
        A future revision to the code may offer fuller support.  The code verifies that 
        the bootstrap nameserver is in the Subject Alternative Name field of the 
        TLS certficate. 
        &quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">expiration </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() + </span><span class="s1">lifetime</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
                <span class="s1">dns</span><span class="s4">.</span><span class="s1">_ddr</span><span class="s4">.</span><span class="s1">_local_resolver_name</span><span class="s4">, </span><span class="s5">&quot;SVCB&quot;</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">=</span><span class="s1">lifetime</span>
            <span class="s4">)</span>
            <span class="s1">timeout </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">query</span><span class="s4">.</span><span class="s1">_remaining</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">)</span>
            <span class="s1">nameservers </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_ddr</span><span class="s4">.</span><span class="s1">_get_nameservers_sync</span><span class="s4">(</span><span class="s1">answer</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">nameservers</span><span class="s4">) &gt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">nameservers </span><span class="s4">= </span><span class="s1">nameservers</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s3">pass</span>


<span class="s0">#: The default resolver.</span>
<span class="s1">default_resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Resolver</span><span class="s4">] = </span><span class="s3">None</span>


<span class="s3">def </span><span class="s1">get_default_resolver</span><span class="s4">() </span><span class="s1">-&gt; Resolver</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Get the default resolver, initializing it if necessary.&quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">default_resolver </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">reset_default_resolver</span><span class="s4">()</span>
    <span class="s3">assert </span><span class="s1">default_resolver </span><span class="s3">is not None</span>
    <span class="s3">return </span><span class="s1">default_resolver</span>


<span class="s3">def </span><span class="s1">reset_default_resolver</span><span class="s4">() </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Re-initialize default resolver. 
 
    Note that the resolver configuration (i.e. /etc/resolv.conf on UNIX 
    systems) will be re-read immediately. 
    &quot;&quot;&quot;</span>

    <span class="s3">global </span><span class="s1">default_resolver</span>
    <span class="s1">default_resolver </span><span class="s4">= </span><span class="s1">Resolver</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">resolve</span><span class="s4">(</span>
    <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">search</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
    <span class="s2">&quot;&quot;&quot;Query nameservers to find the answer to the question. 
 
    This is a convenience function that uses the default resolver 
    object to make the query. 
 
    See ``dns.resolver.Resolver.resolve`` for more information on the 
    parameters. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">get_default_resolver</span><span class="s4">().</span><span class="s1">resolve</span><span class="s4">(</span>
        <span class="s1">qname</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">tcp</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">,</span>
        <span class="s1">source_port</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">,</span>
        <span class="s1">search</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">query</span><span class="s4">(</span>
    <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
    <span class="s2">&quot;&quot;&quot;Query nameservers to find the answer to the question. 
 
    This method calls resolve() with ``search=True``, and is 
    provided for backwards compatibility with prior versions of 
    dnspython.  See the documentation for the resolve() method for 
    further details. 
    &quot;&quot;&quot;</span>
    <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
        <span class="s5">&quot;please use dns.resolver.resolve() instead&quot;</span><span class="s4">, </span><span class="s1">DeprecationWarning</span><span class="s4">, </span><span class="s1">stacklevel</span><span class="s4">=</span><span class="s6">2</span>
    <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">resolve</span><span class="s4">(</span>
        <span class="s1">qname</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">tcp</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">,</span>
        <span class="s1">source_port</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">,</span>
        <span class="s3">True</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">resolve_address</span><span class="s4">(</span><span class="s1">ipaddr</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Use a resolver to run a reverse query for PTR records. 
 
    See ``dns.resolver.Resolver.resolve_address`` for more information on the 
    parameters. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">get_default_resolver</span><span class="s4">().</span><span class="s1">resolve_address</span><span class="s4">(</span><span class="s1">ipaddr</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">resolve_name</span><span class="s4">(</span>
    <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">], </span><span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span>
<span class="s4">) </span><span class="s1">-&gt; HostAnswers</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Use a resolver to query for address records. 
 
    See ``dns.resolver.Resolver.resolve_name`` for more information on the 
    parameters. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">get_default_resolver</span><span class="s4">().</span><span class="s1">resolve_name</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Determine the canonical name of *name*. 
 
    See ``dns.resolver.Resolver.canonical_name`` for more information on the 
    parameters and possible exceptions. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">get_default_resolver</span><span class="s4">().</span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">try_ddr</span><span class="s4">(</span><span class="s1">lifetime</span><span class="s4">: </span><span class="s1">float </span><span class="s4">= </span><span class="s6">5.0</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
    <span class="s2">&quot;&quot;&quot;Try to update the default resolver's nameservers using Discovery of Designated 
    Resolvers (DDR).  If successful, the resolver will subsequently use 
    DNS-over-HTTPS or DNS-over-TLS for future queries. 
 
    See :py:func:`dns.resolver.Resolver.try_ddr` for more information. 
    &quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">get_default_resolver</span><span class="s4">().</span><span class="s1">try_ddr</span><span class="s4">(</span><span class="s1">lifetime</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">zone_for_name</span><span class="s4">(</span>
    <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Resolver</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Find the name of the zone which contains the specified name. 
 
    *name*, an absolute ``dns.name.Name`` or ``str``, the query name. 
 
    *rdclass*, an ``int``, the query class. 
 
    *tcp*, a ``bool``.  If ``True``, use TCP to make the query. 
 
    *resolver*, a ``dns.resolver.Resolver`` or ``None``, the resolver to use. 
    If ``None``, the default, then the default resolver is used. 
 
    *lifetime*, a ``float``, the total time to allow for the queries needed 
    to determine the zone.  If ``None``, the default, then only the individual 
    query limits of the resolver apply. 
 
    Raises ``dns.resolver.NoRootSOA`` if there is no SOA RR at the DNS 
    root.  (This is only likely to happen if you're using non-default 
    root servers in your network and they are misconfigured.) 
 
    Raises ``dns.resolver.LifetimeTimeout`` if the answer could not be 
    found in the allotted lifetime. 
 
    Returns a ``dns.name.Name``. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">resolver </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">resolver </span><span class="s4">= </span><span class="s1">get_default_resolver</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">name</span><span class="s4">.</span><span class="s1">is_absolute</span><span class="s4">():</span>
        <span class="s3">raise </span><span class="s1">NotAbsolute</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s1">start </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">lifetime </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">expiration </span><span class="s4">= </span><span class="s1">start </span><span class="s4">+ </span><span class="s1">lifetime</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">expiration </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">while </span><span class="s6">1</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">rlifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">expiration </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">rlifetime </span><span class="s4">= </span><span class="s1">expiration </span><span class="s4">- </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">rlifetime </span><span class="s4">&lt;= </span><span class="s6">0</span><span class="s4">:</span>
                    <span class="s1">rlifetime </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">rlifetime </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span>
                <span class="s1">name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">tcp</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">=</span><span class="s1">rlifetime</span>
            <span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">rrset </span><span class="s3">is not None</span>
            <span class="s3">if </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s1">name</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">name</span>
            <span class="s0"># otherwise we were CNAMEd or DNAMEd and need to look higher</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NoAnswer</span><span class="s4">) </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">e</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">):</span>
                <span class="s1">response </span><span class="s4">= </span><span class="s1">e</span><span class="s4">.</span><span class="s1">responses</span><span class="s4">().</span><span class="s1">get</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">response </span><span class="s4">= </span><span class="s1">e</span><span class="s4">.</span><span class="s1">response</span><span class="s4">()  </span><span class="s0"># pylint: disable=no-value-for-parameter</span>
            <span class="s3">if </span><span class="s1">response</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">rrs </span><span class="s3">in </span><span class="s1">response</span><span class="s4">.</span><span class="s1">authority</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">rrs</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA </span><span class="s3">and </span><span class="s1">rrs</span><span class="s4">.</span><span class="s1">rdclass </span><span class="s4">== </span><span class="s1">rdclass</span><span class="s4">:</span>
                        <span class="s4">(</span><span class="s1">nr</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">rrs</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">fullcompare</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
                        <span class="s3">if </span><span class="s1">nr </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">NAMERELN_SUPERDOMAIN</span><span class="s4">:</span>
                            <span class="s0"># We're doing a proper superdomain check as</span>
                            <span class="s0"># if the name were equal we ought to have gotten</span>
                            <span class="s0"># it in the answer section!  We are ignoring the</span>
                            <span class="s0"># possibility that the authority is insane and</span>
                            <span class="s0"># is including multiple SOA RRs for different</span>
                            <span class="s0"># authorities.</span>
                            <span class="s3">return </span><span class="s1">rrs</span><span class="s4">.</span><span class="s1">name</span>
            <span class="s0"># we couldn't extract anything useful from the response (e.g. it's</span>
            <span class="s0"># a type 3 NXDOMAIN)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">name </span><span class="s4">= </span><span class="s1">name</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">NoParent</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NoRootSOA</span>


<span class="s3">def </span><span class="s1">make_resolver_at</span><span class="s4">(</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">53</span><span class="s4">,</span>
    <span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">,</span>
    <span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Resolver</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Resolver</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Make a stub resolver using the specified destination as the full resolver. 
 
    *where*, a ``dns.name.Name`` or ``str`` the domain name or IP address of the 
    full resolver. 
 
    *port*, an ``int``, the port to use.  If not specified, the default is 53. 
 
    *family*, an ``int``, the address family to use.  This parameter is used if 
    *where* is not an address.  The default is ``socket.AF_UNSPEC`` in which case 
    the first address returned by ``resolve_name()`` will be used, otherwise the 
    first address of the specified family will be used. 
 
    *resolver*, a ``dns.resolver.Resolver`` or ``None``, the resolver to use for 
    resolution of hostnames.  If not specified, the default resolver will be used. 
 
    Returns a ``dns.resolver.Resolver`` or raises an exception. 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">resolver </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">resolver </span><span class="s4">= </span><span class="s1">get_default_resolver</span><span class="s4">()</span>
    <span class="s1">nameservers</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Nameserver</span><span class="s4">]] = []</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_address</span><span class="s4">(</span><span class="s1">where</span><span class="s4">):</span>
        <span class="s1">nameservers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Do53Nameserver</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">address </span><span class="s3">in </span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">resolve_name</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">family</span><span class="s4">).</span><span class="s1">addresses</span><span class="s4">():</span>
            <span class="s1">nameservers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">nameserver</span><span class="s4">.</span><span class="s1">Do53Nameserver</span><span class="s4">(</span><span class="s1">address</span><span class="s4">, </span><span class="s1">port</span><span class="s4">))</span>
    <span class="s1">res </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">Resolver</span><span class="s4">(</span><span class="s1">configure</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">res</span><span class="s4">.</span><span class="s1">nameservers </span><span class="s4">= </span><span class="s1">nameservers</span>
    <span class="s3">return </span><span class="s1">res</span>


<span class="s3">def </span><span class="s1">resolve_at</span><span class="s4">(</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">A</span><span class="s4">,</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">tcp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">raise_on_no_answer</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">search</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">53</span><span class="s4">,</span>
    <span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">,</span>
    <span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Resolver</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Answer</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Query nameservers to find the answer to the question. 
 
    This is a convenience function that calls ``dns.resolver.make_resolver_at()`` to 
    make a resolver, and then uses it to resolve the query. 
 
    See ``dns.resolver.Resolver.resolve`` for more information on the resolution 
    parameters, and ``dns.resolver.make_resolver_at`` for information about the resolver 
    parameters *where*, *port*, *family*, and *resolver*. 
 
    If making more than one query, it is more efficient to call 
    ``dns.resolver.make_resolver_at()`` and then use that resolver for the queries 
    instead of calling ``resolve_at()`` multiple times. 
    &quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">make_resolver_at</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">resolver</span><span class="s4">).</span><span class="s1">resolve</span><span class="s4">(</span>
        <span class="s1">qname</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">tcp</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">,</span>
        <span class="s1">raise_on_no_answer</span><span class="s4">,</span>
        <span class="s1">source_port</span><span class="s4">,</span>
        <span class="s1">lifetime</span><span class="s4">,</span>
        <span class="s1">search</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s0">#</span>
<span class="s0"># Support for overriding the system resolver for all python code in the</span>
<span class="s0"># running process.</span>
<span class="s0">#</span>

<span class="s1">_protocols_for_socktype </span><span class="s4">= {</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM</span><span class="s4">: [</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_UDP</span><span class="s4">],</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">: [</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_TCP</span><span class="s4">],</span>
<span class="s4">}</span>

<span class="s1">_resolver </span><span class="s4">= </span><span class="s3">None</span>
<span class="s1">_original_getaddrinfo </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">getaddrinfo</span>
<span class="s1">_original_getnameinfo </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">getnameinfo</span>
<span class="s1">_original_getfqdn </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">getfqdn</span>
<span class="s1">_original_gethostbyname </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname</span>
<span class="s1">_original_gethostbyname_ex </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname_ex</span>
<span class="s1">_original_gethostbyaddr </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyaddr</span>


<span class="s3">def </span><span class="s1">_getaddrinfo</span><span class="s4">(</span>
    <span class="s1">host</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">service</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">family</span><span class="s4">=</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">, </span><span class="s1">socktype</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">proto</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">=</span><span class="s6">0</span>
<span class="s4">):</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_NUMERICHOST </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s0"># Short circuit directly into the system's getaddrinfo().  We're</span>
        <span class="s0"># not adding any value in this case, and this avoids infinite loops</span>
        <span class="s0"># because dns.query.* needs to call getaddrinfo() for IPv6 scoping</span>
        <span class="s0"># reasons.  We will also do this short circuit below if we</span>
        <span class="s0"># discover that the host is an address literal.</span>
        <span class="s3">return </span><span class="s1">_original_getaddrinfo</span><span class="s4">(</span><span class="s1">host</span><span class="s4">, </span><span class="s1">service</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">socktype</span><span class="s4">, </span><span class="s1">proto</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; (</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_ADDRCONFIG </span><span class="s4">| </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_V4MAPPED</span><span class="s4">) != </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s0"># Not implemented.  We raise a gaierror as opposed to a</span>
        <span class="s0"># NotImplementedError as it helps callers handle errors more</span>
        <span class="s0"># appropriately.  [Issue #316]</span>
        <span class="s0">#</span>
        <span class="s0"># We raise EAI_FAIL as opposed to EAI_SYSTEM because there is</span>
        <span class="s0"># no EAI_SYSTEM on Windows [Issue #416].  We didn't go for</span>
        <span class="s0"># EAI_BADFLAGS as the flags aren't bad, we just don't</span>
        <span class="s0"># implement them.</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span>
            <span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_FAIL</span><span class="s4">, </span><span class="s5">&quot;Non-recoverable failure in name resolution&quot;</span>
        <span class="s4">)</span>
    <span class="s3">if </span><span class="s1">host </span><span class="s3">is None and </span><span class="s1">service </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
    <span class="s1">addrs </span><span class="s4">= []</span>
    <span class="s1">canonical_name </span><span class="s4">= </span><span class="s3">None  </span><span class="s0"># pylint: disable=redefined-outer-name</span>
    <span class="s0"># Is host None or an address literal?  If so, use the system's</span>
    <span class="s0"># getaddrinfo().</span>
    <span class="s3">if </span><span class="s1">host </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">_original_getaddrinfo</span><span class="s4">(</span><span class="s1">host</span><span class="s4">, </span><span class="s1">service</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">socktype</span><span class="s4">, </span><span class="s1">proto</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">)</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s0"># We don't care about the result of af_for_address(), we're just</span>
        <span class="s0"># calling it so it raises an exception if host is not an IPv4 or</span>
        <span class="s0"># IPv6 address.</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">af_for_address</span><span class="s4">(</span><span class="s1">host</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">_original_getaddrinfo</span><span class="s4">(</span><span class="s1">host</span><span class="s4">, </span><span class="s1">service</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">socktype</span><span class="s4">, </span><span class="s1">proto</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">pass</span>
    <span class="s0"># Something needs resolution!</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">answers </span><span class="s4">= </span><span class="s1">_resolver</span><span class="s4">.</span><span class="s1">resolve_name</span><span class="s4">(</span><span class="s1">host</span><span class="s4">, </span><span class="s1">family</span><span class="s4">)</span>
        <span class="s1">addrs </span><span class="s4">= </span><span class="s1">answers</span><span class="s4">.</span><span class="s1">addresses_and_families</span><span class="s4">()</span>
        <span class="s1">canonical_name </span><span class="s4">= </span><span class="s1">answers</span><span class="s4">.</span><span class="s1">canonical_name</span><span class="s4">().</span><span class="s1">to_text</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s0"># We raise EAI_AGAIN here as the failure may be temporary</span>
        <span class="s0"># (e.g. a timeout) and EAI_SYSTEM isn't defined on Windows.</span>
        <span class="s0"># [Issue #416]</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_AGAIN</span><span class="s4">, </span><span class="s5">&quot;Temporary failure in name resolution&quot;</span><span class="s4">)</span>
    <span class="s1">port </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s0"># Is it a port literal?</span>
        <span class="s3">if </span><span class="s1">service </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">port </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">port </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">service</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_NUMERICSERV </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">port </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">getservbyname</span><span class="s4">(</span><span class="s1">service</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                <span class="s3">pass</span>
    <span class="s3">if </span><span class="s1">port </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
    <span class="s1">tuples </span><span class="s4">= []</span>
    <span class="s3">if </span><span class="s1">socktype </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s1">socktypes </span><span class="s4">= [</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">socktypes </span><span class="s4">= [</span><span class="s1">socktype</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_CANONNAME </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s1">cname </span><span class="s4">= </span><span class="s1">canonical_name</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">cname </span><span class="s4">= </span><span class="s5">&quot;&quot;</span>
    <span class="s3">for </span><span class="s1">addr</span><span class="s4">, </span><span class="s1">af </span><span class="s3">in </span><span class="s1">addrs</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">socktype </span><span class="s3">in </span><span class="s1">socktypes</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">proto </span><span class="s3">in </span><span class="s1">_protocols_for_socktype</span><span class="s4">[</span><span class="s1">socktype</span><span class="s4">]:</span>
                <span class="s1">addr_tuple </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">low_level_address_tuple</span><span class="s4">((</span><span class="s1">addr</span><span class="s4">, </span><span class="s1">port</span><span class="s4">), </span><span class="s1">af</span><span class="s4">)</span>
                <span class="s1">tuples</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socktype</span><span class="s4">, </span><span class="s1">proto</span><span class="s4">, </span><span class="s1">cname</span><span class="s4">, </span><span class="s1">addr_tuple</span><span class="s4">))</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">tuples</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">tuples</span>


<span class="s3">def </span><span class="s1">_getnameinfo</span><span class="s4">(</span><span class="s1">sockaddr</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">=</span><span class="s6">0</span><span class="s4">):</span>
    <span class="s1">host </span><span class="s4">= </span><span class="s1">sockaddr</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">port </span><span class="s4">= </span><span class="s1">sockaddr</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">sockaddr</span><span class="s4">) == </span><span class="s6">4</span><span class="s4">:</span>
        <span class="s1">scope </span><span class="s4">= </span><span class="s1">sockaddr</span><span class="s4">[</span><span class="s6">3</span><span class="s4">]</span>
        <span class="s1">family </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">scope </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">family </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span>
    <span class="s1">tuples </span><span class="s4">= </span><span class="s1">_getaddrinfo</span><span class="s4">(</span><span class="s1">host</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_TCP</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">tuples</span><span class="s4">) &gt; </span><span class="s6">1</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">OSError</span><span class="s4">(</span><span class="s5">&quot;sockaddr resolved to multiple addresses&quot;</span><span class="s4">)</span>
    <span class="s1">addr </span><span class="s4">= </span><span class="s1">tuples</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">4</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">NI_DGRAM</span><span class="s4">:</span>
        <span class="s1">pname </span><span class="s4">= </span><span class="s5">&quot;udp&quot;</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">pname </span><span class="s4">= </span><span class="s5">&quot;tcp&quot;</span>
    <span class="s1">qname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">reversename</span><span class="s4">.</span><span class="s1">from_address</span><span class="s4">(</span><span class="s1">addr</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">NI_NUMERICHOST </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">answer </span><span class="s4">= </span><span class="s1">_resolver</span><span class="s4">.</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s5">&quot;PTR&quot;</span><span class="s4">)</span>
            <span class="s1">hostname </span><span class="s4">= </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">target</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NXDOMAIN</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">NoAnswer</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">NI_NAMEREQD</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
            <span class="s1">hostname </span><span class="s4">= </span><span class="s1">addr</span>
            <span class="s3">if </span><span class="s1">scope </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">hostname </span><span class="s4">+= </span><span class="s5">&quot;%&quot; </span><span class="s4">+ </span><span class="s1">str</span><span class="s4">(</span><span class="s1">scope</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">hostname </span><span class="s4">= </span><span class="s1">addr</span>
        <span class="s3">if </span><span class="s1">scope </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">hostname </span><span class="s4">+= </span><span class="s5">&quot;%&quot; </span><span class="s4">+ </span><span class="s1">str</span><span class="s4">(</span><span class="s1">scope</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">NI_NUMERICSERV</span><span class="s4">:</span>
        <span class="s1">service </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">port</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">service </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">getservbyport</span><span class="s4">(</span><span class="s1">port</span><span class="s4">, </span><span class="s1">pname</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">hostname</span><span class="s4">, </span><span class="s1">service</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_getfqdn</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">name </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostname</span><span class="s4">()</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">_gethostbyaddr</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s0"># Python's version checks aliases too, but our gethostbyname</span>
        <span class="s0"># ignores them, so we do so here as well.</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">pass</span>
    <span class="s3">return </span><span class="s1">name</span>


<span class="s3">def </span><span class="s1">_gethostbyname</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s3">return </span><span class="s1">_gethostbyname_ex</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)[</span><span class="s6">2</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">_gethostbyname_ex</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">aliases </span><span class="s4">= []</span>
    <span class="s1">addresses </span><span class="s4">= []</span>
    <span class="s1">tuples </span><span class="s4">= </span><span class="s1">_getaddrinfo</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_TCP</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_CANONNAME</span>
    <span class="s4">)</span>
    <span class="s1">canonical </span><span class="s4">= </span><span class="s1">tuples</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">3</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">tuples</span><span class="s4">:</span>
        <span class="s1">addresses</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">item</span><span class="s4">[</span><span class="s6">4</span><span class="s4">][</span><span class="s6">0</span><span class="s4">])</span>
    <span class="s0"># XXX we just ignore aliases</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">canonical</span><span class="s4">, </span><span class="s1">aliases</span><span class="s4">, </span><span class="s1">addresses</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_gethostbyaddr</span><span class="s4">(</span><span class="s1">ip</span><span class="s4">):</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">ipv6</span><span class="s4">.</span><span class="s1">inet_aton</span><span class="s4">(</span><span class="s1">ip</span><span class="s4">)</span>
        <span class="s1">sockaddr </span><span class="s4">= (</span><span class="s1">ip</span><span class="s4">, </span><span class="s6">80</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
        <span class="s1">family </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">ipv4</span><span class="s4">.</span><span class="s1">inet_aton</span><span class="s4">(</span><span class="s1">ip</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">gaierror</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">EAI_NONAME</span><span class="s4">, </span><span class="s5">&quot;Name or service not known&quot;</span><span class="s4">)</span>
        <span class="s1">sockaddr </span><span class="s4">= (</span><span class="s1">ip</span><span class="s4">, </span><span class="s6">80</span><span class="s4">)</span>
        <span class="s1">family </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span>
    <span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">_getnameinfo</span><span class="s4">(</span><span class="s1">sockaddr</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">NI_NAMEREQD</span><span class="s4">)</span>
    <span class="s1">aliases </span><span class="s4">= []</span>
    <span class="s1">addresses </span><span class="s4">= []</span>
    <span class="s1">tuples </span><span class="s4">= </span><span class="s1">_getaddrinfo</span><span class="s4">(</span>
        <span class="s1">name</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">family</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_TCP</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AI_CANONNAME</span>
    <span class="s4">)</span>
    <span class="s1">canonical </span><span class="s4">= </span><span class="s1">tuples</span><span class="s4">[</span><span class="s6">0</span><span class="s4">][</span><span class="s6">3</span><span class="s4">]</span>
    <span class="s0"># We only want to include an address from the tuples if it's the</span>
    <span class="s0"># same as the one we asked about.  We do this comparison in binary</span>
    <span class="s0"># to avoid any differences in text representations.</span>
    <span class="s1">bin_ip </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">inet_pton</span><span class="s4">(</span><span class="s1">family</span><span class="s4">, </span><span class="s1">ip</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">tuples</span><span class="s4">:</span>
        <span class="s1">addr </span><span class="s4">= </span><span class="s1">item</span><span class="s4">[</span><span class="s6">4</span><span class="s4">][</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">bin_addr </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">inet_pton</span><span class="s4">(</span><span class="s1">family</span><span class="s4">, </span><span class="s1">addr</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">bin_ip </span><span class="s4">== </span><span class="s1">bin_addr</span><span class="s4">:</span>
            <span class="s1">addresses</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">addr</span><span class="s4">)</span>
    <span class="s0"># XXX we just ignore aliases</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">canonical</span><span class="s4">, </span><span class="s1">aliases</span><span class="s4">, </span><span class="s1">addresses</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">override_system_resolver</span><span class="s4">(</span><span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Resolver</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Override the system resolver routines in the socket module with 
    versions which use dnspython's resolver. 
 
    This can be useful in testing situations where you want to control 
    the resolution behavior of python code without having to change 
    the system's resolver settings (e.g. /etc/resolv.conf). 
 
    The resolver to use may be specified; if it's not, the default 
    resolver will be used. 
 
    resolver, a ``dns.resolver.Resolver`` or ``None``, the resolver to use. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">resolver </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">resolver </span><span class="s4">= </span><span class="s1">get_default_resolver</span><span class="s4">()</span>
    <span class="s3">global </span><span class="s1">_resolver</span>
    <span class="s1">_resolver </span><span class="s4">= </span><span class="s1">resolver</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getaddrinfo </span><span class="s4">= </span><span class="s1">_getaddrinfo</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getnameinfo </span><span class="s4">= </span><span class="s1">_getnameinfo</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getfqdn </span><span class="s4">= </span><span class="s1">_getfqdn</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname </span><span class="s4">= </span><span class="s1">_gethostbyname</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname_ex </span><span class="s4">= </span><span class="s1">_gethostbyname_ex</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyaddr </span><span class="s4">= </span><span class="s1">_gethostbyaddr</span>


<span class="s3">def </span><span class="s1">restore_system_resolver</span><span class="s4">() </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Undo the effects of prior override_system_resolver().&quot;&quot;&quot;</span>

    <span class="s3">global </span><span class="s1">_resolver</span>
    <span class="s1">_resolver </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getaddrinfo </span><span class="s4">= </span><span class="s1">_original_getaddrinfo</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getnameinfo </span><span class="s4">= </span><span class="s1">_original_getnameinfo</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">getfqdn </span><span class="s4">= </span><span class="s1">_original_getfqdn</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname </span><span class="s4">= </span><span class="s1">_original_gethostbyname</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyname_ex </span><span class="s4">= </span><span class="s1">_original_gethostbyname_ex</span>
    <span class="s1">socket</span><span class="s4">.</span><span class="s1">gethostbyaddr </span><span class="s4">= </span><span class="s1">_original_gethostbyaddr</span>
</pre>
</body>
</html>