<html>
<head>
<title>transaction.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
transaction.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (C) Dnspython Contributors, see LICENSE for text of ISC license</span>

<span class="s2">import </span><span class="s1">collections</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">Callable</span><span class="s3">, </span><span class="s1">Iterator</span><span class="s3">, </span><span class="s1">List</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">, </span><span class="s1">Union</span>

<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">exception</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">node</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataclass</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rrset</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">serial</span>
<span class="s2">import </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">ttl</span>


<span class="s2">class </span><span class="s1">TransactionManager</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">reader</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;Transaction&quot;</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Begin a read-only transaction.&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">writer</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">replacement</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s4">&quot;Transaction&quot;</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Begin a writable transaction. 
 
        *replacement*, a ``bool``.  If `True`, the content of the 
        transaction completely replaces any prior content.  If False, 
        the default, then the content of the transaction updates the 
        existing content. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">origin_information</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">], </span><span class="s1">bool</span><span class="s3">, </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">]]:</span>
        <span class="s5">&quot;&quot;&quot;Returns a tuple 
 
            (absolute_origin, relativize, effective_origin) 
 
        giving the absolute name of the default origin for any 
        relative domain names, the &quot;effective origin&quot;, and whether 
        names should be relativized.  The &quot;effective origin&quot; is the 
        absolute origin if relativize is False, and the empty name if 
        relativize is true.  (The effective origin is provided even 
        though it can be computed from the absolute_origin and 
        relativize setting because it avoids a lot of code 
        duplication.) 
 
        If the returned names are `None`, then no origin information is 
        available. 
 
        This information is used by code working with transactions to 
        allow it to coordinate relativization.  The transaction code 
        itself takes what it gets (i.e. does not change name 
        relativity). 
 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">get_class</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; dns</span><span class="s3">.</span><span class="s1">rdataclass</span><span class="s3">.</span><span class="s1">RdataClass</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;The class of the transaction manager.&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">from_wire_origin</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">]:</span>
        <span class="s5">&quot;&quot;&quot;Origin to use in from_wire() calls.&quot;&quot;&quot;</span>
        <span class="s3">(</span><span class="s1">absolute_origin</span><span class="s3">, </span><span class="s1">relativize</span><span class="s3">, </span><span class="s1">_</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">origin_information</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">relativize</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">absolute_origin</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">return None</span>


<span class="s2">class </span><span class="s1">DeleteNotExact</span><span class="s3">(</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">exception</span><span class="s3">.</span><span class="s1">DNSException</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Existing data did not match data specified by an exact delete.&quot;&quot;&quot;</span>


<span class="s2">class </span><span class="s1">ReadOnly</span><span class="s3">(</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">exception</span><span class="s3">.</span><span class="s1">DNSException</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Tried to write to a read-only transaction.&quot;&quot;&quot;</span>


<span class="s2">class </span><span class="s1">AlreadyEnded</span><span class="s3">(</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">exception</span><span class="s3">.</span><span class="s1">DNSException</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Tried to use an already-ended transaction.&quot;&quot;&quot;</span>


<span class="s2">def </span><span class="s1">_ensure_immutable_rdataset</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">rdataset </span><span class="s2">is None or </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">ImmutableRdataset</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">rdataset</span>
    <span class="s2">return </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">ImmutableRdataset</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_ensure_immutable_node</span><span class="s3">(</span><span class="s1">node</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">node </span><span class="s2">is None or </span><span class="s1">node</span><span class="s3">.</span><span class="s1">is_immutable</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s1">node</span>
    <span class="s2">return </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">ImmutableNode</span><span class="s3">(</span><span class="s1">node</span><span class="s3">)</span>


<span class="s1">CheckPutRdatasetType </span><span class="s3">= </span><span class="s1">Callable</span><span class="s3">[</span>
    <span class="s3">[</span><span class="s4">&quot;Transaction&quot;</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">Rdataset</span><span class="s3">], </span><span class="s2">None</span>
<span class="s3">]</span>
<span class="s1">CheckDeleteRdatasetType </span><span class="s3">= </span><span class="s1">Callable</span><span class="s3">[</span>
    <span class="s3">[</span><span class="s4">&quot;Transaction&quot;</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">],</span>
    <span class="s2">None</span><span class="s3">,</span>
<span class="s3">]</span>
<span class="s1">CheckDeleteNameType </span><span class="s3">= </span><span class="s1">Callable</span><span class="s3">[[</span><span class="s4">&quot;Transaction&quot;</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">], </span><span class="s2">None</span><span class="s3">]</span>


<span class="s2">class </span><span class="s1">Transaction</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">manager</span><span class="s3">: </span><span class="s1">TransactionManager</span><span class="s3">,</span>
        <span class="s1">replacement</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">read_only</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">manager </span><span class="s3">= </span><span class="s1">manager</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">replacement </span><span class="s3">= </span><span class="s1">replacement</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">read_only </span><span class="s3">= </span><span class="s1">read_only</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ended </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_put_rdataset</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">CheckPutRdatasetType</span><span class="s3">] = []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_rdataset</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">CheckDeleteRdatasetType</span><span class="s3">] = []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_name</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">CheckDeleteNameType</span><span class="s3">] = []</span>

    <span class="s0">#</span>
    <span class="s0"># This is the high level API</span>
    <span class="s0">#</span>
    <span class="s0"># Note that we currently use non-immutable types in the return type signature to</span>
    <span class="s0"># avoid covariance problems, e.g. if the caller has a List[Rdataset], mypy will be</span>
    <span class="s0"># unhappy if we return an ImmutableRdataset.</span>

    <span class="s2">def </span><span class="s1">get</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Union</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]],</span>
        <span class="s1">rdtype</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">, </span><span class="s1">str</span><span class="s3">],</span>
        <span class="s1">covers</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">, </span><span class="s1">str</span><span class="s3">] = </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">NONE</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">Rdataset</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Return the rdataset associated with *name*, *rdtype*, and *covers*, 
        or `None` if not found. 
 
        Note that the returned rdataset is immutable. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">from_text</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">rdtype </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">rdtype</span><span class="s3">)</span>
        <span class="s1">covers </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">covers</span><span class="s3">)</span>
        <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">_ensure_immutable_rdataset</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">get_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">node</span><span class="s3">.</span><span class="s1">Node</span><span class="s3">]:</span>
        <span class="s5">&quot;&quot;&quot;Return the node at *name*, if any. 
 
        Returns an immutable node or ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">_ensure_immutable_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_node</span><span class="s3">(</span><span class="s1">name</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">_check_read_only</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">read_only</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ReadOnly</span>

    <span class="s2">def </span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Add records. 
 
        The arguments may be: 
 
            - rrset 
 
            - name, rdataset... 
 
            - name, ttl, rdata... 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_read_only</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_add</span><span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">replace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Replace the existing rdataset at the name with the specified 
        rdataset, or add the specified rdataset if there was no existing 
        rdataset. 
 
        The arguments may be: 
 
            - rrset 
 
            - name, rdataset... 
 
            - name, ttl, rdata... 
 
        Note that if you want to replace the entire node, you should do 
        a delete of the name followed by one or more calls to add() or 
        replace(). 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_read_only</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_add</span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">delete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Delete records. 
 
        It is not an error if some of the records are not in the existing 
        set. 
 
        The arguments may be: 
 
            - rrset 
 
            - name 
 
            - name, rdatatype, [covers] 
 
            - name, rdataset... 
 
            - name, rdata... 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_read_only</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_delete</span><span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">delete_exact</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">Any</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Delete records. 
 
        The arguments may be: 
 
            - rrset 
 
            - name 
 
            - name, rdatatype, [covers] 
 
            - name, rdataset... 
 
            - name, rdata... 
 
        Raises dns.transaction.DeleteNotExact if some of the records 
        are not in the existing set. 
 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_read_only</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_delete</span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">name_exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">: </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">]) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Does the specified name exist?&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">from_text</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_name_exists</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">update_serial</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">value</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">,</span>
        <span class="s1">relative</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">name</span><span class="s3">: </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Update the serial number. 
 
        *value*, an `int`, is an increment if *relative* is `True`, or the 
        actual value to set if *relative* is `False`. 
 
        Raises `KeyError` if there is no SOA rdataset at *name*. 
 
        Raises `ValueError` if *value* is negative or if the increment is 
        so large that it would cause the new serial to be less than the 
        prior value. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">value </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;negative update_serial() value&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s1">name </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">from_text</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">SOA</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">NONE</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">rdataset </span><span class="s2">is None or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">) == </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">KeyError</span>
        <span class="s2">if </span><span class="s1">relative</span><span class="s3">:</span>
            <span class="s1">serial </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">serial</span><span class="s3">.</span><span class="s1">Serial</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">serial</span><span class="s3">) + </span><span class="s1">value</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">serial </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">serial</span><span class="s3">.</span><span class="s1">Serial</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
        <span class="s1">serial </span><span class="s3">= </span><span class="s1">serial</span><span class="s3">.</span><span class="s1">value  </span><span class="s0"># convert back to int</span>
        <span class="s2">if </span><span class="s1">serial </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">serial </span><span class="s3">= </span><span class="s6">1</span>
        <span class="s1">rdata </span><span class="s3">= </span><span class="s1">rdataset</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">serial</span><span class="s3">=</span><span class="s1">serial</span><span class="s3">)</span>
        <span class="s1">new_rdataset </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">from_rdata</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">ttl</span><span class="s3">, </span><span class="s1">rdata</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">new_rdataset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">__iter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_iterate_rdatasets</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">changed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Has this transaction changed anything? 
 
        For read-only transactions, the result is always `False`. 
 
        For writable transactions, the result is `True` if at some time 
        during the life of the transaction, the content was changed. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_changed</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">commit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Commit the transaction. 
 
        Normally transactions are used as context managers and commit 
        or rollback automatically, but it may be done explicitly if needed. 
        A ``dns.transaction.Ended`` exception will be raised if you try 
        to use a transaction after it has been committed or rolled back. 
 
        Raises an exception if the commit fails (in which case the transaction 
        is also rolled back. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">rollback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Rollback the transaction. 
 
        Normally transactions are used as context managers and commit 
        or rollback automatically, but it may be done explicitly if needed. 
        A ``dns.transaction.AlreadyEnded`` exception will be raised if you try 
        to use a transaction after it has been committed or rolled back. 
 
        Rollback cannot otherwise fail. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_end</span><span class="s3">(</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_put_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">check</span><span class="s3">: </span><span class="s1">CheckPutRdatasetType</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Call *check* before putting (storing) an rdataset. 
 
        The function is called with the transaction, the name, and the rdataset. 
 
        The check function may safely make non-mutating transaction method 
        calls, but behavior is undefined if mutating transaction methods are 
        called.  The check function should raise an exception if it objects to 
        the put, and otherwise should return ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_put_rdataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">check</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_delete_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">check</span><span class="s3">: </span><span class="s1">CheckDeleteRdatasetType</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Call *check* before deleting an rdataset. 
 
        The function is called with the transaction, the name, the rdatatype, 
        and the covered rdatatype. 
 
        The check function may safely make non-mutating transaction method 
        calls, but behavior is undefined if mutating transaction methods are 
        called.  The check function should raise an exception if it objects to 
        the put, and otherwise should return ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_rdataset</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">check</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_delete_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">check</span><span class="s3">: </span><span class="s1">CheckDeleteNameType</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s5">&quot;&quot;&quot;Call *check* before putting (storing) an rdataset. 
 
        The function is called with the transaction and the name. 
 
        The check function may safely make non-mutating transaction method 
        calls, but behavior is undefined if mutating transaction methods are 
        called.  The check function should raise an exception if it objects to 
        the put, and otherwise should return ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_name</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">check</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">iterate_rdatasets</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Iterator</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">Rdataset</span><span class="s3">]]:</span>
        <span class="s5">&quot;&quot;&quot;Iterate all the rdatasets in the transaction, returning 
        (`dns.name.Name`, `dns.rdataset.Rdataset`) tuples. 
 
        Note that as is usual with python iterators, adding or removing items 
        while iterating will invalidate the iterator and may raise `RuntimeError` 
        or fail to iterate over all entries.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_iterate_rdatasets</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">iterate_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Iterator</span><span class="s3">[</span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">]:</span>
        <span class="s5">&quot;&quot;&quot;Iterate all the names in the transaction. 
 
        Note that as is usual with python iterators, adding or removing names 
        while iterating will invalidate the iterator and may raise `RuntimeError` 
        or fail to iterate over all entries.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_iterate_names</span><span class="s3">()</span>

    <span class="s0">#</span>
    <span class="s0"># Helper methods</span>
    <span class="s0">#</span>

    <span class="s2">def </span><span class="s1">_raise_if_not_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">args</span><span class="s3">) != </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;extra parameters to </span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_rdataset_from_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">deleting</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rrset</span><span class="s3">.</span><span class="s1">RRset</span><span class="s3">):</span>
                <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">to_rdataset</span><span class="s3">()</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">Rdataset</span><span class="s3">):</span>
                <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">arg</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">deleting</span><span class="s3">:</span>
                    <span class="s1">ttl </span><span class="s3">= </span><span class="s6">0</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
                        <span class="s1">ttl </span><span class="s3">= </span><span class="s1">arg</span>
                        <span class="s2">if </span><span class="s1">ttl </span><span class="s3">&gt; </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">ttl</span><span class="s3">.</span><span class="s1">MAX_TTL</span><span class="s3">:</span>
                            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: TTL value too big&quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: expected a TTL&quot;</span><span class="s3">)</span>
                    <span class="s1">arg </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdata</span><span class="s3">.</span><span class="s1">Rdata</span><span class="s3">):</span>
                    <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">from_rdata</span><span class="s3">(</span><span class="s1">ttl</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: expected an Rdata&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">rdataset</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">deleting</span><span class="s3">:</span>
                <span class="s2">return None</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># reraise</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: expected more arguments&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">replace</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">deque</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">replace</span><span class="s3">:</span>
                <span class="s1">method </span><span class="s3">= </span><span class="s4">&quot;replace()&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">method </span><span class="s3">= </span><span class="s4">&quot;add()&quot;</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">arg </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">from_text</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">):</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">arg</span>
                <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_rdataset_from_args</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rrset</span><span class="s3">.</span><span class="s1">RRset</span><span class="s3">):</span>
                <span class="s1">rrset </span><span class="s3">= </span><span class="s1">arg</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">rrset</span><span class="s3">.</span><span class="s1">name</span>
                <span class="s0"># rrsets are also rdatasets, but they don't print the</span>
                <span class="s0"># same and can't be stored in nodes, so convert.</span>
                <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">rrset</span><span class="s3">.</span><span class="s1">to_rdataset</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span>
                    <span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">} </span><span class="s4">requires a name or RRset as the first argument&quot;</span>
                <span class="s3">)</span>
            <span class="s2">if </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdclass </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">manager</span><span class="s3">.</span><span class="s1">get_class</span><span class="s3">():</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">} </span><span class="s4">has objects of wrong RdataClass&quot;</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdtype </span><span class="s3">== </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">SOA</span><span class="s3">:</span>
                <span class="s3">(</span><span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">origin</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_origin_information</span><span class="s3">()</span>
                <span class="s2">if </span><span class="s1">name </span><span class="s3">!= </span><span class="s1">origin</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">} </span><span class="s4">has non-origin SOA&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_raise_if_not_empty</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if not </span><span class="s1">replace</span><span class="s3">:</span>
                <span class="s1">existing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">covers</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">existing </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">existing</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">ImmutableRdataset</span><span class="s3">):</span>
                        <span class="s1">trds </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">Rdataset</span><span class="s3">(</span>
                            <span class="s1">existing</span><span class="s3">.</span><span class="s1">rdclass</span><span class="s3">, </span><span class="s1">existing</span><span class="s3">.</span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">existing</span><span class="s3">.</span><span class="s1">covers</span>
                        <span class="s3">)</span>
                        <span class="s1">trds</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">existing</span><span class="s3">)</span>
                        <span class="s1">existing </span><span class="s3">= </span><span class="s1">trds</span>
                    <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">existing</span><span class="s3">.</span><span class="s1">union</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_checked_put_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;not enough parameters to </span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_delete</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">exact</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">collections</span><span class="s3">.</span><span class="s1">deque</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">exact</span><span class="s3">:</span>
                <span class="s1">method </span><span class="s3">= </span><span class="s4">&quot;delete_exact()&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">method </span><span class="s3">= </span><span class="s4">&quot;delete()&quot;</span>
            <span class="s1">arg </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">arg </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">from_text</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">name</span><span class="s3">.</span><span class="s1">Name</span><span class="s3">):</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">arg</span>
                <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">args</span><span class="s3">) &gt; </span><span class="s6">0 </span><span class="s2">and </span><span class="s3">(</span>
                    <span class="s1">isinstance</span><span class="s3">(</span><span class="s1">args</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">int</span><span class="s3">) </span><span class="s2">or </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">args</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">str</span><span class="s3">)</span>
                <span class="s3">):</span>
                    <span class="s0"># deleting by type and (optionally) covers</span>
                    <span class="s1">rdtype </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">())</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">args</span><span class="s3">) &gt; </span><span class="s6">0</span><span class="s3">:</span>
                        <span class="s1">covers </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">RdataType</span><span class="s3">.</span><span class="s1">make</span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">popleft</span><span class="s3">())</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">covers </span><span class="s3">= </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rdatatype</span><span class="s3">.</span><span class="s1">NONE</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_raise_if_not_empty</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
                    <span class="s1">existing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">existing </span><span class="s2">is None</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">exact</span><span class="s3">:</span>
                            <span class="s2">raise </span><span class="s1">DeleteNotExact</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: missing rdataset&quot;</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checked_delete_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">)</span>
                    <span class="s2">return</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_rdataset_from_args</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, </span><span class="s1">dns</span><span class="s3">.</span><span class="s1">rrset</span><span class="s3">.</span><span class="s1">RRset</span><span class="s3">):</span>
                <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">arg  </span><span class="s0"># rrsets are also rdatasets</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">name</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span>
                    <span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">} </span><span class="s4">requires a name or RRset as the first argument&quot;</span>
                <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_raise_if_not_empty</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">rdataset</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdclass </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">manager</span><span class="s3">.</span><span class="s1">get_class</span><span class="s3">():</span>
                    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">} </span><span class="s4">has objects of wrong RdataClass&quot;</span><span class="s3">)</span>
                <span class="s1">existing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">covers</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">existing </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">exact</span><span class="s3">:</span>
                        <span class="s1">intersection </span><span class="s3">= </span><span class="s1">existing</span><span class="s3">.</span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">)</span>
                        <span class="s2">if </span><span class="s1">intersection </span><span class="s3">!= </span><span class="s1">rdataset</span><span class="s3">:</span>
                            <span class="s2">raise </span><span class="s1">DeleteNotExact</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: missing rdatas&quot;</span><span class="s3">)</span>
                    <span class="s1">rdataset </span><span class="s3">= </span><span class="s1">existing</span><span class="s3">.</span><span class="s1">difference</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">rdataset</span><span class="s3">) == </span><span class="s6">0</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checked_delete_rdataset</span><span class="s3">(</span>
                            <span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">.</span><span class="s1">covers</span>
                        <span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">self</span><span class="s3">.</span><span class="s1">_checked_put_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">exact</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">DeleteNotExact</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: missing rdataset&quot;</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">exact </span><span class="s2">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_name_exists</span><span class="s3">(</span><span class="s1">name</span><span class="s3">):</span>
                    <span class="s2">raise </span><span class="s1">DeleteNotExact</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">: name not known&quot;</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_checked_delete_name</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">IndexError</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s4">f&quot;not enough parameters to </span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_ended</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ended</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">AlreadyEnded</span>

    <span class="s2">def </span><span class="s1">_end</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">commit</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_ended</span><span class="s3">()</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_end_transaction</span><span class="s3">(</span><span class="s1">commit</span><span class="s3">)</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ended </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">def </span><span class="s1">_checked_put_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">check </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_check_put_rdataset</span><span class="s3">:</span>
            <span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_put_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_checked_delete_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">check </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_rdataset</span><span class="s3">:</span>
            <span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_delete_rdataset</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_checked_delete_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">check </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_check_delete_name</span><span class="s3">:</span>
            <span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_delete_name</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

    <span class="s0">#</span>
    <span class="s0"># Transactions are context managers.</span>
    <span class="s0">#</span>

    <span class="s2">def </span><span class="s1">__enter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">exc_type</span><span class="s3">, </span><span class="s1">exc_val</span><span class="s3">, </span><span class="s1">exc_tb</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ended</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">exc_type </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">commit</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">rollback</span><span class="s3">()</span>
        <span class="s2">return False</span>

    <span class="s0">#</span>
    <span class="s0"># This is the low level API, which must be implemented by subclasses</span>
    <span class="s0"># of Transaction.</span>
    <span class="s0">#</span>

    <span class="s2">def </span><span class="s1">_get_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Return the rdataset associated with *name*, *rdtype*, and *covers*, 
        or `None` if not found. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_put_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdataset</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Store the rdataset.&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_delete_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Delete all data associated with *name*. 
 
        It is not an error if the name does not exist. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_delete_rdataset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">rdtype</span><span class="s3">, </span><span class="s1">covers</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Delete all data associated with *name*, *rdtype*, and *covers*. 
 
        It is not an error if the rdataset does not exist. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_name_exists</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Does name exist? 
 
        Returns a bool. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_changed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Has this transaction changed anything?&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_end_transaction</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">commit</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;End the transaction. 
 
        *commit*, a bool.  If ``True``, commit the transaction, otherwise 
        roll it back. 
 
        If committing and the commit fails, then roll back and raise an 
        exception. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_set_origin</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">origin</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Set the origin. 
 
        This method is called when reading a possibly relativized 
        source, and an origin setting operation occurs (e.g. $ORIGIN 
        in a zone file). 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_iterate_rdatasets</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Return an iterator that yields (name, rdataset) tuples.&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_iterate_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Return an iterator that yields a name.&quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s2">def </span><span class="s1">_get_node</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">name</span><span class="s3">):</span>
        <span class="s5">&quot;&quot;&quot;Return the node at *name*, if any. 
 
        Returns a node or ``None``. 
        &quot;&quot;&quot;</span>
        <span class="s2">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

    <span class="s0">#</span>
    <span class="s0"># Low-level API with a default implementation, in case a subclass needs</span>
    <span class="s0"># to override.</span>
    <span class="s0">#</span>

    <span class="s2">def </span><span class="s1">_origin_information</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># This is only used by _add()</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">manager</span><span class="s3">.</span><span class="s1">origin_information</span><span class="s3">()</span>
</pre>
</body>
</html>