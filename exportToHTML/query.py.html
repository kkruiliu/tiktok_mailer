<html>
<head>
<title>query.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
query.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (C) Dnspython Contributors, see LICENSE for text of ISC license</span>

<span class="s0"># Copyright (C) 2003-2017 Nominum, Inc.</span>
<span class="s0">#</span>
<span class="s0"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="s0"># documentation for any purpose with or without fee is hereby granted,</span>
<span class="s0"># provided that the above copyright notice and this permission notice</span>
<span class="s0"># appear in all copies.</span>
<span class="s0">#</span>
<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND NOMINUM DISCLAIMS ALL WARRANTIES</span>
<span class="s0"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="s0"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL NOMINUM BE LIABLE FOR</span>
<span class="s0"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="s0"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="s0"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="s0"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="s2">&quot;&quot;&quot;Talk to a DNS server.&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">base64</span>
<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">enum</span>
<span class="s3">import </span><span class="s1">errno</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span>
<span class="s3">import </span><span class="s1">random</span>
<span class="s3">import </span><span class="s1">selectors</span>
<span class="s3">import </span><span class="s1">socket</span>
<span class="s3">import </span><span class="s1">struct</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">import </span><span class="s1">urllib</span><span class="s4">.</span><span class="s1">parse</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">, </span><span class="s1">cast</span>

<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_features</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">serial</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span>


<span class="s3">def </span><span class="s1">_remaining</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">expiration </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return None</span>
    <span class="s1">timeout </span><span class="s4">= </span><span class="s1">expiration </span><span class="s4">- </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">timeout </span><span class="s4">&lt;= </span><span class="s5">0.0</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">Timeout</span>
    <span class="s3">return </span><span class="s1">timeout</span>


<span class="s3">def </span><span class="s1">_expiration_for_this_attempt</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">expiration </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return None</span>
    <span class="s3">return </span><span class="s1">min</span><span class="s4">(</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">() + </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s1">_have_httpx </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_features</span><span class="s4">.</span><span class="s1">have</span><span class="s4">(</span><span class="s6">&quot;doh&quot;</span><span class="s4">)</span>
<span class="s3">if </span><span class="s1">_have_httpx</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">httpcore</span><span class="s4">.</span><span class="s1">_backends</span><span class="s4">.</span><span class="s1">sync</span>
    <span class="s3">import </span><span class="s1">httpx</span>

    <span class="s1">_CoreNetworkBackend </span><span class="s4">= </span><span class="s1">httpcore</span><span class="s4">.</span><span class="s1">NetworkBackend</span>
    <span class="s1">_CoreSyncStream </span><span class="s4">= </span><span class="s1">httpcore</span><span class="s4">.</span><span class="s1">_backends</span><span class="s4">.</span><span class="s1">sync</span><span class="s4">.</span><span class="s1">SyncStream</span>

    <span class="s3">class </span><span class="s1">_NetworkBackend</span><span class="s4">(</span><span class="s1">_CoreNetworkBackend</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">resolver</span><span class="s4">, </span><span class="s1">local_port</span><span class="s4">, </span><span class="s1">bootstrap_address</span><span class="s4">, </span><span class="s1">family</span><span class="s4">):</span>
            <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_local_port </span><span class="s4">= </span><span class="s1">local_port</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_resolver </span><span class="s4">= </span><span class="s1">resolver</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_bootstrap_address </span><span class="s4">= </span><span class="s1">bootstrap_address</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_family </span><span class="s4">= </span><span class="s1">family</span>

        <span class="s3">def </span><span class="s1">connect_tcp</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">, </span><span class="s1">host</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">local_address</span><span class="s4">, </span><span class="s1">socket_options</span><span class="s4">=</span><span class="s3">None</span>
        <span class="s4">):  </span><span class="s0"># pylint: disable=signature-differs</span>
            <span class="s1">addresses </span><span class="s4">= []</span>
            <span class="s1">_</span><span class="s4">, </span><span class="s1">expiration </span><span class="s4">= </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_address</span><span class="s4">(</span><span class="s1">host</span><span class="s4">):</span>
                <span class="s1">addresses</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">host</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_bootstrap_address </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">addresses</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_bootstrap_address</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">timeout </span><span class="s4">= </span><span class="s1">_remaining</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">)</span>
                <span class="s1">family </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_family</span>
                <span class="s3">if </span><span class="s1">local_address</span><span class="s4">:</span>
                    <span class="s1">family </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">af_for_address</span><span class="s4">(</span><span class="s1">local_address</span><span class="s4">)</span>
                <span class="s1">answers </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_resolver</span><span class="s4">.</span><span class="s1">resolve_name</span><span class="s4">(</span>
                    <span class="s1">host</span><span class="s4">, </span><span class="s1">family</span><span class="s4">=</span><span class="s1">family</span><span class="s4">, </span><span class="s1">lifetime</span><span class="s4">=</span><span class="s1">timeout</span>
                <span class="s4">)</span>
                <span class="s1">addresses </span><span class="s4">= </span><span class="s1">answers</span><span class="s4">.</span><span class="s1">addresses</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">address </span><span class="s3">in </span><span class="s1">addresses</span><span class="s4">:</span>
                <span class="s1">af </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">af_for_address</span><span class="s4">(</span><span class="s1">address</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">local_address </span><span class="s3">is not None or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_local_port </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">:</span>
                    <span class="s1">source </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">low_level_address_tuple</span><span class="s4">(</span>
                        <span class="s4">(</span><span class="s1">local_address</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_local_port</span><span class="s4">), </span><span class="s1">af</span>
                    <span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">source </span><span class="s4">= </span><span class="s3">None</span>
                <span class="s1">sock </span><span class="s4">= </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">source</span><span class="s4">)</span>
                <span class="s1">attempt_expiration </span><span class="s4">= </span><span class="s1">_expiration_for_this_attempt</span><span class="s4">(</span><span class="s5">2.0</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">_connect</span><span class="s4">(</span>
                        <span class="s1">sock</span><span class="s4">,</span>
                        <span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">low_level_address_tuple</span><span class="s4">((</span><span class="s1">address</span><span class="s4">, </span><span class="s1">port</span><span class="s4">), </span><span class="s1">af</span><span class="s4">),</span>
                        <span class="s1">attempt_expiration</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s3">return </span><span class="s1">_CoreSyncStream</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">)</span>
                <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                    <span class="s3">pass</span>
            <span class="s3">raise </span><span class="s1">httpcore</span><span class="s4">.</span><span class="s1">ConnectError</span>

        <span class="s3">def </span><span class="s1">connect_unix_socket</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">, </span><span class="s1">path</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">socket_options</span><span class="s4">=</span><span class="s3">None</span>
        <span class="s4">):  </span><span class="s0"># pylint: disable=signature-differs</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span>

    <span class="s3">class </span><span class="s1">_HTTPTransport</span><span class="s4">(</span><span class="s1">httpx</span><span class="s4">.</span><span class="s1">HTTPTransport</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">,</span>
            <span class="s4">*</span><span class="s1">args</span><span class="s4">,</span>
            <span class="s1">local_port</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
            <span class="s1">bootstrap_address</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
            <span class="s1">resolver</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
            <span class="s1">family</span><span class="s4">=</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">,</span>
            <span class="s4">**</span><span class="s1">kwargs</span><span class="s4">,</span>
        <span class="s4">):</span>
            <span class="s3">if </span><span class="s1">resolver </span><span class="s3">is None and </span><span class="s1">bootstrap_address </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s0"># pylint: disable=import-outside-toplevel,redefined-outer-name</span>
                <span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span>

                <span class="s1">resolver </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">Resolver</span><span class="s4">()</span>
            <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_pool</span><span class="s4">.</span><span class="s1">_network_backend </span><span class="s4">= </span><span class="s1">_NetworkBackend</span><span class="s4">(</span>
                <span class="s1">resolver</span><span class="s4">, </span><span class="s1">local_port</span><span class="s4">, </span><span class="s1">bootstrap_address</span><span class="s4">, </span><span class="s1">family</span>
            <span class="s4">)</span>

<span class="s3">else</span><span class="s4">:</span>

    <span class="s3">class </span><span class="s1">_HTTPTransport</span><span class="s4">:  </span><span class="s0"># type: ignore</span>
        <span class="s3">def </span><span class="s1">connect_tcp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">host</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">local_address</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span>


<span class="s1">have_doh </span><span class="s4">= </span><span class="s1">_have_httpx</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">ssl</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>

    <span class="s3">class </span><span class="s1">ssl</span><span class="s4">:  </span><span class="s0"># type: ignore</span>
        <span class="s1">CERT_NONE </span><span class="s4">= </span><span class="s5">0</span>

        <span class="s3">class </span><span class="s1">WantReadException</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">WantWriteException</span><span class="s4">(</span><span class="s1">Exception</span><span class="s4">):</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">SSLContext</span><span class="s4">:</span>
            <span class="s3">pass</span>

        <span class="s3">class </span><span class="s1">SSLSocket</span><span class="s4">:</span>
            <span class="s3">pass</span>

        <span class="s4">@</span><span class="s1">classmethod</span>
        <span class="s3">def </span><span class="s1">create_default_context</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">Exception</span><span class="s4">(</span><span class="s6">&quot;no ssl support&quot;</span><span class="s4">)  </span><span class="s0"># pylint: disable=broad-exception-raised</span>


<span class="s0"># Function used to create a socket.  Can be overridden if needed in special</span>
<span class="s0"># situations.</span>
<span class="s1">socket_factory </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">socket</span>


<span class="s3">class </span><span class="s1">UnexpectedSource</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A DNS query response came from an unexpected address or port.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">BadResponse</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A DNS query response does not respond to the question asked.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoDOH</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;DNS over HTTPS (DOH) was requested but the httpx module is not 
    available.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoDOQ</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;DNS over QUIC (DOQ) was requested but the aioquic module is not 
    available.&quot;&quot;&quot;</span>


<span class="s0"># for backwards compatibility</span>
<span class="s1">TransferError </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span><span class="s4">.</span><span class="s1">TransferError</span>


<span class="s3">def </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">):</span>
    <span class="s1">now </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">timeout </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">now</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">now</span><span class="s4">, </span><span class="s1">now </span><span class="s4">+ </span><span class="s1">timeout</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_wait_for</span><span class="s4">(</span><span class="s1">fd</span><span class="s4">, </span><span class="s1">readable</span><span class="s4">, </span><span class="s1">writable</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s0"># Use the selected selector class to wait for any of the specified</span>
    <span class="s0"># events.  An &quot;expiration&quot; absolute time is converted into a relative</span>
    <span class="s0"># timeout.</span>
    <span class="s0">#</span>
    <span class="s0"># The unused parameter is 'error', which is always set when</span>
    <span class="s0"># selecting for read or write, and we have no error-only selects.</span>

    <span class="s3">if </span><span class="s1">readable </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">fd</span><span class="s4">, </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLSocket</span><span class="s4">) </span><span class="s3">and </span><span class="s1">fd</span><span class="s4">.</span><span class="s1">pending</span><span class="s4">() &gt; </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">return True</span>
    <span class="s1">sel </span><span class="s4">= </span><span class="s1">selectors</span><span class="s4">.</span><span class="s1">DefaultSelector</span><span class="s4">()</span>
    <span class="s1">events </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s3">if </span><span class="s1">readable</span><span class="s4">:</span>
        <span class="s1">events </span><span class="s4">|= </span><span class="s1">selectors</span><span class="s4">.</span><span class="s1">EVENT_READ</span>
    <span class="s3">if </span><span class="s1">writable</span><span class="s4">:</span>
        <span class="s1">events </span><span class="s4">|= </span><span class="s1">selectors</span><span class="s4">.</span><span class="s1">EVENT_WRITE</span>
    <span class="s3">if </span><span class="s1">events</span><span class="s4">:</span>
        <span class="s1">sel</span><span class="s4">.</span><span class="s1">register</span><span class="s4">(</span><span class="s1">fd</span><span class="s4">, </span><span class="s1">events</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">expiration </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">timeout </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">timeout </span><span class="s4">= </span><span class="s1">expiration </span><span class="s4">- </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">timeout </span><span class="s4">&lt;= </span><span class="s5">0.0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">Timeout</span>
    <span class="s3">if not </span><span class="s1">sel</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">Timeout</span>


<span class="s3">def </span><span class="s1">_wait_for_readable</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s1">_wait_for</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s1">_wait_for</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_addresses_equal</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">a1</span><span class="s4">, </span><span class="s1">a2</span><span class="s4">):</span>
    <span class="s0"># Convert the first value of the tuple, which is a textual format</span>
    <span class="s0"># address into binary form, so that we are not confused by different</span>
    <span class="s0"># textual representations of the same address</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">n1 </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">inet_pton</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">a1</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s1">n2 </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">inet_pton</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">a2</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
    <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span><span class="s4">:</span>
        <span class="s3">return False</span>
    <span class="s3">return </span><span class="s1">n1 </span><span class="s4">== </span><span class="s1">n2 </span><span class="s3">and </span><span class="s1">a1</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:] == </span><span class="s1">a2</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]</span>


<span class="s3">def </span><span class="s1">_matches_destination</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">from_address</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">ignore_unexpected</span><span class="s4">):</span>
    <span class="s0"># Check that from_address is appropriate for a response to a query</span>
    <span class="s0"># sent to destination.</span>
    <span class="s3">if not </span><span class="s1">destination</span><span class="s4">:</span>
        <span class="s3">return True</span>
    <span class="s3">if </span><span class="s1">_addresses_equal</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">from_address</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">) </span><span class="s3">or </span><span class="s4">(</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_multicast</span><span class="s4">(</span><span class="s1">destination</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]) </span><span class="s3">and </span><span class="s1">from_address</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:] == </span><span class="s1">destination</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]</span>
    <span class="s4">):</span>
        <span class="s3">return True</span>
    <span class="s3">elif </span><span class="s1">ignore_unexpected</span><span class="s4">:</span>
        <span class="s3">return False</span>
    <span class="s3">raise </span><span class="s1">UnexpectedSource</span><span class="s4">(</span>
        <span class="s6">f&quot;got a response from </span><span class="s3">{</span><span class="s1">from_address</span><span class="s3">} </span><span class="s6">instead of &quot; f&quot;</span><span class="s3">{</span><span class="s1">destination</span><span class="s3">}</span><span class="s6">&quot;</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
    <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span><span class="s4">, </span><span class="s1">where_must_be_address</span><span class="s4">=</span><span class="s3">True</span>
<span class="s4">):</span>
    <span class="s0"># Apply defaults and compute destination and source tuples</span>
    <span class="s0"># suitable for use in connect(), sendto(), or bind().</span>
    <span class="s1">af </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">destination </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">af </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">af_for_address</span><span class="s4">(</span><span class="s1">where</span><span class="s4">)</span>
        <span class="s1">destination </span><span class="s4">= </span><span class="s1">where</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">where_must_be_address</span><span class="s4">:</span>
            <span class="s3">raise</span>
        <span class="s0"># URLs are ok so eat the exception</span>
    <span class="s3">if </span><span class="s1">source</span><span class="s4">:</span>
        <span class="s1">saf </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">af_for_address</span><span class="s4">(</span><span class="s1">source</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">af</span><span class="s4">:</span>
            <span class="s0"># We know the destination af, so source had better agree!</span>
            <span class="s3">if </span><span class="s1">saf </span><span class="s4">!= </span><span class="s1">af</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                    <span class="s6">&quot;different address families for source and destination&quot;</span>
                <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># We didn't know the destination af, but we know the source,</span>
            <span class="s0"># so that's our af.</span>
            <span class="s1">af </span><span class="s4">= </span><span class="s1">saf</span>
    <span class="s3">if </span><span class="s1">source_port </span><span class="s3">and not </span><span class="s1">source</span><span class="s4">:</span>
        <span class="s0"># Caller has specified a source_port but not an address, so we</span>
        <span class="s0"># need to return a source, and we need to use the appropriate</span>
        <span class="s0"># wildcard address as the address.</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">source </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">any_for_af</span><span class="s4">(</span><span class="s1">af</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s0"># we catch this and raise ValueError for backwards compatibility</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">&quot;source_port specified but address family is unknown&quot;</span><span class="s4">)</span>
    <span class="s0"># Convert high-level (address, port) tuples into low-level address</span>
    <span class="s0"># tuples.</span>
    <span class="s3">if </span><span class="s1">destination</span><span class="s4">:</span>
        <span class="s1">destination </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">low_level_address_tuple</span><span class="s4">((</span><span class="s1">destination</span><span class="s4">, </span><span class="s1">port</span><span class="s4">), </span><span class="s1">af</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">source</span><span class="s4">:</span>
        <span class="s1">source </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">low_level_address_tuple</span><span class="s4">((</span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span><span class="s4">), </span><span class="s1">af</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">ssl_context</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">server_hostname</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
    <span class="s1">s </span><span class="s4">= </span><span class="s1">socket_factory</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">type</span><span class="s4">)</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">setblocking</span><span class="s4">(</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">source </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">bind</span><span class="s4">(</span><span class="s1">source</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">ssl_context</span><span class="s4">:</span>
            <span class="s0"># LGTM gets a false positive here, as our default context is OK</span>
            <span class="s3">return </span><span class="s1">ssl_context</span><span class="s4">.</span><span class="s1">wrap_socket</span><span class="s4">(</span>
                <span class="s1">s</span><span class="s4">,</span>
                <span class="s1">do_handshake_on_connect</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,  </span><span class="s0"># lgtm[py/insecure-protocol]</span>
                <span class="s1">server_hostname</span><span class="s4">=</span><span class="s1">server_hostname</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">s</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">close</span><span class="s4">()</span>
        <span class="s3">raise</span>


<span class="s3">def </span><span class="s1">_maybe_get_resolver</span><span class="s4">(</span>
    <span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s6">&quot;dns.resolver.Resolver&quot;</span><span class="s4">],</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s6">&quot;dns.resolver.Resolver&quot;</span><span class="s4">:</span>
    <span class="s0"># We need a separate method for this to avoid overriding the global</span>
    <span class="s0"># variable &quot;dns&quot; with the as-yet undefined local variable &quot;dns&quot;</span>
    <span class="s0"># in https().</span>
    <span class="s3">if </span><span class="s1">resolver </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s0"># pylint: disable=import-outside-toplevel,redefined-outer-name</span>
        <span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span>

        <span class="s1">resolver </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">Resolver</span><span class="s4">()</span>
    <span class="s3">return </span><span class="s1">resolver</span>


<span class="s3">class </span><span class="s1">HTTPVersion</span><span class="s4">(</span><span class="s1">enum</span><span class="s4">.</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Which version of HTTP should be used? 
 
    DEFAULT will select the first version from the list [2, 1.1, 3] that 
    is available. 
    &quot;&quot;&quot;</span>

    <span class="s1">DEFAULT </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">HTTP_1 </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">H1 </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">HTTP_2 </span><span class="s4">= </span><span class="s5">2</span>
    <span class="s1">H2 </span><span class="s4">= </span><span class="s5">2</span>
    <span class="s1">HTTP_3 </span><span class="s4">= </span><span class="s5">3</span>
    <span class="s1">H3 </span><span class="s4">= </span><span class="s5">3</span>


<span class="s3">def </span><span class="s1">https</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">443</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">session</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">path</span><span class="s4">: </span><span class="s1">str </span><span class="s4">= </span><span class="s6">&quot;/dns-query&quot;</span><span class="s4">,</span>
    <span class="s1">post</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">bootstrap_address</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">verify</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">resolver</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s6">&quot;dns.resolver.Resolver&quot;</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">family</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_UNSPEC</span><span class="s4">,</span>
    <span class="s1">http_version</span><span class="s4">: </span><span class="s1">HTTPVersion </span><span class="s4">= </span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">DEFAULT</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the response obtained after sending a query via DNS-over-HTTPS. 
 
    *q*, a ``dns.message.Message``, the query to send. 
 
    *where*, a ``str``, the nameserver IP address or the full URL. If an IP address is 
    given, the URL will be constructed using the following schema: 
    https://&lt;IP-address&gt;:&lt;port&gt;/&lt;path&gt;. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the query 
    times out. If ``None``, the default, wait forever. 
 
    *port*, a ``int``, the port to send the query to. The default is 443. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying the source 
    address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. The default is 
    0. 
 
    *one_rr_per_rrset*, a ``bool``. If ``True``, put each RR into its own RRset. 
 
    *ignore_trailing*, a ``bool``. If ``True``, ignore trailing junk at end of the 
    received message. 
 
    *session*, an ``httpx.Client``.  If provided, the client session to use to send the 
    queries. 
 
    *path*, a ``str``. If *where* is an IP address, then *path* will be used to 
    construct the URL to send the DNS query to. 
 
    *post*, a ``bool``. If ``True``, the default, POST method will be used. 
 
    *bootstrap_address*, a ``str``, the IP address to use to bypass resolution. 
 
    *verify*, a ``bool`` or ``str``.  If a ``True``, then TLS certificate verification 
    of the server is done using the default CA bundle; if ``False``, then no 
    verification is done; if a `str` then it specifies the path to a certificate file or 
    directory which will be used for verification. 
 
    *resolver*, a ``dns.resolver.Resolver`` or ``None``, the resolver to use for 
    resolution of hostnames in URLs.  If not specified, a new resolver with a default 
    configuration will be used; note this is *not* the default resolver as that resolver 
    might have been configured to use DoH causing a chicken-and-egg problem.  This 
    parameter only has an effect if the HTTP library is httpx. 
 
    *family*, an ``int``, the address family.  If socket.AF_UNSPEC (the default), both A 
    and AAAA records will be retrieved. 
 
    *http_version*, a ``dns.query.HTTPVersion``, indicating which HTTP version to use. 
 
    Returns a ``dns.message.Message``. 
    &quot;&quot;&quot;</span>

    <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">the_source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
        <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span><span class="s4">, </span><span class="s3">False</span>
    <span class="s4">)</span>
    <span class="s3">if </span><span class="s1">af </span><span class="s3">is not None and </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_address</span><span class="s4">(</span><span class="s1">where</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">af </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET</span><span class="s4">:</span>
            <span class="s1">url </span><span class="s4">= </span><span class="s6">f&quot;https://</span><span class="s3">{</span><span class="s1">where</span><span class="s3">}</span><span class="s6">:</span><span class="s3">{</span><span class="s1">port</span><span class="s3">}{</span><span class="s1">path</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s3">elif </span><span class="s1">af </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">AF_INET6</span><span class="s4">:</span>
            <span class="s1">url </span><span class="s4">= </span><span class="s6">f&quot;https://[</span><span class="s3">{</span><span class="s1">where</span><span class="s3">}</span><span class="s6">]:</span><span class="s3">{</span><span class="s1">port</span><span class="s3">}{</span><span class="s1">path</span><span class="s3">}</span><span class="s6">&quot;</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">url </span><span class="s4">= </span><span class="s1">where</span>

    <span class="s1">extensions </span><span class="s4">= {}</span>
    <span class="s3">if </span><span class="s1">bootstrap_address </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
        <span class="s1">parsed </span><span class="s4">= </span><span class="s1">urllib</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">.</span><span class="s1">urlparse</span><span class="s4">(</span><span class="s1">url</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">&quot;no hostname in URL&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">inet</span><span class="s4">.</span><span class="s1">is_address</span><span class="s4">(</span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname</span><span class="s4">):</span>
            <span class="s1">bootstrap_address </span><span class="s4">= </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname</span>
            <span class="s1">extensions</span><span class="s4">[</span><span class="s6">&quot;sni_hostname&quot;</span><span class="s4">] = </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname</span>
        <span class="s3">if </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">port </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">port </span><span class="s4">= </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">port</span>

    <span class="s3">if </span><span class="s1">http_version </span><span class="s4">== </span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">H3 </span><span class="s3">or </span><span class="s4">(</span>
        <span class="s1">http_version </span><span class="s4">== </span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">DEFAULT </span><span class="s3">and not </span><span class="s1">have_doh</span>
    <span class="s4">):</span>
        <span class="s3">if </span><span class="s1">bootstrap_address </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">resolver </span><span class="s4">= </span><span class="s1">_maybe_get_resolver</span><span class="s4">(</span><span class="s1">resolver</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname </span><span class="s3">is not None  </span><span class="s0"># for mypy</span>
            <span class="s1">answers </span><span class="s4">= </span><span class="s1">resolver</span><span class="s4">.</span><span class="s1">resolve_name</span><span class="s4">(</span><span class="s1">parsed</span><span class="s4">.</span><span class="s1">hostname</span><span class="s4">, </span><span class="s1">family</span><span class="s4">)</span>
            <span class="s1">bootstrap_address </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">choice</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">answers</span><span class="s4">.</span><span class="s1">addresses</span><span class="s4">()))</span>
        <span class="s3">return </span><span class="s1">_http3</span><span class="s4">(</span>
            <span class="s1">q</span><span class="s4">,</span>
            <span class="s1">bootstrap_address</span><span class="s4">,</span>
            <span class="s1">url</span><span class="s4">,</span>
            <span class="s1">timeout</span><span class="s4">,</span>
            <span class="s1">port</span><span class="s4">,</span>
            <span class="s1">source</span><span class="s4">,</span>
            <span class="s1">source_port</span><span class="s4">,</span>
            <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
            <span class="s1">ignore_trailing</span><span class="s4">,</span>
            <span class="s1">verify</span><span class="s4">=</span><span class="s1">verify</span><span class="s4">,</span>
            <span class="s1">post</span><span class="s4">=</span><span class="s1">post</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s3">if not </span><span class="s1">have_doh</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">NoDOH  </span><span class="s0"># pragma: no cover</span>
    <span class="s3">if </span><span class="s1">session </span><span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">session</span><span class="s4">, </span><span class="s1">httpx</span><span class="s4">.</span><span class="s1">Client</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">&quot;session parameter must be an httpx.Client&quot;</span><span class="s4">)</span>

    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">headers </span><span class="s4">= {</span><span class="s6">&quot;accept&quot;</span><span class="s4">: </span><span class="s6">&quot;application/dns-message&quot;</span><span class="s4">}</span>

    <span class="s1">h1 </span><span class="s4">= </span><span class="s1">http_version </span><span class="s3">in </span><span class="s4">(</span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">H1</span><span class="s4">, </span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">DEFAULT</span><span class="s4">)</span>
    <span class="s1">h2 </span><span class="s4">= </span><span class="s1">http_version </span><span class="s3">in </span><span class="s4">(</span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">H2</span><span class="s4">, </span><span class="s1">HTTPVersion</span><span class="s4">.</span><span class="s1">DEFAULT</span><span class="s4">)</span>

    <span class="s0"># set source port and source address</span>

    <span class="s3">if </span><span class="s1">the_source </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">local_address </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">local_port </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">local_address </span><span class="s4">= </span><span class="s1">the_source</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">local_port </span><span class="s4">= </span><span class="s1">the_source</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>

    <span class="s3">if </span><span class="s1">session</span><span class="s4">:</span>
        <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">session</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">transport </span><span class="s4">= </span><span class="s1">_HTTPTransport</span><span class="s4">(</span>
            <span class="s1">local_address</span><span class="s4">=</span><span class="s1">local_address</span><span class="s4">,</span>
            <span class="s1">http1</span><span class="s4">=</span><span class="s1">h1</span><span class="s4">,</span>
            <span class="s1">http2</span><span class="s4">=</span><span class="s1">h2</span><span class="s4">,</span>
            <span class="s1">verify</span><span class="s4">=</span><span class="s1">verify</span><span class="s4">,</span>
            <span class="s1">local_port</span><span class="s4">=</span><span class="s1">local_port</span><span class="s4">,</span>
            <span class="s1">bootstrap_address</span><span class="s4">=</span><span class="s1">bootstrap_address</span><span class="s4">,</span>
            <span class="s1">resolver</span><span class="s4">=</span><span class="s1">resolver</span><span class="s4">,</span>
            <span class="s1">family</span><span class="s4">=</span><span class="s1">family</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s1">cm </span><span class="s4">= </span><span class="s1">httpx</span><span class="s4">.</span><span class="s1">Client</span><span class="s4">(</span><span class="s1">http1</span><span class="s4">=</span><span class="s1">h1</span><span class="s4">, </span><span class="s1">http2</span><span class="s4">=</span><span class="s1">h2</span><span class="s4">, </span><span class="s1">verify</span><span class="s4">=</span><span class="s1">verify</span><span class="s4">, </span><span class="s1">transport</span><span class="s4">=</span><span class="s1">transport</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">session</span><span class="s4">:</span>
        <span class="s0"># see https://tools.ietf.org/html/rfc8484#section-4.1.1 for DoH</span>
        <span class="s0"># GET and POST examples</span>
        <span class="s3">if </span><span class="s1">post</span><span class="s4">:</span>
            <span class="s1">headers</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span>
                <span class="s4">{</span>
                    <span class="s6">&quot;content-type&quot;</span><span class="s4">: </span><span class="s6">&quot;application/dns-message&quot;</span><span class="s4">,</span>
                    <span class="s6">&quot;content-length&quot;</span><span class="s4">: </span><span class="s1">str</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">)),</span>
                <span class="s4">}</span>
            <span class="s4">)</span>
            <span class="s1">response </span><span class="s4">= </span><span class="s1">session</span><span class="s4">.</span><span class="s1">post</span><span class="s4">(</span>
                <span class="s1">url</span><span class="s4">,</span>
                <span class="s1">headers</span><span class="s4">=</span><span class="s1">headers</span><span class="s4">,</span>
                <span class="s1">content</span><span class="s4">=</span><span class="s1">wire</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">=</span><span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">extensions</span><span class="s4">=</span><span class="s1">extensions</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">wire </span><span class="s4">= </span><span class="s1">base64</span><span class="s4">.</span><span class="s1">urlsafe_b64encode</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">).</span><span class="s1">rstrip</span><span class="s4">(</span><span class="s7">b&quot;=&quot;</span><span class="s4">)</span>
            <span class="s1">twire </span><span class="s4">= </span><span class="s1">wire</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()  </span><span class="s0"># httpx does a repr() if we give it bytes</span>
            <span class="s1">response </span><span class="s4">= </span><span class="s1">session</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span>
                <span class="s1">url</span><span class="s4">,</span>
                <span class="s1">headers</span><span class="s4">=</span><span class="s1">headers</span><span class="s4">,</span>
                <span class="s1">timeout</span><span class="s4">=</span><span class="s1">timeout</span><span class="s4">,</span>
                <span class="s1">params</span><span class="s4">={</span><span class="s6">&quot;dns&quot;</span><span class="s4">: </span><span class="s1">twire</span><span class="s4">},</span>
                <span class="s1">extensions</span><span class="s4">=</span><span class="s1">extensions</span><span class="s4">,</span>
            <span class="s4">)</span>

    <span class="s0"># see https://tools.ietf.org/html/rfc8484#section-4.2.1 for info about DoH</span>
    <span class="s0"># status codes</span>
    <span class="s3">if </span><span class="s1">response</span><span class="s4">.</span><span class="s1">status_code </span><span class="s4">&lt; </span><span class="s5">200 </span><span class="s3">or </span><span class="s1">response</span><span class="s4">.</span><span class="s1">status_code </span><span class="s4">&gt; </span><span class="s5">299</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
            <span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">where</span><span class="s3">} </span><span class="s6">responded with status code </span><span class="s3">{</span><span class="s1">response</span><span class="s4">.</span><span class="s1">status_code</span><span class="s3">}</span><span class="s6">&quot;</span>
            <span class="s6">f&quot;</span><span class="s3">\n</span><span class="s6">Response body: </span><span class="s3">{</span><span class="s1">response</span><span class="s4">.</span><span class="s1">content</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s4">)</span>
    <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">content</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
        <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">request_mac</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s1">ignore_trailing</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">response</span><span class="s4">.</span><span class="s1">elapsed</span><span class="s4">.</span><span class="s1">total_seconds</span><span class="s4">()</span>
    <span class="s3">if not </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">BadResponse</span>
    <span class="s3">return </span><span class="s1">r</span>


<span class="s3">def </span><span class="s1">_find_header</span><span class="s4">(</span><span class="s1">headers</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">Headers</span><span class="s4">, </span><span class="s1">name</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
    <span class="s3">if </span><span class="s1">headers </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">KeyError</span>
    <span class="s3">for </span><span class="s1">header</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">headers</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">header </span><span class="s4">== </span><span class="s1">name</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">value</span>
    <span class="s3">raise </span><span class="s1">KeyError</span>


<span class="s3">def </span><span class="s1">_check_status</span><span class="s4">(</span><span class="s1">headers</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">Headers</span><span class="s4">, </span><span class="s1">peer</span><span class="s4">: </span><span class="s1">str</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s1">value </span><span class="s4">= </span><span class="s1">_find_header</span><span class="s4">(</span><span class="s1">headers</span><span class="s4">, </span><span class="s7">b&quot;:status&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">value </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">SyntaxError</span><span class="s4">(</span><span class="s6">&quot;no :status header in response&quot;</span><span class="s4">)</span>
    <span class="s1">status </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">status </span><span class="s4">&lt; </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">SyntaxError</span><span class="s4">(</span><span class="s6">&quot;status is negative&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">status </span><span class="s4">&lt; </span><span class="s5">200 </span><span class="s3">or </span><span class="s1">status </span><span class="s4">&gt; </span><span class="s5">299</span><span class="s4">:</span>
        <span class="s1">error </span><span class="s4">= </span><span class="s6">&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">) &gt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">error </span><span class="s4">= </span><span class="s6">&quot;: &quot; </span><span class="s4">+ </span><span class="s1">wire</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>
            <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                <span class="s3">pass</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">peer</span><span class="s3">} </span><span class="s6">responded with status code </span><span class="s3">{</span><span class="s1">status</span><span class="s3">}{</span><span class="s1">error</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_http3</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">url</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">853</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">verify</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">hostname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">post</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s3">if not </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">have_quic</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">NoDOH</span><span class="s4">(</span><span class="s6">&quot;DNS-over-HTTP3 is not available.&quot;</span><span class="s4">)  </span><span class="s0"># pragma: no cover</span>

    <span class="s1">url_parts </span><span class="s4">= </span><span class="s1">urllib</span><span class="s4">.</span><span class="s1">parse</span><span class="s4">.</span><span class="s1">urlparse</span><span class="s4">(</span><span class="s1">url</span><span class="s4">)</span>
    <span class="s1">hostname </span><span class="s4">= </span><span class="s1">url_parts</span><span class="s4">.</span><span class="s1">hostname</span>
    <span class="s3">if </span><span class="s1">url_parts</span><span class="s4">.</span><span class="s1">port </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">port </span><span class="s4">= </span><span class="s1">url_parts</span><span class="s4">.</span><span class="s1">port</span>

    <span class="s1">q</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">manager </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">SyncQuicManager</span><span class="s4">(</span>
        <span class="s1">verify_mode</span><span class="s4">=</span><span class="s1">verify</span><span class="s4">, </span><span class="s1">server_name</span><span class="s4">=</span><span class="s1">hostname</span><span class="s4">, </span><span class="s1">h3</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>

    <span class="s3">with </span><span class="s1">manager</span><span class="s4">:</span>
        <span class="s1">connection </span><span class="s4">= </span><span class="s1">manager</span><span class="s4">.</span><span class="s1">connect</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">connection</span><span class="s4">.</span><span class="s1">make_stream</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">) </span><span class="s3">as </span><span class="s1">stream</span><span class="s4">:</span>
            <span class="s1">stream</span><span class="s4">.</span><span class="s1">send_h3</span><span class="s4">(</span><span class="s1">url</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">, </span><span class="s1">post</span><span class="s4">)</span>
            <span class="s1">wire </span><span class="s4">= </span><span class="s1">stream</span><span class="s4">.</span><span class="s1">receive</span><span class="s4">(</span><span class="s1">_remaining</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">))</span>
            <span class="s1">_check_status</span><span class="s4">(</span><span class="s1">stream</span><span class="s4">.</span><span class="s1">headers</span><span class="s4">(), </span><span class="s1">where</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">)</span>
        <span class="s1">finish </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
        <span class="s1">wire</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
        <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">request_mac</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s1">ignore_trailing</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">finish </span><span class="s4">- </span><span class="s1">start</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">)</span>
    <span class="s3">if not </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">BadResponse</span>
    <span class="s3">return </span><span class="s1">r</span>


<span class="s3">def </span><span class="s1">_udp_recv</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">max_size</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Reads a datagram from the socket. 
    A Timeout exception will be raised if the operation is not completed 
    by the expiration time. 
    &quot;&quot;&quot;</span>
    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recvfrom</span><span class="s4">(</span><span class="s1">max_size</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">BlockingIOError</span><span class="s4">:</span>
            <span class="s1">_wait_for_readable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_udp_send</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Sends the specified datagram to destination over the socket. 
    A Timeout exception will be raised if the operation is not completed 
    by the expiration time. 
    &quot;&quot;&quot;</span>
    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">destination</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">sendto</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">BlockingIOError</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">send_udp</span><span class="s4">(</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">what</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">],</span>
    <span class="s1">destination</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Send a DNS message to the specified UDP socket. 
 
    *sock*, a ``socket``. 
 
    *what*, a ``bytes`` or ``dns.message.Message``, the message to send. 
 
    *destination*, a destination tuple appropriate for the address family 
    of the socket, specifying where to send the query. 
 
    *expiration*, a ``float`` or ``None``, the absolute time at which 
    a timeout exception should be raised.  If ``None``, no timeout will 
    occur. 
 
    Returns an ``(int, float)`` tuple of bytes sent and the sent time. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">what</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">):</span>
        <span class="s1">what </span><span class="s4">= </span><span class="s1">what</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">sent_time </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">n </span><span class="s4">= </span><span class="s1">_udp_send</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">what</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">n</span><span class="s4">, </span><span class="s1">sent_time</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">receive_udp</span><span class="s4">(</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">destination</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">ignore_unexpected</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">request_mac</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s7">b&quot;&quot;</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">raise_on_truncation</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_errors</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">query</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Read a DNS message from a UDP socket. 
 
    *sock*, a ``socket``. 
 
    *destination*, a destination tuple appropriate for the address family 
    of the socket, specifying where the message is expected to arrive from. 
    When receiving a response, this would be where the associated query was 
    sent. 
 
    *expiration*, a ``float`` or ``None``, the absolute time at which 
    a timeout exception should be raised.  If ``None``, no timeout will 
    occur. 
 
    *ignore_unexpected*, a ``bool``.  If ``True``, ignore responses from 
    unexpected sources. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own 
    RRset. 
 
    *keyring*, a ``dict``, the keyring to use for TSIG. 
 
    *request_mac*, a ``bytes`` or ``None``, the MAC of the request (for TSIG). 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing 
    junk at end of the received message. 
 
    *raise_on_truncation*, a ``bool``.  If ``True``, raise an exception if 
    the TC bit is set. 
 
    Raises if the message is malformed, if network errors occur, of if 
    there is a timeout. 
 
    If *destination* is not ``None``, returns a ``(dns.message.Message, float)`` 
    tuple of the received message and the received time. 
 
    If *destination* is ``None``, returns a 
    ``(dns.message.Message, float, tuple)`` 
    tuple of the received message, the received time, and the address where 
    the message arrived from. 
 
    *ignore_errors*, a ``bool``.  If various format errors or response 
    mismatches occur, ignore them and keep listening for a valid response. 
    The default is ``False``. 
 
    *query*, a ``dns.message.Message`` or ``None``.  If not ``None`` and 
    *ignore_errors* is ``True``, check that the received message is a response 
    to this query, and if not keep listening for a valid response. 
    &quot;&quot;&quot;</span>

    <span class="s1">wire </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s4">(</span><span class="s1">wire</span><span class="s4">, </span><span class="s1">from_address</span><span class="s4">) = </span><span class="s1">_udp_recv</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s5">65535</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">_matches_destination</span><span class="s4">(</span>
            <span class="s1">sock</span><span class="s4">.</span><span class="s1">family</span><span class="s4">, </span><span class="s1">from_address</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">ignore_unexpected</span>
        <span class="s4">):</span>
            <span class="s3">continue</span>
        <span class="s1">received_time </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
                <span class="s1">wire</span><span class="s4">,</span>
                <span class="s1">keyring</span><span class="s4">=</span><span class="s1">keyring</span><span class="s4">,</span>
                <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">request_mac</span><span class="s4">,</span>
                <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
                <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s1">ignore_trailing</span><span class="s4">,</span>
                <span class="s1">raise_on_truncation</span><span class="s4">=</span><span class="s1">raise_on_truncation</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Truncated </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s0"># If we got Truncated and not FORMERR, we at least got the header with TC</span>
            <span class="s0"># set, and very likely the question section, so we'll re-raise if the</span>
            <span class="s0"># message seems to be a response as we need to know when truncation happens.</span>
            <span class="s0"># We need to check that it seems to be a response as we don't want a random</span>
            <span class="s0"># injected message with TC set to cause us to bail out.</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">ignore_errors</span>
                <span class="s3">and </span><span class="s1">query </span><span class="s3">is not None</span>
                <span class="s3">and not </span><span class="s1">query</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">message</span><span class="s4">())</span>
            <span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">ignore_errors</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise</span>
        <span class="s3">if </span><span class="s1">ignore_errors </span><span class="s3">and </span><span class="s1">query </span><span class="s3">is not None and not </span><span class="s1">query</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
            <span class="s3">continue</span>
        <span class="s3">if </span><span class="s1">destination</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">, </span><span class="s1">from_address</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">udp</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">53</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">ignore_unexpected</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">raise_on_truncation</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">ignore_errors</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the response obtained after sending a query via UDP. 
 
    *q*, a ``dns.message.Message``, the query to send 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address,  where 
    to send the message. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the 
    query times out.  If ``None``, the default, wait forever. 
 
    *port*, an ``int``, the port send the message to.  The default is 53. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying 
    the source address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. 
    The default is 0. 
 
    *ignore_unexpected*, a ``bool``.  If ``True``, ignore responses from 
    unexpected sources. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own 
    RRset. 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing 
    junk at end of the received message. 
 
    *raise_on_truncation*, a ``bool``.  If ``True``, raise an exception if 
    the TC bit is set. 
 
    *sock*, a ``socket.socket``, or ``None``, the socket to use for the 
    query.  If ``None``, the default, a socket is created.  Note that 
    if a socket is provided, it must be a nonblocking datagram socket, 
    and the *source* and *source_port* are ignored. 
 
    *ignore_errors*, a ``bool``.  If various format errors or response 
    mismatches occur, ignore them and keep listening for a valid response. 
    The default is ``False``. 
 
    Returns a ``dns.message.Message``. 
    &quot;&quot;&quot;</span>

    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
        <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span>
    <span class="s4">)</span>
    <span class="s4">(</span><span class="s1">begin_time</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">sock</span><span class="s4">:</span>
        <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">cm </span><span class="s4">= </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM</span><span class="s4">, </span><span class="s1">source</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s1">send_udp</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">) = </span><span class="s1">receive_udp</span><span class="s4">(</span>
            <span class="s1">s</span><span class="s4">,</span>
            <span class="s1">destination</span><span class="s4">,</span>
            <span class="s1">expiration</span><span class="s4">,</span>
            <span class="s1">ignore_unexpected</span><span class="s4">,</span>
            <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
            <span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
            <span class="s1">q</span><span class="s4">.</span><span class="s1">mac</span><span class="s4">,</span>
            <span class="s1">ignore_trailing</span><span class="s4">,</span>
            <span class="s1">raise_on_truncation</span><span class="s4">,</span>
            <span class="s1">ignore_errors</span><span class="s4">,</span>
            <span class="s1">q</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">received_time </span><span class="s4">- </span><span class="s1">begin_time</span>
        <span class="s0"># We don't need to check q.is_response() if we are in ignore_errors mode</span>
        <span class="s0"># as receive_udp() will have checked it.</span>
        <span class="s3">if not </span><span class="s4">(</span><span class="s1">ignore_errors </span><span class="s3">or </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">)):</span>
            <span class="s3">raise </span><span class="s1">BadResponse</span>
        <span class="s3">return </span><span class="s1">r</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s3">False  </span><span class="s0"># help mypy figure out we can't get here  lgtm[py/unreachable-statement]</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">udp_with_fallback</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">53</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">ignore_unexpected</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">udp_sock</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">tcp_sock</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">ignore_errors</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Return the response to the query, trying UDP first and falling back 
    to TCP if UDP results in a truncated response. 
 
    *q*, a ``dns.message.Message``, the query to send 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address,  where to send the message. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the query 
    times out.  If ``None``, the default, wait forever. 
 
    *port*, an ``int``, the port send the message to.  The default is 53. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying the source 
    address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. The default is 
    0. 
 
    *ignore_unexpected*, a ``bool``.  If ``True``, ignore responses from unexpected 
    sources. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own RRset. 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing junk at end of the 
    received message. 
 
    *udp_sock*, a ``socket.socket``, or ``None``, the socket to use for the UDP query. 
    If ``None``, the default, a socket is created.  Note that if a socket is provided, 
    it must be a nonblocking datagram socket, and the *source* and *source_port* are 
    ignored for the UDP query. 
 
    *tcp_sock*, a ``socket.socket``, or ``None``, the connected socket to use for the 
    TCP query.  If ``None``, the default, a socket is created.  Note that if a socket is 
    provided, it must be a nonblocking connected stream socket, and *where*, *source* 
    and *source_port* are ignored for the TCP query. 
 
    *ignore_errors*, a ``bool``.  If various format errors or response mismatches occur 
    while listening for UDP, ignore them and keep listening for a valid response. The 
    default is ``False``. 
 
    Returns a (``dns.message.Message``, tcp) tuple where tcp is ``True`` if and only if 
    TCP was used. 
    &quot;&quot;&quot;</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s1">udp</span><span class="s4">(</span>
            <span class="s1">q</span><span class="s4">,</span>
            <span class="s1">where</span><span class="s4">,</span>
            <span class="s1">timeout</span><span class="s4">,</span>
            <span class="s1">port</span><span class="s4">,</span>
            <span class="s1">source</span><span class="s4">,</span>
            <span class="s1">source_port</span><span class="s4">,</span>
            <span class="s1">ignore_unexpected</span><span class="s4">,</span>
            <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
            <span class="s1">ignore_trailing</span><span class="s4">,</span>
            <span class="s3">True</span><span class="s4">,</span>
            <span class="s1">udp_sock</span><span class="s4">,</span>
            <span class="s1">ignore_errors</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Truncated</span><span class="s4">:</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s1">tcp</span><span class="s4">(</span>
            <span class="s1">q</span><span class="s4">,</span>
            <span class="s1">where</span><span class="s4">,</span>
            <span class="s1">timeout</span><span class="s4">,</span>
            <span class="s1">port</span><span class="s4">,</span>
            <span class="s1">source</span><span class="s4">,</span>
            <span class="s1">source_port</span><span class="s4">,</span>
            <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
            <span class="s1">ignore_trailing</span><span class="s4">,</span>
            <span class="s1">tcp_sock</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_net_read</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Read the specified number of bytes from sock.  Keep trying until we 
    either get the desired amount, or we hit EOF. 
    A Timeout exception will be raised if the operation is not completed 
    by the expiration time. 
    &quot;&quot;&quot;</span>
    <span class="s1">s </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
    <span class="s3">while </span><span class="s1">count </span><span class="s4">&gt; </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">n </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">(</span><span class="s1">count</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">n </span><span class="s4">== </span><span class="s7">b&quot;&quot;</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">EOFError</span><span class="s4">(</span><span class="s6">&quot;EOF&quot;</span><span class="s4">)</span>
            <span class="s1">count </span><span class="s4">-= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">n</span><span class="s4">)</span>
            <span class="s1">s </span><span class="s4">+= </span><span class="s1">n</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">BlockingIOError</span><span class="s4">, </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantReadError</span><span class="s4">):</span>
            <span class="s1">_wait_for_readable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantWriteError</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">s</span>


<span class="s3">def </span><span class="s1">_net_write</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Write the specified data to the socket. 
    A Timeout exception will be raised if the operation is not completed 
    by the expiration time. 
    &quot;&quot;&quot;</span>
    <span class="s1">current </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">l </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>
    <span class="s3">while </span><span class="s1">current </span><span class="s4">&lt; </span><span class="s1">l</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">current </span><span class="s4">+= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">data</span><span class="s4">[</span><span class="s1">current</span><span class="s4">:])</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">BlockingIOError</span><span class="s4">, </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantWriteError</span><span class="s4">):</span>
            <span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantReadError</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s1">_wait_for_readable</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">send_tcp</span><span class="s4">(</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">what</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">],</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Send a DNS message to the specified TCP socket. 
 
    *sock*, a ``socket``. 
 
    *what*, a ``bytes`` or ``dns.message.Message``, the message to send. 
 
    *expiration*, a ``float`` or ``None``, the absolute time at which 
    a timeout exception should be raised.  If ``None``, no timeout will 
    occur. 
 
    Returns an ``(int, float)`` tuple of bytes sent and the sent time. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">what</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">):</span>
        <span class="s1">tcpmsg </span><span class="s4">= </span><span class="s1">what</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">(</span><span class="s1">prepend_length</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s0"># copying the wire into tcpmsg is inefficient, but lets us</span>
        <span class="s0"># avoid writev() or doing a short write that would get pushed</span>
        <span class="s0"># onto the net</span>
        <span class="s1">tcpmsg </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">what</span><span class="s4">).</span><span class="s1">to_bytes</span><span class="s4">(</span><span class="s5">2</span><span class="s4">, </span><span class="s6">&quot;big&quot;</span><span class="s4">) + </span><span class="s1">what</span>
    <span class="s1">sent_time </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">_net_write</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">tcpmsg</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">tcpmsg</span><span class="s4">), </span><span class="s1">sent_time</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">receive_tcp</span><span class="s4">(</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">request_mac</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s7">b&quot;&quot;</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]:</span>
    <span class="s2">&quot;&quot;&quot;Read a DNS message from a TCP socket. 
 
    *sock*, a ``socket``. 
 
    *expiration*, a ``float`` or ``None``, the absolute time at which 
    a timeout exception should be raised.  If ``None``, no timeout will 
    occur. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own 
    RRset. 
 
    *keyring*, a ``dict``, the keyring to use for TSIG. 
 
    *request_mac*, a ``bytes`` or ``None``, the MAC of the request (for TSIG). 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing 
    junk at end of the received message. 
 
    Raises if the message is malformed, if network errors occur, of if 
    there is a timeout. 
 
    Returns a ``(dns.message.Message, float)`` tuple of the received message 
    and the received time. 
    &quot;&quot;&quot;</span>

    <span class="s1">ldata </span><span class="s4">= </span><span class="s1">_net_read</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s4">(</span><span class="s1">l</span><span class="s4">,) = </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;!H&quot;</span><span class="s4">, </span><span class="s1">ldata</span><span class="s4">)</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">_net_read</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">, </span><span class="s1">l</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s1">received_time </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
        <span class="s1">wire</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">=</span><span class="s1">keyring</span><span class="s4">,</span>
        <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">request_mac</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s1">ignore_trailing</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">return </span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">address</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s1">err </span><span class="s4">= </span><span class="s1">s</span><span class="s4">.</span><span class="s1">connect_ex</span><span class="s4">(</span><span class="s1">address</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">err </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">return</span>
    <span class="s3">if </span><span class="s1">err </span><span class="s3">in </span><span class="s4">(</span><span class="s1">errno</span><span class="s4">.</span><span class="s1">EINPROGRESS</span><span class="s4">, </span><span class="s1">errno</span><span class="s4">.</span><span class="s1">EWOULDBLOCK</span><span class="s4">, </span><span class="s1">errno</span><span class="s4">.</span><span class="s1">EALREADY</span><span class="s4">):</span>
        <span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s1">err </span><span class="s4">= </span><span class="s1">s</span><span class="s4">.</span><span class="s1">getsockopt</span><span class="s4">(</span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOL_SOCKET</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SO_ERROR</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">err </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">OSError</span><span class="s4">(</span><span class="s1">err</span><span class="s4">, </span><span class="s1">os</span><span class="s4">.</span><span class="s1">strerror</span><span class="s4">(</span><span class="s1">err</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">tcp</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">53</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the response obtained after sending a query via TCP. 
 
    *q*, a ``dns.message.Message``, the query to send 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address, where 
    to send the message. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the 
    query times out.  If ``None``, the default, wait forever. 
 
    *port*, an ``int``, the port send the message to.  The default is 53. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying 
    the source address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. 
    The default is 0. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own 
    RRset. 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing 
    junk at end of the received message. 
 
    *sock*, a ``socket.socket``, or ``None``, the connected socket to use for the 
    query.  If ``None``, the default, a socket is created.  Note that 
    if a socket is provided, it must be a nonblocking connected stream 
    socket, and *where*, *port*, *source* and *source_port* are ignored. 
 
    Returns a ``dns.message.Message``. 
    &quot;&quot;&quot;</span>

    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s4">(</span><span class="s1">begin_time</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">sock</span><span class="s4">:</span>
        <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">sock</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
            <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span>
        <span class="s4">)</span>
        <span class="s1">cm </span><span class="s4">= </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">source</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">sock</span><span class="s4">:</span>
            <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
            <span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s1">send_tcp</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">) = </span><span class="s1">receive_tcp</span><span class="s4">(</span>
            <span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">, </span><span class="s1">one_rr_per_rrset</span><span class="s4">, </span><span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">, </span><span class="s1">q</span><span class="s4">.</span><span class="s1">mac</span><span class="s4">, </span><span class="s1">ignore_trailing</span>
        <span class="s4">)</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">received_time </span><span class="s4">- </span><span class="s1">begin_time</span>
        <span class="s3">if not </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">BadResponse</span>
        <span class="s3">return </span><span class="s1">r</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s3">False  </span><span class="s0"># help mypy figure out we can't get here  lgtm[py/unreachable-statement]</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">_tls_handshake</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">do_handshake</span><span class="s4">()</span>
            <span class="s3">return</span>
        <span class="s3">except </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantReadError</span><span class="s4">:</span>
            <span class="s1">_wait_for_readable</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLWantWriteError</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
            <span class="s1">_wait_for_writable</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_make_dot_ssl_context</span><span class="s4">(</span>
    <span class="s1">server_hostname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">verify</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]</span>
<span class="s4">) </span><span class="s1">-&gt; ssl</span><span class="s4">.</span><span class="s1">SSLContext</span><span class="s4">:</span>
    <span class="s1">cafile</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s1">capath</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">verify</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isfile</span><span class="s4">(</span><span class="s1">verify</span><span class="s4">):</span>
            <span class="s1">cafile </span><span class="s4">= </span><span class="s1">verify</span>
        <span class="s3">elif </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">isdir</span><span class="s4">(</span><span class="s1">verify</span><span class="s4">):</span>
            <span class="s1">capath </span><span class="s4">= </span><span class="s1">verify</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">&quot;invalid verify string&quot;</span><span class="s4">)</span>
    <span class="s1">ssl_context </span><span class="s4">= </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">create_default_context</span><span class="s4">(</span><span class="s1">cafile</span><span class="s4">=</span><span class="s1">cafile</span><span class="s4">, </span><span class="s1">capath</span><span class="s4">=</span><span class="s1">capath</span><span class="s4">)</span>
    <span class="s1">ssl_context</span><span class="s4">.</span><span class="s1">minimum_version </span><span class="s4">= </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">TLSVersion</span><span class="s4">.</span><span class="s1">TLSv1_2</span>
    <span class="s3">if </span><span class="s1">server_hostname </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">ssl_context</span><span class="s4">.</span><span class="s1">check_hostname </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">ssl_context</span><span class="s4">.</span><span class="s1">set_alpn_protocols</span><span class="s4">([</span><span class="s6">&quot;dot&quot;</span><span class="s4">])</span>
    <span class="s3">if </span><span class="s1">verify </span><span class="s3">is False</span><span class="s4">:</span>
        <span class="s1">ssl_context</span><span class="s4">.</span><span class="s1">verify_mode </span><span class="s4">= </span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">CERT_NONE</span>
    <span class="s3">return </span><span class="s1">ssl_context</span>


<span class="s3">def </span><span class="s1">tls</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">853</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">sock</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLSocket</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">ssl_context</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">ssl</span><span class="s4">.</span><span class="s1">SSLContext</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">server_hostname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">verify</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">True</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the response obtained after sending a query via TLS. 
 
    *q*, a ``dns.message.Message``, the query to send 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address,  where 
    to send the message. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the 
    query times out.  If ``None``, the default, wait forever. 
 
    *port*, an ``int``, the port send the message to.  The default is 853. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying 
    the source address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. 
    The default is 0. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own 
    RRset. 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing 
    junk at end of the received message. 
 
    *sock*, an ``ssl.SSLSocket``, or ``None``, the socket to use for 
    the query.  If ``None``, the default, a socket is created.  Note 
    that if a socket is provided, it must be a nonblocking connected 
    SSL stream socket, and *where*, *port*, *source*, *source_port*, 
    and *ssl_context* are ignored. 
 
    *ssl_context*, an ``ssl.SSLContext``, the context to use when establishing 
    a TLS connection. If ``None``, the default, creates one with the default 
    configuration. 
 
    *server_hostname*, a ``str`` containing the server's hostname.  The 
    default is ``None``, which means that no hostname is known, and if an 
    SSL context is created, hostname checking will be disabled. 
 
    *verify*, a ``bool`` or ``str``.  If a ``True``, then TLS certificate verification 
    of the server is done using the default CA bundle; if ``False``, then no 
    verification is done; if a `str` then it specifies the path to a certificate file or 
    directory which will be used for verification. 
 
    Returns a ``dns.message.Message``. 
 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">sock</span><span class="s4">:</span>
        <span class="s0">#</span>
        <span class="s0"># If a socket was provided, there's no special TLS handling needed.</span>
        <span class="s0">#</span>
        <span class="s3">return </span><span class="s1">tcp</span><span class="s4">(</span>
            <span class="s1">q</span><span class="s4">,</span>
            <span class="s1">where</span><span class="s4">,</span>
            <span class="s1">timeout</span><span class="s4">,</span>
            <span class="s1">port</span><span class="s4">,</span>
            <span class="s1">source</span><span class="s4">,</span>
            <span class="s1">source_port</span><span class="s4">,</span>
            <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
            <span class="s1">ignore_trailing</span><span class="s4">,</span>
            <span class="s1">sock</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s4">(</span><span class="s1">begin_time</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
    <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
        <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span>
    <span class="s4">)</span>
    <span class="s3">if </span><span class="s1">ssl_context </span><span class="s3">is None and not </span><span class="s1">sock</span><span class="s4">:</span>
        <span class="s1">ssl_context </span><span class="s4">= </span><span class="s1">_make_dot_ssl_context</span><span class="s4">(</span><span class="s1">server_hostname</span><span class="s4">, </span><span class="s1">verify</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">_make_socket</span><span class="s4">(</span>
        <span class="s1">af</span><span class="s4">,</span>
        <span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">,</span>
        <span class="s1">source</span><span class="s4">,</span>
        <span class="s1">ssl_context</span><span class="s4">=</span><span class="s1">ssl_context</span><span class="s4">,</span>
        <span class="s1">server_hostname</span><span class="s4">=</span><span class="s1">server_hostname</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s1">_tls_handshake</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s1">send_tcp</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">received_time</span><span class="s4">) = </span><span class="s1">receive_tcp</span><span class="s4">(</span>
            <span class="s1">s</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">, </span><span class="s1">one_rr_per_rrset</span><span class="s4">, </span><span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">, </span><span class="s1">q</span><span class="s4">.</span><span class="s1">mac</span><span class="s4">, </span><span class="s1">ignore_trailing</span>
        <span class="s4">)</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">received_time </span><span class="s4">- </span><span class="s1">begin_time</span>
        <span class="s3">if not </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">BadResponse</span>
        <span class="s3">return </span><span class="s1">r</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s3">False  </span><span class="s0"># help mypy figure out we can't get here  lgtm[py/unreachable-statement]</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">quic</span><span class="s4">(</span>
    <span class="s1">q</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">853</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">connection</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">SyncQuicConnection</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">verify</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">bool</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">hostname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">server_hostname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the response obtained after sending a query via DNS-over-QUIC. 
 
    *q*, a ``dns.message.Message``, the query to send. 
 
    *where*, a ``str``, the nameserver IP address. 
 
    *timeout*, a ``float`` or ``None``, the number of seconds to wait before the query 
    times out. If ``None``, the default, wait forever. 
 
    *port*, a ``int``, the port to send the query to. The default is 853. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying the source 
    address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. The default is 
    0. 
 
    *one_rr_per_rrset*, a ``bool``. If ``True``, put each RR into its own RRset. 
 
    *ignore_trailing*, a ``bool``. If ``True``, ignore trailing junk at end of the 
    received message. 
 
    *connection*, a ``dns.quic.SyncQuicConnection``.  If provided, the connection to use 
    to send the query. 
 
    *verify*, a ``bool`` or ``str``.  If a ``True``, then TLS certificate verification 
    of the server is done using the default CA bundle; if ``False``, then no 
    verification is done; if a `str` then it specifies the path to a certificate file or 
    directory which will be used for verification. 
 
    *hostname*, a ``str`` containing the server's hostname or ``None``.  The default is 
    ``None``, which means that no hostname is known, and if an SSL context is created, 
    hostname checking will be disabled.  This value is ignored if *url* is not 
    ``None``. 
 
    *server_hostname*, a ``str`` or ``None``.  This item is for backwards compatibility 
    only, and has the same meaning as *hostname*. 
 
    Returns a ``dns.message.Message``. 
    &quot;&quot;&quot;</span>

    <span class="s3">if not </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">have_quic</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">NoDOQ</span><span class="s4">(</span><span class="s6">&quot;DNS-over-QUIC is not available.&quot;</span><span class="s4">)  </span><span class="s0"># pragma: no cover</span>

    <span class="s3">if </span><span class="s1">server_hostname </span><span class="s3">is not None and </span><span class="s1">hostname </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">hostname </span><span class="s4">= </span><span class="s1">server_hostname</span>

    <span class="s1">q</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">the_connection</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">SyncQuicConnection</span>
    <span class="s1">the_manager</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">SyncQuicManager</span>
    <span class="s3">if </span><span class="s1">connection</span><span class="s4">:</span>
        <span class="s1">manager</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">the_connection </span><span class="s4">= </span><span class="s1">connection</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">manager </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">quic</span><span class="s4">.</span><span class="s1">SyncQuicManager</span><span class="s4">(</span><span class="s1">verify_mode</span><span class="s4">=</span><span class="s1">verify</span><span class="s4">, </span><span class="s1">server_name</span><span class="s4">=</span><span class="s1">hostname</span><span class="s4">)</span>
        <span class="s1">the_manager </span><span class="s4">= </span><span class="s1">manager  </span><span class="s0"># for type checking happiness</span>

    <span class="s3">with </span><span class="s1">manager</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">connection</span><span class="s4">:</span>
            <span class="s1">the_connection </span><span class="s4">= </span><span class="s1">the_manager</span><span class="s4">.</span><span class="s1">connect</span><span class="s4">(</span><span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">the_connection</span><span class="s4">.</span><span class="s1">make_stream</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">) </span><span class="s3">as </span><span class="s1">stream</span><span class="s4">:</span>
            <span class="s1">stream</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
            <span class="s1">wire </span><span class="s4">= </span><span class="s1">stream</span><span class="s4">.</span><span class="s1">receive</span><span class="s4">(</span><span class="s1">_remaining</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">))</span>
        <span class="s1">finish </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
        <span class="s1">wire</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
        <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">q</span><span class="s4">.</span><span class="s1">request_mac</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s1">ignore_trailing</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">r</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">finish </span><span class="s4">- </span><span class="s1">start</span><span class="s4">, </span><span class="s5">0.0</span><span class="s4">)</span>
    <span class="s3">if not </span><span class="s1">q</span><span class="s4">.</span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">r</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">BadResponse</span>
    <span class="s3">return </span><span class="s1">r</span>


<span class="s3">class </span><span class="s1">UDPMode</span><span class="s4">(</span><span class="s1">enum</span><span class="s4">.</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;How should UDP be used in an IXFR from :py:func:`inbound_xfr()`? 
 
    NEVER means &quot;never use UDP; always use TCP&quot; 
    TRY_FIRST means &quot;try to use UDP but fall back to TCP if needed&quot; 
    ONLY means &quot;raise ``dns.xfr.UseTCP`` if trying UDP does not succeed&quot; 
    &quot;&quot;&quot;</span>

    <span class="s1">NEVER </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">TRY_FIRST </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">ONLY </span><span class="s4">= </span><span class="s5">2</span>


<span class="s3">def </span><span class="s1">_inbound_xfr</span><span class="s4">(</span>
    <span class="s1">txn_manager</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">TransactionManager</span><span class="s4">,</span>
    <span class="s1">s</span><span class="s4">: </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">socket</span><span class="s4">,</span>
    <span class="s1">query</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">serial</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">],</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">],</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">float</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Given a socket, does the zone transfer.&quot;&quot;&quot;</span>
    <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">query</span><span class="s4">.</span><span class="s1">question</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">rdtype</span>
    <span class="s1">is_ixfr </span><span class="s4">= </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">IXFR</span>
    <span class="s1">origin </span><span class="s4">= </span><span class="s1">txn_manager</span><span class="s4">.</span><span class="s1">from_wire_origin</span><span class="s4">()</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">query</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">is_udp </span><span class="s4">= </span><span class="s1">s</span><span class="s4">.</span><span class="s1">type </span><span class="s4">== </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM</span>
    <span class="s3">if </span><span class="s1">is_udp</span><span class="s4">:</span>
        <span class="s1">_udp_send</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">wire</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">tcpmsg </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;!H&quot;</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">)) + </span><span class="s1">wire</span>
        <span class="s1">_net_write</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">tcpmsg</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span><span class="s4">.</span><span class="s1">Inbound</span><span class="s4">(</span><span class="s1">txn_manager</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">serial</span><span class="s4">, </span><span class="s1">is_udp</span><span class="s4">) </span><span class="s3">as </span><span class="s1">inbound</span><span class="s4">:</span>
        <span class="s1">done </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">tsig_ctx </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">while not </span><span class="s1">done</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">_</span><span class="s4">, </span><span class="s1">mexpiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">timeout</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">mexpiration </span><span class="s3">is None or </span><span class="s4">(</span>
                <span class="s1">expiration </span><span class="s3">is not None and </span><span class="s1">mexpiration </span><span class="s4">&gt; </span><span class="s1">expiration</span>
            <span class="s4">):</span>
                <span class="s1">mexpiration </span><span class="s4">= </span><span class="s1">expiration</span>
            <span class="s3">if </span><span class="s1">is_udp</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">rwire</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">_udp_recv</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s5">65535</span><span class="s4">, </span><span class="s1">mexpiration</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">ldata </span><span class="s4">= </span><span class="s1">_net_read</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">mexpiration</span><span class="s4">)</span>
                <span class="s4">(</span><span class="s1">l</span><span class="s4">,) = </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;!H&quot;</span><span class="s4">, </span><span class="s1">ldata</span><span class="s4">)</span>
                <span class="s1">rwire </span><span class="s4">= </span><span class="s1">_net_read</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">l</span><span class="s4">, </span><span class="s1">mexpiration</span><span class="s4">)</span>
            <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
                <span class="s1">rwire</span><span class="s4">,</span>
                <span class="s1">keyring</span><span class="s4">=</span><span class="s1">query</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
                <span class="s1">request_mac</span><span class="s4">=</span><span class="s1">query</span><span class="s4">.</span><span class="s1">mac</span><span class="s4">,</span>
                <span class="s1">xfr</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s1">origin</span><span class="s4">=</span><span class="s1">origin</span><span class="s4">,</span>
                <span class="s1">tsig_ctx</span><span class="s4">=</span><span class="s1">tsig_ctx</span><span class="s4">,</span>
                <span class="s1">multi</span><span class="s4">=(</span><span class="s3">not </span><span class="s1">is_udp</span><span class="s4">),</span>
                <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s1">is_ixfr</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s1">done </span><span class="s4">= </span><span class="s1">inbound</span><span class="s4">.</span><span class="s1">process_message</span><span class="s4">(</span><span class="s1">r</span><span class="s4">)</span>
            <span class="s3">yield </span><span class="s1">r</span>
            <span class="s1">tsig_ctx </span><span class="s4">= </span><span class="s1">r</span><span class="s4">.</span><span class="s1">tsig_ctx</span>
        <span class="s3">if </span><span class="s1">query</span><span class="s4">.</span><span class="s1">keyring </span><span class="s3">and not </span><span class="s1">r</span><span class="s4">.</span><span class="s1">had_tsig</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">(</span><span class="s6">&quot;missing TSIG&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">xfr</span><span class="s4">(</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">zone</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">AXFR</span><span class="s4">,</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">53</span><span class="s4">,</span>
    <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">keyname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">relativize</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">serial</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">use_udp</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">keyalgorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">default_algorithm</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return a generator for the responses to a zone transfer. 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address,  where 
    to send the message. 
 
    *zone*, a ``dns.name.Name`` or ``str``, the name of the zone to transfer. 
 
    *rdtype*, an ``int`` or ``str``, the type of zone transfer.  The 
    default is ``dns.rdatatype.AXFR``.  ``dns.rdatatype.IXFR`` can be 
    used to do an incremental transfer instead. 
 
    *rdclass*, an ``int`` or ``str``, the class of the zone transfer. 
    The default is ``dns.rdataclass.IN``. 
 
    *timeout*, a ``float``, the number of seconds to wait for each 
    response message.  If None, the default, wait forever. 
 
    *port*, an ``int``, the port send the message to.  The default is 53. 
 
    *keyring*, a ``dict``, the keyring to use for TSIG. 
 
    *keyname*, a ``dns.name.Name`` or ``str``, the name of the TSIG 
    key to use. 
 
    *relativize*, a ``bool``.  If ``True``, all names in the zone will be 
    relativized to the zone origin.  It is essential that the 
    relativize setting matches the one specified to 
    ``dns.zone.from_xfr()`` if using this generator to make a zone. 
 
    *lifetime*, a ``float``, the total number of seconds to spend 
    doing the transfer.  If ``None``, the default, then there is no 
    limit on the time the transfer may take. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying 
    the source address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. 
    The default is 0. 
 
    *serial*, an ``int``, the SOA serial number to use as the base for 
    an IXFR diff sequence (only meaningful if *rdtype* is 
    ``dns.rdatatype.IXFR``). 
 
    *use_udp*, a ``bool``.  If ``True``, use UDP (only meaningful for IXFR). 
 
    *keyalgorithm*, a ``dns.name.Name`` or ``str``, the TSIG algorithm to use. 
 
    Raises on errors, and so does the generator. 
 
    Returns a generator of ``dns.message.Message`` objects. 
    &quot;&quot;&quot;</span>

    <span class="s3">class </span><span class="s1">DummyTransactionManager</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">TransactionManager</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">, </span><span class="s1">relativize</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">info </span><span class="s4">= (</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">relativize</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">empty </span><span class="s3">if </span><span class="s1">relativize </span><span class="s3">else </span><span class="s1">origin</span><span class="s4">)</span>

        <span class="s3">def </span><span class="s1">origin_information</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">info</span>

        <span class="s3">def </span><span class="s1">get_class</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">reader</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError  </span><span class="s0"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">writer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">replacement</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">:</span>
            <span class="s3">class </span><span class="s1">DummyTransaction</span><span class="s4">:</span>
                <span class="s3">def </span><span class="s1">nop</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">):</span>
                    <span class="s3">pass</span>

                <span class="s3">def </span><span class="s1">__getattr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">):</span>
                    <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">nop</span>

            <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">, </span><span class="s1">DummyTransaction</span><span class="s4">())</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">zone </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">)</span>
    <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdtype</span><span class="s4">)</span>
    <span class="s1">q </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">make_query</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">IXFR</span><span class="s4">:</span>
        <span class="s1">rrset </span><span class="s4">= </span><span class="s1">q</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
            <span class="s1">q</span><span class="s4">.</span><span class="s1">authority</span><span class="s4">, </span><span class="s1">zone</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA</span><span class="s4">, </span><span class="s1">create</span><span class="s4">=</span><span class="s3">True</span>
        <span class="s4">)</span>
        <span class="s1">soa </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s6">&quot;IN&quot;</span><span class="s4">, </span><span class="s6">&quot;SOA&quot;</span><span class="s4">, </span><span class="s6">&quot;. . %u 0 0 0 0&quot; </span><span class="s4">% </span><span class="s1">serial</span><span class="s4">)</span>
        <span class="s1">rrset</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">soa</span><span class="s4">, </span><span class="s5">0</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">keyring </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">q</span><span class="s4">.</span><span class="s1">use_tsig</span><span class="s4">(</span><span class="s1">keyring</span><span class="s4">, </span><span class="s1">keyname</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">=</span><span class="s1">keyalgorithm</span><span class="s4">)</span>
    <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
        <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span>
    <span class="s4">)</span>
    <span class="s4">(</span><span class="s1">_</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">lifetime</span><span class="s4">)</span>
    <span class="s1">tm </span><span class="s4">= </span><span class="s1">DummyTransactionManager</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">, </span><span class="s1">relativize</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">use_udp </span><span class="s3">and </span><span class="s1">rdtype </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">IXFR</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s6">&quot;cannot do a UDP AXFR&quot;</span><span class="s4">)</span>
    <span class="s1">sock_type </span><span class="s4">= </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM </span><span class="s3">if </span><span class="s1">use_udp </span><span class="s3">else </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span>
    <span class="s3">with </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">sock_type</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">yield from </span><span class="s1">_inbound_xfr</span><span class="s4">(</span><span class="s1">tm</span><span class="s4">, </span><span class="s1">s</span><span class="s4">, </span><span class="s1">q</span><span class="s4">, </span><span class="s1">serial</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">inbound_xfr</span><span class="s4">(</span>
    <span class="s1">where</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">txn_manager</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">TransactionManager</span><span class="s4">,</span>
    <span class="s1">query</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">Message</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">53</span><span class="s4">,</span>
    <span class="s1">timeout</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">source_port</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">udp_mode</span><span class="s4">: </span><span class="s1">UDPMode </span><span class="s4">= </span><span class="s1">UDPMode</span><span class="s4">.</span><span class="s1">NEVER</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Conduct an inbound transfer and apply it via a transaction from the 
    txn_manager. 
 
    *where*, a ``str`` containing an IPv4 or IPv6 address,  where 
    to send the message. 
 
    *txn_manager*, a ``dns.transaction.TransactionManager``, the txn_manager 
    for this transfer (typically a ``dns.zone.Zone``). 
 
    *query*, the query to send.  If not supplied, a default query is 
    constructed using information from the *txn_manager*. 
 
    *port*, an ``int``, the port send the message to.  The default is 53. 
 
    *timeout*, a ``float``, the number of seconds to wait for each 
    response message.  If None, the default, wait forever. 
 
    *lifetime*, a ``float``, the total number of seconds to spend 
    doing the transfer.  If ``None``, the default, then there is no 
    limit on the time the transfer may take. 
 
    *source*, a ``str`` containing an IPv4 or IPv6 address, specifying 
    the source address.  The default is the wildcard address. 
 
    *source_port*, an ``int``, the port from which to send the message. 
    The default is 0. 
 
    *udp_mode*, a ``dns.query.UDPMode``, determines how UDP is used 
    for IXFRs.  The default is ``dns.UDPMode.NEVER``, i.e. only use 
    TCP.  Other possibilities are ``dns.UDPMode.TRY_FIRST``, which 
    means &quot;try UDP but fallback to TCP if needed&quot;, and 
    ``dns.UDPMode.ONLY``, which means &quot;try UDP and raise 
    ``dns.xfr.UseTCP`` if it does not succeed. 
 
    Raises on errors. 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">query </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s4">(</span><span class="s1">query</span><span class="s4">, </span><span class="s1">serial</span><span class="s4">) = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span><span class="s4">.</span><span class="s1">make_query</span><span class="s4">(</span><span class="s1">txn_manager</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">serial </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span><span class="s4">.</span><span class="s1">extract_serial_from_query</span><span class="s4">(</span><span class="s1">query</span><span class="s4">)</span>

    <span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) = </span><span class="s1">_destination_and_source</span><span class="s4">(</span>
        <span class="s1">where</span><span class="s4">, </span><span class="s1">port</span><span class="s4">, </span><span class="s1">source</span><span class="s4">, </span><span class="s1">source_port</span>
    <span class="s4">)</span>
    <span class="s4">(</span><span class="s1">_</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">) = </span><span class="s1">_compute_times</span><span class="s4">(</span><span class="s1">lifetime</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">query</span><span class="s4">.</span><span class="s1">question</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">IXFR </span><span class="s3">and </span><span class="s1">udp_mode </span><span class="s4">!= </span><span class="s1">UDPMode</span><span class="s4">.</span><span class="s1">NEVER</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_DGRAM</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
            <span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">_inbound_xfr</span><span class="s4">(</span>
                    <span class="s1">txn_manager</span><span class="s4">, </span><span class="s1">s</span><span class="s4">, </span><span class="s1">query</span><span class="s4">, </span><span class="s1">serial</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">expiration</span>
                <span class="s4">):</span>
                    <span class="s3">pass</span>
                <span class="s3">return</span>
            <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">xfr</span><span class="s4">.</span><span class="s1">UseTCP</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">udp_mode </span><span class="s4">== </span><span class="s1">UDPMode</span><span class="s4">.</span><span class="s1">ONLY</span><span class="s4">:</span>
                    <span class="s3">raise</span>

    <span class="s3">with </span><span class="s1">_make_socket</span><span class="s4">(</span><span class="s1">af</span><span class="s4">, </span><span class="s1">socket</span><span class="s4">.</span><span class="s1">SOCK_STREAM</span><span class="s4">, </span><span class="s1">source</span><span class="s4">) </span><span class="s3">as </span><span class="s1">s</span><span class="s4">:</span>
        <span class="s1">_connect</span><span class="s4">(</span><span class="s1">s</span><span class="s4">, </span><span class="s1">destination</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">_inbound_xfr</span><span class="s4">(</span><span class="s1">txn_manager</span><span class="s4">, </span><span class="s1">s</span><span class="s4">, </span><span class="s1">query</span><span class="s4">, </span><span class="s1">serial</span><span class="s4">, </span><span class="s1">timeout</span><span class="s4">, </span><span class="s1">expiration</span><span class="s4">):</span>
            <span class="s3">pass</span>
</pre>
</body>
</html>