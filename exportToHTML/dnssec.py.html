<html>
<head>
<title>dnssec.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
dnssec.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (C) Dnspython Contributors, see LICENSE for text of ISC license</span>

<span class="s0"># Copyright (C) 2003-2017 Nominum, Inc.</span>
<span class="s0">#</span>
<span class="s0"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="s0"># documentation for any purpose with or without fee is hereby granted,</span>
<span class="s0"># provided that the above copyright notice and this permission notice</span>
<span class="s0"># appear in all copies.</span>
<span class="s0">#</span>
<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND NOMINUM DISCLAIMS ALL WARRANTIES</span>
<span class="s0"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="s0"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL NOMINUM BE LIABLE FOR</span>
<span class="s0"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="s0"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="s0"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="s0"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="s2">&quot;&quot;&quot;Common DNSSEC-related functions and constants.&quot;&quot;&quot;</span>


<span class="s3">import </span><span class="s1">base64</span>
<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">functools</span>
<span class="s3">import </span><span class="s1">hashlib</span>
<span class="s3">import </span><span class="s1">struct</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">from </span><span class="s1">datetime </span><span class="s3">import </span><span class="s1">datetime</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Callable</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Set</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">, </span><span class="s1">cast</span>

<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_features</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">node</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">zone</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">dnssectypes </span><span class="s3">import </span><span class="s1">Algorithm</span><span class="s4">, </span><span class="s1">DSDigest</span><span class="s4">, </span><span class="s1">NSEC3Hash</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception </span><span class="s3">import </span><span class="s4">(  </span><span class="s0"># pylint: disable=W0611</span>
    <span class="s1">AlgorithmKeyMismatch</span><span class="s4">,</span>
    <span class="s1">DeniedByPolicy</span><span class="s4">,</span>
    <span class="s1">UnsupportedAlgorithm</span><span class="s4">,</span>
    <span class="s1">ValidationFailure</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">CDNSKEY </span><span class="s3">import </span><span class="s1">CDNSKEY</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">CDS </span><span class="s3">import </span><span class="s1">CDS</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">DNSKEY </span><span class="s3">import </span><span class="s1">DNSKEY</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">DS </span><span class="s3">import </span><span class="s1">DS</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">NSEC </span><span class="s3">import </span><span class="s1">NSEC</span><span class="s4">, </span><span class="s1">Bitmap</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">NSEC3PARAM </span><span class="s3">import </span><span class="s1">NSEC3PARAM</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">RRSIG </span><span class="s3">import </span><span class="s1">RRSIG</span><span class="s4">, </span><span class="s1">sigtime_to_posixtime</span>
<span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">dnskeybase </span><span class="s3">import </span><span class="s1">Flag</span>

<span class="s1">PublicKey </span><span class="s4">= </span><span class="s1">Union</span><span class="s4">[</span>
    <span class="s5">&quot;GenericPublicKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;rsa.RSAPublicKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ec.EllipticCurvePublicKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ed25519.Ed25519PublicKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ed448.Ed448PublicKey&quot;</span><span class="s4">,</span>
<span class="s4">]</span>

<span class="s1">PrivateKey </span><span class="s4">= </span><span class="s1">Union</span><span class="s4">[</span>
    <span class="s5">&quot;GenericPrivateKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;rsa.RSAPrivateKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ec.EllipticCurvePrivateKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ed25519.Ed25519PrivateKey&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ed448.Ed448PrivateKey&quot;</span><span class="s4">,</span>
<span class="s4">]</span>

<span class="s1">RRsetSigner </span><span class="s4">= </span><span class="s1">Callable</span><span class="s4">[[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">], </span><span class="s3">None</span><span class="s4">]</span>


<span class="s3">def </span><span class="s1">algorithm_from_text</span><span class="s4">(</span><span class="s1">text</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Algorithm</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert text into a DNSSEC algorithm value. 
 
    *text*, a ``str``, the text to convert to into an algorithm value. 
 
    Returns an ``int``. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">algorithm_to_text</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">Algorithm</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert a DNSSEC algorithm value to text 
 
    *value*, a ``dns.dnssec.Algorithm``. 
 
    Returns a ``str``, the name of a DNSSEC algorithm. 
    &quot;&quot;&quot;</span>

    <span class="s3">return </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">to_timestamp</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">float</span><span class="s4">, </span><span class="s1">int</span><span class="s4">]) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert various format to a timestamp&quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">datetime</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">.</span><span class="s1">timestamp</span><span class="s4">())</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">sigtime_to_posixtime</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">float</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">int</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">value</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s5">&quot;Unsupported timestamp type&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">key_id</span><span class="s4">(</span><span class="s1">key</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">DNSKEY</span><span class="s4">, </span><span class="s1">CDNSKEY</span><span class="s4">]) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Return the key id (a 16-bit number) for the specified key. 
 
    *key*, a ``dns.rdtypes.ANY.DNSKEY.DNSKEY`` 
 
    Returns an ``int`` between 0 and 65535 
    &quot;&quot;&quot;</span>

    <span class="s1">rdata </span><span class="s4">= </span><span class="s1">key</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s3">assert </span><span class="s1">rdata </span><span class="s3">is not None  </span><span class="s0"># for mypy</span>
    <span class="s3">if </span><span class="s1">key</span><span class="s4">.</span><span class="s1">algorithm </span><span class="s4">== </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSAMD5</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">[-</span><span class="s6">3</span><span class="s4">] &lt;&lt; </span><span class="s6">8</span><span class="s4">) + </span><span class="s1">rdata</span><span class="s4">[-</span><span class="s6">2</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">total </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">) // </span><span class="s6">2</span><span class="s4">):</span>
            <span class="s1">total </span><span class="s4">+= (</span><span class="s1">rdata</span><span class="s4">[</span><span class="s6">2 </span><span class="s4">* </span><span class="s1">i</span><span class="s4">] &lt;&lt; </span><span class="s6">8</span><span class="s4">) + </span><span class="s1">rdata</span><span class="s4">[</span><span class="s6">2 </span><span class="s4">* </span><span class="s1">i </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">) % </span><span class="s6">2 </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">total </span><span class="s4">+= </span><span class="s1">rdata</span><span class="s4">[</span><span class="s1">len</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">) - </span><span class="s6">1</span><span class="s4">] &lt;&lt; </span><span class="s6">8</span>
        <span class="s1">total </span><span class="s4">+= (</span><span class="s1">total </span><span class="s4">&gt;&gt; </span><span class="s6">16</span><span class="s4">) &amp; </span><span class="s6">0xFFFF</span>
        <span class="s3">return </span><span class="s1">total </span><span class="s4">&amp; </span><span class="s6">0xFFFF</span>


<span class="s3">class </span><span class="s1">Policy</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">pass</span>

    <span class="s3">def </span><span class="s1">ok_to_sign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">ok_to_validate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">ok_to_create_ds</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">: </span><span class="s1">DSDigest</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">return False</span>

    <span class="s3">def </span><span class="s1">ok_to_validate_ds</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">: </span><span class="s1">DSDigest</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
        <span class="s3">return False</span>


<span class="s3">class </span><span class="s1">SimpleDeny</span><span class="s4">(</span><span class="s1">Policy</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">deny_sign</span><span class="s4">, </span><span class="s1">deny_validate</span><span class="s4">, </span><span class="s1">deny_create_ds</span><span class="s4">, </span><span class="s1">deny_validate_ds</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_sign </span><span class="s4">= </span><span class="s1">deny_sign</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_validate </span><span class="s4">= </span><span class="s1">deny_validate</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_create_ds </span><span class="s4">= </span><span class="s1">deny_create_ds</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_validate_ds </span><span class="s4">= </span><span class="s1">deny_validate_ds</span>

    <span class="s3">def </span><span class="s1">ok_to_sign</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">key</span><span class="s4">.</span><span class="s1">algorithm </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_sign</span>

    <span class="s3">def </span><span class="s1">ok_to_validate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">key</span><span class="s4">.</span><span class="s1">algorithm </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_validate</span>

    <span class="s3">def </span><span class="s1">ok_to_create_ds</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">: </span><span class="s1">DSDigest</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">algorithm </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_create_ds</span>

    <span class="s3">def </span><span class="s1">ok_to_validate_ds</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">: </span><span class="s1">DSDigest</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">algorithm </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_deny_validate_ds</span>


<span class="s1">rfc_8624_policy </span><span class="s4">= </span><span class="s1">SimpleDeny</span><span class="s4">(</span>
    <span class="s4">{</span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSAMD5</span><span class="s4">, </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSA</span><span class="s4">, </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSANSEC3SHA1</span><span class="s4">, </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ECCGOST</span><span class="s4">},</span>
    <span class="s4">{</span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSAMD5</span><span class="s4">, </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSA</span><span class="s4">, </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSANSEC3SHA1</span><span class="s4">},</span>
    <span class="s4">{</span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">NULL</span><span class="s4">, </span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">SHA1</span><span class="s4">, </span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">GOST</span><span class="s4">},</span>
    <span class="s4">{</span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">NULL</span><span class="s4">},</span>
<span class="s4">)</span>

<span class="s1">allow_all_policy </span><span class="s4">= </span><span class="s1">SimpleDeny</span><span class="s4">(</span><span class="s1">set</span><span class="s4">(), </span><span class="s1">set</span><span class="s4">(), </span><span class="s1">set</span><span class="s4">(), </span><span class="s1">set</span><span class="s4">())</span>


<span class="s1">default_policy </span><span class="s4">= </span><span class="s1">rfc_8624_policy</span>


<span class="s3">def </span><span class="s1">make_ds</span><span class="s4">(</span>
    <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">key</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">Rdata</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">DSDigest</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">validating</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; DS</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a DS record for a DNSSEC key. 
 
    *name*, a ``dns.name.Name`` or ``str``, the owner name of the DS record. 
 
    *key*, a ``dns.rdtypes.ANY.DNSKEY.DNSKEY`` or ``dns.rdtypes.ANY.DNSKEY.CDNSKEY``, 
    the key the DS is about. 
 
    *algorithm*, a ``str`` or ``int`` specifying the hash algorithm. 
    The currently supported hashes are &quot;SHA1&quot;, &quot;SHA256&quot;, and &quot;SHA384&quot;. Case 
    does not matter for these strings. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If *key* is a relative name, 
    then it will be made absolute using the specified origin. 
 
    *policy*, a ``dns.dnssec.Policy`` or ``None``.  If ``None``, the default policy, 
    ``dns.dnssec.default_policy`` is used; this policy defaults to that of RFC 8624. 
 
    *validating*, a ``bool``.  If ``True``, then policy is checked in 
    validating mode, i.e. &quot;Is it ok to validate using this digest algorithm?&quot;. 
    Otherwise the policy is checked in creating mode, i.e. &quot;Is it ok to create a DS with 
    this digest algorithm?&quot;. 
 
    Raises ``UnsupportedAlgorithm`` if the algorithm is unknown. 
 
    Raises ``DeniedByPolicy`` if the algorithm is denied by policy. 
 
    Returns a ``dns.rdtypes.ANY.DS.DS`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">policy </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">policy </span><span class="s4">= </span><span class="s1">default_policy</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">algorithm </span><span class="s4">= </span><span class="s1">DSDigest</span><span class="s4">[</span><span class="s1">algorithm</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">()]</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">UnsupportedAlgorithm</span><span class="s4">(</span><span class="s5">f'unsupported algorithm &quot;</span><span class="s3">{</span><span class="s1">algorithm</span><span class="s3">}</span><span class="s5">&quot;'</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">validating</span><span class="s4">:</span>
        <span class="s1">check </span><span class="s4">= </span><span class="s1">policy</span><span class="s4">.</span><span class="s1">ok_to_validate_ds</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">check </span><span class="s4">= </span><span class="s1">policy</span><span class="s4">.</span><span class="s1">ok_to_create_ds</span>
    <span class="s3">if not </span><span class="s1">check</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">DeniedByPolicy</span>
    <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, (</span><span class="s1">DNSKEY</span><span class="s4">, </span><span class="s1">CDNSKEY</span><span class="s4">)):</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;key is not a DNSKEY/CDNSKEY&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">algorithm </span><span class="s4">== </span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">SHA1</span><span class="s4">:</span>
        <span class="s1">dshash </span><span class="s4">= </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">sha1</span><span class="s4">()</span>
    <span class="s3">elif </span><span class="s1">algorithm </span><span class="s4">== </span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">SHA256</span><span class="s4">:</span>
        <span class="s1">dshash </span><span class="s4">= </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">sha256</span><span class="s4">()</span>
    <span class="s3">elif </span><span class="s1">algorithm </span><span class="s4">== </span><span class="s1">DSDigest</span><span class="s4">.</span><span class="s1">SHA384</span><span class="s4">:</span>
        <span class="s1">dshash </span><span class="s4">= </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">sha384</span><span class="s4">()</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">UnsupportedAlgorithm</span><span class="s4">(</span><span class="s5">f'unsupported algorithm &quot;</span><span class="s3">{</span><span class="s1">algorithm</span><span class="s3">}</span><span class="s5">&quot;'</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">name</span><span class="s4">.</span><span class="s1">canonicalize</span><span class="s4">().</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s1">kwire </span><span class="s4">= </span><span class="s1">key</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">=</span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">wire </span><span class="s3">is not None and </span><span class="s1">kwire </span><span class="s3">is not None  </span><span class="s0"># for mypy</span>
    <span class="s1">dshash</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">)</span>
    <span class="s1">dshash</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">kwire</span><span class="s4">)</span>
    <span class="s1">digest </span><span class="s4">= </span><span class="s1">dshash</span><span class="s4">.</span><span class="s1">digest</span><span class="s4">()</span>

    <span class="s1">dsrdata </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s5">&quot;!HBB&quot;</span><span class="s4">, </span><span class="s1">key_id</span><span class="s4">(</span><span class="s1">key</span><span class="s4">), </span><span class="s1">key</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">) + </span><span class="s1">digest</span>
    <span class="s1">ds </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">from_wire</span><span class="s4">(</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DS</span><span class="s4">, </span><span class="s1">dsrdata</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dsrdata</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s1">DS</span><span class="s4">, </span><span class="s1">ds</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">make_cds</span><span class="s4">(</span>
    <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">key</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">Rdata</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">DSDigest</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; CDS</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a CDS record for a DNSSEC key. 
 
    *name*, a ``dns.name.Name`` or ``str``, the owner name of the DS record. 
 
    *key*, a ``dns.rdtypes.ANY.DNSKEY.DNSKEY`` or ``dns.rdtypes.ANY.DNSKEY.CDNSKEY``, 
    the key the DS is about. 
 
    *algorithm*, a ``str`` or ``int`` specifying the hash algorithm. 
    The currently supported hashes are &quot;SHA1&quot;, &quot;SHA256&quot;, and &quot;SHA384&quot;. Case 
    does not matter for these strings. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If *key* is a relative name, 
    then it will be made absolute using the specified origin. 
 
    Raises ``UnsupportedAlgorithm`` if the algorithm is unknown. 
 
    Returns a ``dns.rdtypes.ANY.DS.CDS`` 
    &quot;&quot;&quot;</span>

    <span class="s1">ds </span><span class="s4">= </span><span class="s1">make_ds</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">CDS</span><span class="s4">(</span>
        <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDS</span><span class="s4">,</span>
        <span class="s1">key_tag</span><span class="s4">=</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">key_tag</span><span class="s4">,</span>
        <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
        <span class="s1">digest_type</span><span class="s4">=</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">digest_type</span><span class="s4">,</span>
        <span class="s1">digest</span><span class="s4">=</span><span class="s1">ds</span><span class="s4">.</span><span class="s1">digest</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">_find_candidate_keys</span><span class="s4">(</span>
    <span class="s1">keys</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">node</span><span class="s4">.</span><span class="s1">Node</span><span class="s4">]], </span><span class="s1">rrsig</span><span class="s4">: </span><span class="s1">RRSIG</span>
<span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">DNSKEY</span><span class="s4">]]:</span>
    <span class="s1">value </span><span class="s4">= </span><span class="s1">keys</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">signer</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">node</span><span class="s4">.</span><span class="s1">Node</span><span class="s4">):</span>
        <span class="s1">rdataset </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">get_rdataset</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">rdataset </span><span class="s4">= </span><span class="s1">value</span>
    <span class="s3">if </span><span class="s1">rdataset </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">return None</span>
    <span class="s3">return </span><span class="s4">[</span>
        <span class="s1">cast</span><span class="s4">(</span><span class="s1">DNSKEY</span><span class="s4">, </span><span class="s1">rd</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">rd </span><span class="s3">in </span><span class="s1">rdataset</span>
        <span class="s3">if </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">algorithm </span><span class="s4">== </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">algorithm</span>
        <span class="s3">and </span><span class="s1">key_id</span><span class="s4">(</span><span class="s1">rd</span><span class="s4">) == </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">key_tag</span>
        <span class="s3">and </span><span class="s4">(</span><span class="s1">rd</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">Flag</span><span class="s4">.</span><span class="s1">ZONE</span><span class="s4">) == </span><span class="s1">Flag</span><span class="s4">.</span><span class="s1">ZONE  </span><span class="s0"># RFC 4034 2.1.1</span>
        <span class="s3">and </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">protocol </span><span class="s4">== </span><span class="s6">3  </span><span class="s0"># RFC 4034 2.1.2</span>
    <span class="s4">]</span>


<span class="s3">def </span><span class="s1">_get_rrname_rdataset</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
<span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]:</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rrset</span>


<span class="s3">def </span><span class="s1">_validate_signature</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">data</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">key</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
    <span class="s1">public_cls </span><span class="s4">= </span><span class="s1">get_algorithm_cls_from_dnskey</span><span class="s4">(</span><span class="s1">key</span><span class="s4">).</span><span class="s1">public_cls</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">public_key </span><span class="s4">= </span><span class="s1">public_cls</span><span class="s4">.</span><span class="s1">from_dnskey</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
    <span class="s3">except </span><span class="s1">ValueError</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;invalid public key&quot;</span><span class="s4">)</span>
    <span class="s1">public_key</span><span class="s4">.</span><span class="s1">verify</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_validate_rrsig</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">rrsig</span><span class="s4">: </span><span class="s1">RRSIG</span><span class="s4">,</span>
    <span class="s1">keys</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">node</span><span class="s4">.</span><span class="s1">Node</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">now</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Validate an RRset against a single signature rdata, throwing an 
    exception if validation is not successful. 
 
    *rrset*, the RRset to validate.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *rrsig*, a ``dns.rdata.Rdata``, the signature to validate. 
 
    *keys*, the key dictionary, used to find the DNSKEY associated 
    with a given name.  The dictionary is keyed by a 
    ``dns.name.Name``, and has ``dns.node.Node`` or 
    ``dns.rdataset.Rdataset`` values. 
 
    *origin*, a ``dns.name.Name`` or ``None``, the origin to use for relative 
    names. 
 
    *now*, a ``float`` or ``None``, the time, in seconds since the epoch, to 
    use as the current time when validating.  If ``None``, the actual current 
    time is used. 
 
    *policy*, a ``dns.dnssec.Policy`` or ``None``.  If ``None``, the default policy, 
    ``dns.dnssec.default_policy`` is used; this policy defaults to that of RFC 8624. 
 
    Raises ``ValidationFailure`` if the signature is expired, not yet valid, 
    the public key is invalid, the algorithm is unknown, the verification 
    fails, etc. 
 
    Raises ``UnsupportedAlgorithm`` if the algorithm is recognized by 
    dnspython but not implemented. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">policy </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">policy </span><span class="s4">= </span><span class="s1">default_policy</span>

    <span class="s1">candidate_keys </span><span class="s4">= </span><span class="s1">_find_candidate_keys</span><span class="s4">(</span><span class="s1">keys</span><span class="s4">, </span><span class="s1">rrsig</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">candidate_keys </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;unknown key&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">now </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">now </span><span class="s4">= </span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()</span>
    <span class="s3">if </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">expiration </span><span class="s4">&lt; </span><span class="s1">now</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;expired&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">inception </span><span class="s4">&gt; </span><span class="s1">now</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;not yet valid&quot;</span><span class="s4">)</span>

    <span class="s1">data </span><span class="s4">= </span><span class="s1">_make_rrsig_signature_data</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">rrsig</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
    <span class="s3">for </span><span class="s1">candidate_key </span><span class="s3">in </span><span class="s1">candidate_keys</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">policy</span><span class="s4">.</span><span class="s1">ok_to_validate</span><span class="s4">(</span><span class="s1">candidate_key</span><span class="s4">):</span>
            <span class="s3">continue</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">_validate_signature</span><span class="s4">(</span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">signature</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">candidate_key</span><span class="s4">)</span>
            <span class="s3">return</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">InvalidSignature</span><span class="s4">, </span><span class="s1">ValidationFailure</span><span class="s4">):</span>
            <span class="s0"># this happens on an individual validation failure</span>
            <span class="s3">continue</span>
    <span class="s0"># nothing verified -- raise failure:</span>
    <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;verify failure&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_validate</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">rrsigset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">keys</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">node</span><span class="s4">.</span><span class="s1">Node</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">now</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Validate an RRset against a signature RRset, throwing an exception 
    if none of the signatures validate. 
 
    *rrset*, the RRset to validate.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *rrsigset*, the signature RRset.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *keys*, the key dictionary, used to find the DNSKEY associated 
    with a given name.  The dictionary is keyed by a 
    ``dns.name.Name``, and has ``dns.node.Node`` or 
    ``dns.rdataset.Rdataset`` values. 
 
    *origin*, a ``dns.name.Name``, the origin to use for relative names; 
    defaults to None. 
 
    *now*, an ``int`` or ``None``, the time, in seconds since the epoch, to 
    use as the current time when validating.  If ``None``, the actual current 
    time is used. 
 
    *policy*, a ``dns.dnssec.Policy`` or ``None``.  If ``None``, the default policy, 
    ``dns.dnssec.default_policy`` is used; this policy defaults to that of RFC 8624. 
 
    Raises ``ValidationFailure`` if the signature is expired, not yet valid, 
    the public key is invalid, the algorithm is unknown, the verification 
    fails, etc. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">policy </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">policy </span><span class="s4">= </span><span class="s1">default_policy</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">origin </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">rrsigset</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
        <span class="s1">rrsigname </span><span class="s4">= </span><span class="s1">rrsigset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">rrsigrdataset </span><span class="s4">= </span><span class="s1">rrsigset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">rrsigname </span><span class="s4">= </span><span class="s1">rrsigset</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s1">rrsigrdataset </span><span class="s4">= </span><span class="s1">rrsigset</span>

    <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">choose_relativity</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s1">rrsigname </span><span class="s4">= </span><span class="s1">rrsigname</span><span class="s4">.</span><span class="s1">choose_relativity</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">rrname </span><span class="s4">!= </span><span class="s1">rrsigname</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;owner names do not match&quot;</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">rrsig </span><span class="s3">in </span><span class="s1">rrsigrdataset</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">rrsig</span><span class="s4">, </span><span class="s1">RRSIG</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;expected an RRSIG&quot;</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">_validate_rrsig</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">rrsig</span><span class="s4">, </span><span class="s1">keys</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">, </span><span class="s1">now</span><span class="s4">, </span><span class="s1">policy</span><span class="s4">)</span>
            <span class="s3">return</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">ValidationFailure</span><span class="s4">, </span><span class="s1">UnsupportedAlgorithm</span><span class="s4">):</span>
            <span class="s3">pass</span>
    <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;no RRSIGs validated&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_sign</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">private_key</span><span class="s4">: </span><span class="s1">PrivateKey</span><span class="s4">,</span>
    <span class="s1">signer</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
    <span class="s1">dnskey</span><span class="s4">: </span><span class="s1">DNSKEY</span><span class="s4">,</span>
    <span class="s1">inception</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">verify</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">deterministic</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; RRSIG</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Sign RRset using private key. 
 
    *rrset*, the RRset to validate.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *private_key*, the private key to use for signing, a 
    ``cryptography.hazmat.primitives.asymmetric`` private key class applicable 
    for DNSSEC. 
 
    *signer*, a ``dns.name.Name``, the Signer's name. 
 
    *dnskey*, a ``DNSKEY`` matching ``private_key``. 
 
    *inception*, a ``datetime``, ``str``, ``int``, ``float`` or ``None``, the 
    signature inception time.  If ``None``, the current time is used.  If a ``str``, the 
    format is &quot;YYYYMMDDHHMMSS&quot; or alternatively the number of seconds since the UNIX 
    epoch in text form; this is the same the RRSIG rdata's text form. 
    Values of type `int` or `float` are interpreted as seconds since the UNIX epoch. 
 
    *expiration*, a ``datetime``, ``str``, ``int``, ``float`` or ``None``, the signature 
    expiration time.  If ``None``, the expiration time will be the inception time plus 
    the value of the *lifetime* parameter.  See the description of *inception* above 
    for how the various parameter types are interpreted. 
 
    *lifetime*, an ``int`` or ``None``, the signature lifetime in seconds.  This 
    parameter is only meaningful if *expiration* is ``None``. 
 
    *verify*, a ``bool``.  If set to ``True``, the signer will verify signatures 
    after they are created; the default is ``False``. 
 
    *policy*, a ``dns.dnssec.Policy`` or ``None``.  If ``None``, the default policy, 
    ``dns.dnssec.default_policy`` is used; this policy defaults to that of RFC 8624. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If ``None``, the default, then all 
    names in the rrset (including its owner name) must be absolute; otherwise the 
    specified origin will be used to make names absolute when signing. 
 
    *deterministic*, a ``bool``. If ``True``, the default, use deterministic 
    (reproducible) signatures when supported by the algorithm used for signing. 
    Currently, this only affects ECDSA. 
 
    Raises ``DeniedByPolicy`` if the signature is denied by policy. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">policy </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">policy </span><span class="s4">= </span><span class="s1">default_policy</span>
    <span class="s3">if not </span><span class="s1">policy</span><span class="s4">.</span><span class="s1">ok_to_sign</span><span class="s4">(</span><span class="s1">dnskey</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">DeniedByPolicy</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
        <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">rdclass</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">rdtype</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">original_ttl </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">ttl</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdclass</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdtype</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s1">original_ttl </span><span class="s4">= </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">ttl</span>

    <span class="s3">if </span><span class="s1">inception </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">rrsig_inception </span><span class="s4">= </span><span class="s1">to_timestamp</span><span class="s4">(</span><span class="s1">inception</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">rrsig_inception </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">())</span>

    <span class="s3">if </span><span class="s1">expiration </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">rrsig_expiration </span><span class="s4">= </span><span class="s1">to_timestamp</span><span class="s4">(</span><span class="s1">expiration</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">lifetime </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">rrsig_expiration </span><span class="s4">= </span><span class="s1">rrsig_inception </span><span class="s4">+ </span><span class="s1">lifetime</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;expiration or lifetime must be specified&quot;</span><span class="s4">)</span>

    <span class="s0"># Derelativize now because we need a correct labels length for the</span>
    <span class="s0"># rrsig_template.</span>
    <span class="s3">if </span><span class="s1">origin </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">derelativize</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">)</span>
    <span class="s1">labels </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rrname</span><span class="s4">) - </span><span class="s6">1</span>

    <span class="s0"># Adjust labels appropriately for wildcards.</span>
    <span class="s3">if </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">is_wild</span><span class="s4">():</span>
        <span class="s1">labels </span><span class="s4">-= </span><span class="s6">1</span>

    <span class="s1">rrsig_template </span><span class="s4">= </span><span class="s1">RRSIG</span><span class="s4">(</span>
        <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RRSIG</span><span class="s4">,</span>
        <span class="s1">type_covered</span><span class="s4">=</span><span class="s1">rdtype</span><span class="s4">,</span>
        <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
        <span class="s1">labels</span><span class="s4">=</span><span class="s1">labels</span><span class="s4">,</span>
        <span class="s1">original_ttl</span><span class="s4">=</span><span class="s1">original_ttl</span><span class="s4">,</span>
        <span class="s1">expiration</span><span class="s4">=</span><span class="s1">rrsig_expiration</span><span class="s4">,</span>
        <span class="s1">inception</span><span class="s4">=</span><span class="s1">rrsig_inception</span><span class="s4">,</span>
        <span class="s1">key_tag</span><span class="s4">=</span><span class="s1">key_id</span><span class="s4">(</span><span class="s1">dnskey</span><span class="s4">),</span>
        <span class="s1">signer</span><span class="s4">=</span><span class="s1">signer</span><span class="s4">,</span>
        <span class="s1">signature</span><span class="s4">=</span><span class="s7">b&quot;&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">data </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">dnssec</span><span class="s4">.</span><span class="s1">_make_rrsig_signature_data</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">, </span><span class="s1">rrsig_template</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">private_key</span><span class="s4">, </span><span class="s1">GenericPrivateKey</span><span class="s4">):</span>
        <span class="s1">signing_key </span><span class="s4">= </span><span class="s1">private_key</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">private_cls </span><span class="s4">= </span><span class="s1">get_algorithm_cls_from_dnskey</span><span class="s4">(</span><span class="s1">dnskey</span><span class="s4">)</span>
            <span class="s1">signing_key </span><span class="s4">= </span><span class="s1">private_cls</span><span class="s4">(</span><span class="s1">key</span><span class="s4">=</span><span class="s1">private_key</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">UnsupportedAlgorithm</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s5">&quot;Unsupported key algorithm&quot;</span><span class="s4">)</span>

    <span class="s1">signature </span><span class="s4">= </span><span class="s1">signing_key</span><span class="s4">.</span><span class="s1">sign</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">verify</span><span class="s4">, </span><span class="s1">deterministic</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s1">RRSIG</span><span class="s4">, </span><span class="s1">rrsig_template</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s1">signature</span><span class="s4">=</span><span class="s1">signature</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">_make_rrsig_signature_data</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">rrsig</span><span class="s4">: </span><span class="s1">RRSIG</span><span class="s4">,</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create signature rdata. 
 
    *rrset*, the RRset to sign/validate.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *rrsig*, a ``dns.rdata.Rdata``, the signature to validate, or the 
    signature template used when signing. 
 
    *origin*, a ``dns.name.Name`` or ``None``, the origin to use for relative 
    names. 
 
    Raises ``UnsupportedAlgorithm`` if the algorithm is recognized by 
    dnspython but not implemented. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">origin </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span><span class="s4">)</span>

    <span class="s1">signer </span><span class="s4">= </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">signer</span>
    <span class="s3">if not </span><span class="s1">signer</span><span class="s4">.</span><span class="s1">is_absolute</span><span class="s4">():</span>
        <span class="s3">if </span><span class="s1">origin </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;relative RR name without an origin specified&quot;</span><span class="s4">)</span>
        <span class="s1">signer </span><span class="s4">= </span><span class="s1">signer</span><span class="s4">.</span><span class="s1">derelativize</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">)</span>

    <span class="s0"># For convenience, allow the rrset to be specified as a (name,</span>
    <span class="s0"># rdataset) tuple as well as a proper rrset</span>
    <span class="s1">rrname</span><span class="s4">, </span><span class="s1">rdataset </span><span class="s4">= </span><span class="s1">_get_rrname_rdataset</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">)</span>

    <span class="s1">data </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
    <span class="s1">wire </span><span class="s4">= </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">=</span><span class="s1">signer</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">wire </span><span class="s3">is not None  </span><span class="s0"># for mypy</span>
    <span class="s1">data </span><span class="s4">+= </span><span class="s1">wire</span><span class="s4">[:</span><span class="s6">18</span><span class="s4">]</span>
    <span class="s1">data </span><span class="s4">+= </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">signer</span><span class="s4">.</span><span class="s1">to_digestable</span><span class="s4">(</span><span class="s1">signer</span><span class="s4">)</span>

    <span class="s0"># Derelativize the name before considering labels.</span>
    <span class="s3">if not </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">is_absolute</span><span class="s4">():</span>
        <span class="s3">if </span><span class="s1">origin </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;relative RR name without an origin specified&quot;</span><span class="s4">)</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">derelativize</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">)</span>

    <span class="s1">name_len </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rrname</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">is_wild</span><span class="s4">() </span><span class="s3">and </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">labels </span><span class="s4">!= </span><span class="s1">name_len </span><span class="s4">- </span><span class="s6">2</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;wild owner name has wrong label length&quot;</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">name_len </span><span class="s4">- </span><span class="s6">1 </span><span class="s4">&lt; </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">labels</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValidationFailure</span><span class="s4">(</span><span class="s5">&quot;owner name longer than RRSIG labels&quot;</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">labels </span><span class="s4">&lt; </span><span class="s1">name_len </span><span class="s4">- </span><span class="s6">1</span><span class="s4">:</span>
        <span class="s1">suffix </span><span class="s4">= </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">labels </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">)[</span><span class="s6">1</span><span class="s4">]</span>
        <span class="s1">rrname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s5">&quot;*&quot;</span><span class="s4">, </span><span class="s1">suffix</span><span class="s4">)</span>
    <span class="s1">rrnamebuf </span><span class="s4">= </span><span class="s1">rrname</span><span class="s4">.</span><span class="s1">to_digestable</span><span class="s4">()</span>
    <span class="s1">rrfixed </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s5">&quot;!HHI&quot;</span><span class="s4">, </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rrsig</span><span class="s4">.</span><span class="s1">original_ttl</span><span class="s4">)</span>
    <span class="s1">rdatas </span><span class="s4">= [</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">to_digestable</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">) </span><span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">rdataset</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">rdatas</span><span class="s4">):</span>
        <span class="s1">data </span><span class="s4">+= </span><span class="s1">rrnamebuf</span>
        <span class="s1">data </span><span class="s4">+= </span><span class="s1">rrfixed</span>
        <span class="s1">rrlen </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s5">&quot;!H&quot;</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">))</span>
        <span class="s1">data </span><span class="s4">+= </span><span class="s1">rrlen</span>
        <span class="s1">data </span><span class="s4">+= </span><span class="s1">rdata</span>

    <span class="s3">return </span><span class="s1">data</span>


<span class="s3">def </span><span class="s1">_make_dnskey</span><span class="s4">(</span>
    <span class="s1">public_key</span><span class="s4">: </span><span class="s1">PublicKey</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">flags</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">Flag</span><span class="s4">.</span><span class="s1">ZONE</span><span class="s4">,</span>
    <span class="s1">protocol</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">3</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; DNSKEY</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert a public key to DNSKEY Rdata 
 
    *public_key*, a ``PublicKey`` (``GenericPublicKey`` or 
    ``cryptography.hazmat.primitives.asymmetric``) to convert. 
 
    *algorithm*, a ``str`` or ``int`` specifying the DNSKEY algorithm. 
 
    *flags*: DNSKEY flags field as an integer. 
 
    *protocol*: DNSKEY protocol field as an integer. 
 
    Raises ``ValueError`` if the specified key algorithm parameters are not 
    unsupported, ``TypeError`` if the key type is unsupported, 
    `UnsupportedAlgorithm` if the algorithm is unknown and 
    `AlgorithmKeyMismatch` if the algorithm does not match the key type. 
 
    Return DNSKEY ``Rdata``. 
    &quot;&quot;&quot;</span>

    <span class="s1">algorithm </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=possibly-used-before-assignment</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">public_key</span><span class="s4">, </span><span class="s1">GenericPublicKey</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">public_key</span><span class="s4">.</span><span class="s1">to_dnskey</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">=</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">protocol</span><span class="s4">=</span><span class="s1">protocol</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">public_cls </span><span class="s4">= </span><span class="s1">get_algorithm_cls</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">).</span><span class="s1">public_cls</span>
        <span class="s3">return </span><span class="s1">public_cls</span><span class="s4">(</span><span class="s1">key</span><span class="s4">=</span><span class="s1">public_key</span><span class="s4">).</span><span class="s1">to_dnskey</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">=</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">protocol</span><span class="s4">=</span><span class="s1">protocol</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_make_cdnskey</span><span class="s4">(</span>
    <span class="s1">public_key</span><span class="s4">: </span><span class="s1">PublicKey</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">flags</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">Flag</span><span class="s4">.</span><span class="s1">ZONE</span><span class="s4">,</span>
    <span class="s1">protocol</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">3</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; CDNSKEY</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert a public key to CDNSKEY Rdata 
 
    *public_key*, the public key to convert, a 
    ``cryptography.hazmat.primitives.asymmetric`` public key class applicable 
    for DNSSEC. 
 
    *algorithm*, a ``str`` or ``int`` specifying the DNSKEY algorithm. 
 
    *flags*: DNSKEY flags field as an integer. 
 
    *protocol*: DNSKEY protocol field as an integer. 
 
    Raises ``ValueError`` if the specified key algorithm parameters are not 
    unsupported, ``TypeError`` if the key type is unsupported, 
    `UnsupportedAlgorithm` if the algorithm is unknown and 
    `AlgorithmKeyMismatch` if the algorithm does not match the key type. 
 
    Return CDNSKEY ``Rdata``. 
    &quot;&quot;&quot;</span>

    <span class="s1">dnskey </span><span class="s4">= </span><span class="s1">_make_dnskey</span><span class="s4">(</span><span class="s1">public_key</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">, </span><span class="s1">protocol</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">CDNSKEY</span><span class="s4">(</span>
        <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDNSKEY</span><span class="s4">,</span>
        <span class="s1">flags</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">,</span>
        <span class="s1">protocol</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">protocol</span><span class="s4">,</span>
        <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
        <span class="s1">key</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">key</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">nsec3_hash</span><span class="s4">(</span>
    <span class="s1">domain</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">salt</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]],</span>
    <span class="s1">iterations</span><span class="s4">: </span><span class="s1">int</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
<span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot; 
    Calculate the NSEC3 hash, according to 
    https://tools.ietf.org/html/rfc5155#section-5 
 
    *domain*, a ``dns.name.Name`` or ``str``, the name to hash. 
 
    *salt*, a ``str``, ``bytes``, or ``None``, the hash salt.  If a 
    string, it is decoded as a hex string. 
 
    *iterations*, an ``int``, the number of iterations. 
 
    *algorithm*, a ``str`` or ``int``, the hash algorithm. 
    The only defined algorithm is SHA1. 
 
    Returns a ``str``, the encoded NSEC3 hash. 
    &quot;&quot;&quot;</span>

    <span class="s1">b32_conversion </span><span class="s4">= </span><span class="s1">str</span><span class="s4">.</span><span class="s1">maketrans</span><span class="s4">(</span>
        <span class="s5">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ234567&quot;</span><span class="s4">, </span><span class="s5">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUV&quot;</span>
    <span class="s4">)</span>

    <span class="s3">try</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">algorithm </span><span class="s4">= </span><span class="s1">NSEC3Hash</span><span class="s4">[</span><span class="s1">algorithm</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">()]</span>
    <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Wrong hash algorithm (only SHA1 is supported)&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">algorithm </span><span class="s4">!= </span><span class="s1">NSEC3Hash</span><span class="s4">.</span><span class="s1">SHA1</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Wrong hash algorithm (only SHA1 is supported)&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">salt </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">salt_encoded </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">salt</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">salt</span><span class="s4">) % </span><span class="s6">2 </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">salt_encoded </span><span class="s4">= </span><span class="s1">bytes</span><span class="s4">.</span><span class="s1">fromhex</span><span class="s4">(</span><span class="s1">salt</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;Invalid salt length&quot;</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">salt_encoded </span><span class="s4">= </span><span class="s1">salt</span>

    <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">domain</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">):</span>
        <span class="s1">domain </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">domain</span><span class="s4">)</span>
    <span class="s1">domain_encoded </span><span class="s4">= </span><span class="s1">domain</span><span class="s4">.</span><span class="s1">canonicalize</span><span class="s4">().</span><span class="s1">to_wire</span><span class="s4">()</span>
    <span class="s3">assert </span><span class="s1">domain_encoded </span><span class="s3">is not None</span>

    <span class="s1">digest </span><span class="s4">= </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">sha1</span><span class="s4">(</span><span class="s1">domain_encoded </span><span class="s4">+ </span><span class="s1">salt_encoded</span><span class="s4">).</span><span class="s1">digest</span><span class="s4">()</span>
    <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">iterations</span><span class="s4">):</span>
        <span class="s1">digest </span><span class="s4">= </span><span class="s1">hashlib</span><span class="s4">.</span><span class="s1">sha1</span><span class="s4">(</span><span class="s1">digest </span><span class="s4">+ </span><span class="s1">salt_encoded</span><span class="s4">).</span><span class="s1">digest</span><span class="s4">()</span>

    <span class="s1">output </span><span class="s4">= </span><span class="s1">base64</span><span class="s4">.</span><span class="s1">b32encode</span><span class="s4">(</span><span class="s1">digest</span><span class="s4">).</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
    <span class="s1">output </span><span class="s4">= </span><span class="s1">output</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">b32_conversion</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">output</span>


<span class="s3">def </span><span class="s1">make_ds_rdataset</span><span class="s4">(</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">]],</span>
    <span class="s1">algorithms</span><span class="s4">: </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">DSDigest</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a DS record from DNSKEY/CDNSKEY/CDS. 
 
    *rrset*, the RRset to create DS Rdataset for.  This can be a 
    ``dns.rrset.RRset`` or a (``dns.name.Name``, ``dns.rdataset.Rdataset``) 
    tuple. 
 
    *algorithms*, a set of ``str`` or ``int`` specifying the hash algorithms. 
    The currently supported hashes are &quot;SHA1&quot;, &quot;SHA256&quot;, and &quot;SHA384&quot;. Case 
    does not matter for these strings. If the RRset is a CDS, only digest 
    algorithms matching algorithms are accepted. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If `key` is a relative name, 
    then it will be made absolute using the specified origin. 
 
    Raises ``UnsupportedAlgorithm`` if any of the algorithms are unknown and 
    ``ValueError`` if the given RRset is not usable. 
 
    Returns a ``dns.rdataset.Rdataset`` 
    &quot;&quot;&quot;</span>

    <span class="s1">rrname</span><span class="s4">, </span><span class="s1">rdataset </span><span class="s4">= </span><span class="s1">_get_rrname_rdataset</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s3">not in </span><span class="s4">(</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">,</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDNSKEY</span><span class="s4">,</span>
        <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDS</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;rrset not a DNSKEY/CDNSKEY/CDS&quot;</span><span class="s4">)</span>

    <span class="s1">_algorithms </span><span class="s4">= </span><span class="s1">set</span><span class="s4">()</span>
    <span class="s3">for </span><span class="s1">algorithm </span><span class="s3">in </span><span class="s1">algorithms</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s1">algorithm </span><span class="s4">= </span><span class="s1">DSDigest</span><span class="s4">[</span><span class="s1">algorithm</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">()]</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">UnsupportedAlgorithm</span><span class="s4">(</span><span class="s5">f'unsupported algorithm &quot;</span><span class="s3">{</span><span class="s1">algorithm</span><span class="s3">}</span><span class="s5">&quot;'</span><span class="s4">)</span>
        <span class="s1">_algorithms</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">algorithm</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDS</span><span class="s4">:</span>
        <span class="s1">res </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">cds_rdataset_to_ds_rdataset</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">digest_type </span><span class="s3">in </span><span class="s1">_algorithms</span><span class="s4">:</span>
                <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">rdata</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">res</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;no acceptable CDS rdata found&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">from_rdata_list</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>

    <span class="s1">res </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">algorithm </span><span class="s3">in </span><span class="s1">_algorithms</span><span class="s4">:</span>
        <span class="s1">res</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">dnskey_rdataset_to_cds_rdataset</span><span class="s4">(</span><span class="s1">rrname</span><span class="s4">, </span><span class="s1">rdataset</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">from_rdata_list</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">cds_rdataset_to_ds_rdataset</span><span class="s4">(</span>
    <span class="s1">rdataset</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a CDS record from DS. 
 
    *rdataset*, a ``dns.rdataset.Rdataset``, to create DS Rdataset for. 
 
    Raises ``ValueError`` if the rdataset is not CDS. 
 
    Returns a ``dns.rdataset.Rdataset`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDS</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;rdataset not a CDS&quot;</span><span class="s4">)</span>
    <span class="s1">res </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">rdataset</span><span class="s4">:</span>
        <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
            <span class="s1">CDS</span><span class="s4">(</span>
                <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">,</span>
                <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DS</span><span class="s4">,</span>
                <span class="s1">key_tag</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">key_tag</span><span class="s4">,</span>
                <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
                <span class="s1">digest_type</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">digest_type</span><span class="s4">,</span>
                <span class="s1">digest</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">digest</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">from_rdata_list</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">dnskey_rdataset_to_cds_rdataset</span><span class="s4">(</span>
    <span class="s1">name</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdataset</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">,</span>
    <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">DSDigest</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a CDS record from DNSKEY/CDNSKEY. 
 
    *name*, a ``dns.name.Name`` or ``str``, the owner name of the CDS record. 
 
    *rdataset*, a ``dns.rdataset.Rdataset``, to create DS Rdataset for. 
 
    *algorithm*, a ``str`` or ``int`` specifying the hash algorithm. 
    The currently supported hashes are &quot;SHA1&quot;, &quot;SHA256&quot;, and &quot;SHA384&quot;. Case 
    does not matter for these strings. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If `key` is a relative name, 
    then it will be made absolute using the specified origin. 
 
    Raises ``UnsupportedAlgorithm`` if the algorithm is unknown or 
    ``ValueError`` if the rdataset is not DNSKEY/CDNSKEY. 
 
    Returns a ``dns.rdataset.Rdataset`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s3">not in </span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CDNSKEY</span><span class="s4">):</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;rdataset not a DNSKEY/CDNSKEY&quot;</span><span class="s4">)</span>
    <span class="s1">res </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">rdataset</span><span class="s4">:</span>
        <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">make_cds</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdata</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">))</span>
    <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">from_rdata_list</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">dnskey_rdataset_to_cdnskey_rdataset</span><span class="s4">(</span>
    <span class="s1">rdataset</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">Rdataset</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Create a CDNSKEY record from DNSKEY. 
 
    *rdataset*, a ``dns.rdataset.Rdataset``, to create CDNSKEY Rdataset for. 
 
    Returns a ``dns.rdataset.Rdataset`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;rdataset not a DNSKEY&quot;</span><span class="s4">)</span>
    <span class="s1">res </span><span class="s4">= []</span>
    <span class="s3">for </span><span class="s1">rdata </span><span class="s3">in </span><span class="s1">rdataset</span><span class="s4">:</span>
        <span class="s1">res</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
            <span class="s1">CDNSKEY</span><span class="s4">(</span>
                <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">,</span>
                <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">,</span>
                <span class="s1">flags</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">,</span>
                <span class="s1">protocol</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">protocol</span><span class="s4">,</span>
                <span class="s1">algorithm</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
                <span class="s1">key</span><span class="s4">=</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">key</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">from_rdata_list</span><span class="s4">(</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">default_rrset_signer</span><span class="s4">(</span>
    <span class="s1">txn</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">,</span>
    <span class="s1">rrset</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">,</span>
    <span class="s1">signer</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
    <span class="s1">ksks</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">PrivateKey</span><span class="s4">, </span><span class="s1">DNSKEY</span><span class="s4">]],</span>
    <span class="s1">zsks</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">PrivateKey</span><span class="s4">, </span><span class="s1">DNSKEY</span><span class="s4">]],</span>
    <span class="s1">inception</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">deterministic</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Default RRset signer&quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s3">in </span><span class="s1">set</span><span class="s4">(</span>
        <span class="s4">[</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">CDS</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">CDNSKEY</span><span class="s4">,</span>
        <span class="s4">]</span>
    <span class="s4">):</span>
        <span class="s1">keys </span><span class="s4">= </span><span class="s1">ksks</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">keys </span><span class="s4">= </span><span class="s1">zsks</span>

    <span class="s3">for </span><span class="s1">private_key</span><span class="s4">, </span><span class="s1">dnskey </span><span class="s3">in </span><span class="s1">keys</span><span class="s4">:</span>
        <span class="s1">rrsig </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">dnssec</span><span class="s4">.</span><span class="s1">sign</span><span class="s4">(</span>
            <span class="s1">rrset</span><span class="s4">=</span><span class="s1">rrset</span><span class="s4">,</span>
            <span class="s1">private_key</span><span class="s4">=</span><span class="s1">private_key</span><span class="s4">,</span>
            <span class="s1">dnskey</span><span class="s4">=</span><span class="s1">dnskey</span><span class="s4">,</span>
            <span class="s1">inception</span><span class="s4">=</span><span class="s1">inception</span><span class="s4">,</span>
            <span class="s1">expiration</span><span class="s4">=</span><span class="s1">expiration</span><span class="s4">,</span>
            <span class="s1">lifetime</span><span class="s4">=</span><span class="s1">lifetime</span><span class="s4">,</span>
            <span class="s1">signer</span><span class="s4">=</span><span class="s1">signer</span><span class="s4">,</span>
            <span class="s1">policy</span><span class="s4">=</span><span class="s1">policy</span><span class="s4">,</span>
            <span class="s1">origin</span><span class="s4">=</span><span class="s1">origin</span><span class="s4">,</span>
            <span class="s1">deterministic</span><span class="s4">=</span><span class="s1">deterministic</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">txn</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">rrsig</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">sign_zone</span><span class="s4">(</span>
    <span class="s1">zone</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">Zone</span><span class="s4">,</span>
    <span class="s1">txn</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">keys</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">PrivateKey</span><span class="s4">, </span><span class="s1">DNSKEY</span><span class="s4">]]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">add_dnskey</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">dnskey_ttl</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">inception</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">expiration</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">float</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">lifetime</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">nsec3</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">NSEC3PARAM</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">rrset_signer</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RRsetSigner</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">policy</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Policy</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">deterministic</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Sign zone. 
 
    *zone*, a ``dns.zone.Zone``, the zone to sign. 
 
    *txn*, a ``dns.transaction.Transaction``, an optional transaction to use for 
    signing. 
 
    *keys*, a list of (``PrivateKey``, ``DNSKEY``) tuples, to use for signing. KSK/ZSK 
    roles are assigned automatically if the SEP flag is used, otherwise all RRsets are 
    signed by all keys. 
 
    *add_dnskey*, a ``bool``.  If ``True``, the default, all specified DNSKEYs are 
    automatically added to the zone on signing. 
 
    *dnskey_ttl*, a``int``, specifies the TTL for DNSKEY RRs. If not specified the TTL 
    of the existing DNSKEY RRset used or the TTL of the SOA RRset. 
 
    *inception*, a ``datetime``, ``str``, ``int``, ``float`` or ``None``, the signature 
    inception time.  If ``None``, the current time is used.  If a ``str``, the format is 
    &quot;YYYYMMDDHHMMSS&quot; or alternatively the number of seconds since the UNIX epoch in text 
    form; this is the same the RRSIG rdata's text form. Values of type `int` or `float` 
    are interpreted as seconds since the UNIX epoch. 
 
    *expiration*, a ``datetime``, ``str``, ``int``, ``float`` or ``None``, the signature 
    expiration time.  If ``None``, the expiration time will be the inception time plus 
    the value of the *lifetime* parameter.  See the description of *inception* above for 
    how the various parameter types are interpreted. 
 
    *lifetime*, an ``int`` or ``None``, the signature lifetime in seconds.  This 
    parameter is only meaningful if *expiration* is ``None``. 
 
    *nsec3*, a ``NSEC3PARAM`` Rdata, configures signing using NSEC3. Not yet 
    implemented. 
 
    *rrset_signer*, a ``Callable``, an optional function for signing RRsets. The 
    function requires two arguments: transaction and RRset. If the not specified, 
    ``dns.dnssec.default_rrset_signer`` will be used. 
 
    *deterministic*, a ``bool``. If ``True``, the default, use deterministic 
    (reproducible) signatures when supported by the algorithm used for signing. 
    Currently, this only affects ECDSA. 
 
    Returns ``None``. 
    &quot;&quot;&quot;</span>

    <span class="s1">ksks </span><span class="s4">= []</span>
    <span class="s1">zsks </span><span class="s4">= []</span>

    <span class="s0"># if we have both KSKs and ZSKs, split by SEP flag. if not, sign all</span>
    <span class="s0"># records with all keys</span>
    <span class="s3">if </span><span class="s1">keys</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">key </span><span class="s3">in </span><span class="s1">keys</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">key</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">Flag</span><span class="s4">.</span><span class="s1">SEP</span><span class="s4">:</span>
                <span class="s1">ksks</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">zsks</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">ksks</span><span class="s4">:</span>
            <span class="s1">ksks </span><span class="s4">= </span><span class="s1">keys</span>
        <span class="s3">if not </span><span class="s1">zsks</span><span class="s4">:</span>
            <span class="s1">zsks </span><span class="s4">= </span><span class="s1">keys</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">keys </span><span class="s4">= []</span>

    <span class="s3">if </span><span class="s1">txn</span><span class="s4">:</span>
        <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">txn</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">cm </span><span class="s4">= </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">writer</span><span class="s4">()</span>

    <span class="s3">if </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;no zone origin&quot;</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">_txn</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">add_dnskey</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">dnskey_ttl </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">dnskey </span><span class="s4">= </span><span class="s1">_txn</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DNSKEY</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">dnskey</span><span class="s4">:</span>
                    <span class="s1">dnskey_ttl </span><span class="s4">= </span><span class="s1">dnskey</span><span class="s4">.</span><span class="s1">ttl</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">soa </span><span class="s4">= </span><span class="s1">_txn</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA</span><span class="s4">)</span>
                    <span class="s1">dnskey_ttl </span><span class="s4">= </span><span class="s1">soa</span><span class="s4">.</span><span class="s1">ttl</span>
            <span class="s3">for </span><span class="s1">_</span><span class="s4">, </span><span class="s1">dnskey </span><span class="s3">in </span><span class="s1">keys</span><span class="s4">:</span>
                <span class="s1">_txn</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">dnskey_ttl</span><span class="s4">, </span><span class="s1">dnskey</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">nsec3</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s5">&quot;Signing with NSEC3 not yet implemented&quot;</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">_rrset_signer </span><span class="s4">= </span><span class="s1">rrset_signer </span><span class="s3">or </span><span class="s1">functools</span><span class="s4">.</span><span class="s1">partial</span><span class="s4">(</span>
                <span class="s1">default_rrset_signer</span><span class="s4">,</span>
                <span class="s1">signer</span><span class="s4">=</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">,</span>
                <span class="s1">ksks</span><span class="s4">=</span><span class="s1">ksks</span><span class="s4">,</span>
                <span class="s1">zsks</span><span class="s4">=</span><span class="s1">zsks</span><span class="s4">,</span>
                <span class="s1">inception</span><span class="s4">=</span><span class="s1">inception</span><span class="s4">,</span>
                <span class="s1">expiration</span><span class="s4">=</span><span class="s1">expiration</span><span class="s4">,</span>
                <span class="s1">lifetime</span><span class="s4">=</span><span class="s1">lifetime</span><span class="s4">,</span>
                <span class="s1">policy</span><span class="s4">=</span><span class="s1">policy</span><span class="s4">,</span>
                <span class="s1">origin</span><span class="s4">=</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">,</span>
                <span class="s1">deterministic</span><span class="s4">=</span><span class="s1">deterministic</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s1">_sign_zone_nsec</span><span class="s4">(</span><span class="s1">zone</span><span class="s4">, </span><span class="s1">_txn</span><span class="s4">, </span><span class="s1">_rrset_signer</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_sign_zone_nsec</span><span class="s4">(</span>
    <span class="s1">zone</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">zone</span><span class="s4">.</span><span class="s1">Zone</span><span class="s4">,</span>
    <span class="s1">txn</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">,</span>
    <span class="s1">rrset_signer</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RRsetSigner</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;NSEC zone signer&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_txn_add_nsec</span><span class="s4">(</span>
        <span class="s1">txn</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">transaction</span><span class="s4">.</span><span class="s1">Transaction</span><span class="s4">,</span>
        <span class="s1">name</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
        <span class="s1">next_secure</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">],</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">,</span>
        <span class="s1">ttl</span><span class="s4">: </span><span class="s1">int</span><span class="s4">,</span>
        <span class="s1">rrset_signer</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">RRsetSigner</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;NSEC zone signer helper&quot;&quot;&quot;</span>
        <span class="s1">mandatory_types </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span>
            <span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">RRSIG</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">NSEC</span><span class="s4">]</span>
        <span class="s4">)</span>
        <span class="s1">node </span><span class="s4">= </span><span class="s1">txn</span><span class="s4">.</span><span class="s1">get_node</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">node </span><span class="s3">and </span><span class="s1">next_secure</span><span class="s4">:</span>
            <span class="s1">types </span><span class="s4">= (</span>
                <span class="s1">set</span><span class="s4">([</span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s3">for </span><span class="s1">rdataset </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">rdatasets</span><span class="s4">]) | </span><span class="s1">mandatory_types</span>
            <span class="s4">)</span>
            <span class="s1">windows </span><span class="s4">= </span><span class="s1">Bitmap</span><span class="s4">.</span><span class="s1">from_rdtypes</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">types</span><span class="s4">))</span>
            <span class="s1">rrset </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span>
                <span class="s1">name</span><span class="s4">,</span>
                <span class="s1">ttl</span><span class="s4">,</span>
                <span class="s1">NSEC</span><span class="s4">(</span>
                    <span class="s1">rdclass</span><span class="s4">=</span><span class="s1">rdclass</span><span class="s4">,</span>
                    <span class="s1">rdtype</span><span class="s4">=</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">NSEC</span><span class="s4">,</span>
                    <span class="s1">next</span><span class="s4">=</span><span class="s1">next_secure</span><span class="s4">,</span>
                    <span class="s1">windows</span><span class="s4">=</span><span class="s1">windows</span><span class="s4">,</span>
                <span class="s4">),</span>
            <span class="s4">)</span>
            <span class="s1">txn</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">rrset_signer</span><span class="s4">:</span>
                <span class="s1">rrset_signer</span><span class="s4">(</span><span class="s1">txn</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">)</span>

    <span class="s1">rrsig_ttl </span><span class="s4">= </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">get_soa</span><span class="s4">().</span><span class="s1">minimum</span>
    <span class="s1">delegation </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">last_secure </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">txn</span><span class="s4">.</span><span class="s1">iterate_names</span><span class="s4">()):</span>
        <span class="s3">if </span><span class="s1">delegation </span><span class="s3">and </span><span class="s1">name</span><span class="s4">.</span><span class="s1">is_subdomain</span><span class="s4">(</span><span class="s1">delegation</span><span class="s4">):</span>
            <span class="s0"># names below delegations are not secure</span>
            <span class="s3">continue</span>
        <span class="s3">elif </span><span class="s1">txn</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">NS</span><span class="s4">) </span><span class="s3">and </span><span class="s1">name </span><span class="s4">!= </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">:</span>
            <span class="s0"># inside delegation</span>
            <span class="s1">delegation </span><span class="s4">= </span><span class="s1">name</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># outside delegation</span>
            <span class="s1">delegation </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">rrset_signer</span><span class="s4">:</span>
            <span class="s1">node </span><span class="s4">= </span><span class="s1">txn</span><span class="s4">.</span><span class="s1">get_node</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">node</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">rdataset </span><span class="s3">in </span><span class="s1">node</span><span class="s4">.</span><span class="s1">rdatasets</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RRSIG</span><span class="s4">:</span>
                        <span class="s0"># do not sign RRSIGs</span>
                        <span class="s3">continue</span>
                    <span class="s3">elif </span><span class="s1">delegation </span><span class="s3">and </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">DS</span><span class="s4">:</span>
                        <span class="s0"># do not sign delegations except DS records</span>
                        <span class="s3">continue</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">rrset </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdataset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, *</span><span class="s1">rdataset</span><span class="s4">)</span>
                        <span class="s1">rrset_signer</span><span class="s4">(</span><span class="s1">txn</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">)</span>

        <span class="s0"># We need &quot;is not None&quot; as the empty name is False because its length is 0.</span>
        <span class="s3">if </span><span class="s1">last_secure </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">_txn_add_nsec</span><span class="s4">(</span><span class="s1">txn</span><span class="s4">, </span><span class="s1">last_secure</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rrsig_ttl</span><span class="s4">, </span><span class="s1">rrset_signer</span><span class="s4">)</span>
        <span class="s1">last_secure </span><span class="s4">= </span><span class="s1">name</span>

    <span class="s3">if </span><span class="s1">last_secure</span><span class="s4">:</span>
        <span class="s1">_txn_add_nsec</span><span class="s4">(</span>
            <span class="s1">txn</span><span class="s4">, </span><span class="s1">last_secure</span><span class="s4">, </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">zone</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rrsig_ttl</span><span class="s4">, </span><span class="s1">rrset_signer</span>
        <span class="s4">)</span>


<span class="s3">def </span><span class="s1">_need_pyca</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s3">raise </span><span class="s1">ImportError</span><span class="s4">(</span>
        <span class="s5">&quot;DNSSEC validation requires python cryptography&quot;</span>
    <span class="s4">)  </span><span class="s0"># pragma: no cover</span>


<span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">_features</span><span class="s4">.</span><span class="s1">have</span><span class="s4">(</span><span class="s5">&quot;dnssec&quot;</span><span class="s4">):</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">exceptions </span><span class="s3">import </span><span class="s1">InvalidSignature</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">hazmat</span><span class="s4">.</span><span class="s1">primitives</span><span class="s4">.</span><span class="s1">asymmetric </span><span class="s3">import </span><span class="s1">dsa  </span><span class="s0"># pylint: disable=W0611</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">hazmat</span><span class="s4">.</span><span class="s1">primitives</span><span class="s4">.</span><span class="s1">asymmetric </span><span class="s3">import </span><span class="s1">ec  </span><span class="s0"># pylint: disable=W0611</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">hazmat</span><span class="s4">.</span><span class="s1">primitives</span><span class="s4">.</span><span class="s1">asymmetric </span><span class="s3">import </span><span class="s1">ed448  </span><span class="s0"># pylint: disable=W0611</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">hazmat</span><span class="s4">.</span><span class="s1">primitives</span><span class="s4">.</span><span class="s1">asymmetric </span><span class="s3">import </span><span class="s1">rsa  </span><span class="s0"># pylint: disable=W0611</span>
    <span class="s3">from </span><span class="s1">cryptography</span><span class="s4">.</span><span class="s1">hazmat</span><span class="s4">.</span><span class="s1">primitives</span><span class="s4">.</span><span class="s1">asymmetric </span><span class="s3">import </span><span class="s4">(  </span><span class="s0"># pylint: disable=W0611</span>
        <span class="s1">ed25519</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">dnssecalgs </span><span class="s3">import </span><span class="s4">(  </span><span class="s0"># pylint: disable=C0412</span>
        <span class="s1">get_algorithm_cls</span><span class="s4">,</span>
        <span class="s1">get_algorithm_cls_from_dnskey</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">from </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">dnssecalgs</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">GenericPrivateKey</span><span class="s4">, </span><span class="s1">GenericPublicKey</span>

    <span class="s1">validate </span><span class="s4">= </span><span class="s1">_validate  </span><span class="s0"># type: ignore</span>
    <span class="s1">validate_rrsig </span><span class="s4">= </span><span class="s1">_validate_rrsig  </span><span class="s0"># type: ignore</span>
    <span class="s1">sign </span><span class="s4">= </span><span class="s1">_sign</span>
    <span class="s1">make_dnskey </span><span class="s4">= </span><span class="s1">_make_dnskey</span>
    <span class="s1">make_cdnskey </span><span class="s4">= </span><span class="s1">_make_cdnskey</span>
    <span class="s1">_have_pyca </span><span class="s4">= </span><span class="s3">True</span>
<span class="s3">else</span><span class="s4">:  </span><span class="s0"># pragma: no cover</span>
    <span class="s1">validate </span><span class="s4">= </span><span class="s1">_need_pyca</span>
    <span class="s1">validate_rrsig </span><span class="s4">= </span><span class="s1">_need_pyca</span>
    <span class="s1">sign </span><span class="s4">= </span><span class="s1">_need_pyca</span>
    <span class="s1">make_dnskey </span><span class="s4">= </span><span class="s1">_need_pyca</span>
    <span class="s1">make_cdnskey </span><span class="s4">= </span><span class="s1">_need_pyca</span>
    <span class="s1">_have_pyca </span><span class="s4">= </span><span class="s3">False</span>

<span class="s0">### BEGIN generated Algorithm constants</span>

<span class="s1">RSAMD5 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSAMD5</span>
<span class="s1">DH </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DH</span>
<span class="s1">DSA </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSA</span>
<span class="s1">ECC </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ECC</span>
<span class="s1">RSASHA1 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSASHA1</span>
<span class="s1">DSANSEC3SHA1 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">DSANSEC3SHA1</span>
<span class="s1">RSASHA1NSEC3SHA1 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSASHA1NSEC3SHA1</span>
<span class="s1">RSASHA256 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSASHA256</span>
<span class="s1">RSASHA512 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">RSASHA512</span>
<span class="s1">ECCGOST </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ECCGOST</span>
<span class="s1">ECDSAP256SHA256 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ECDSAP256SHA256</span>
<span class="s1">ECDSAP384SHA384 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ECDSAP384SHA384</span>
<span class="s1">ED25519 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ED25519</span>
<span class="s1">ED448 </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">ED448</span>
<span class="s1">INDIRECT </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">INDIRECT</span>
<span class="s1">PRIVATEDNS </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">PRIVATEDNS</span>
<span class="s1">PRIVATEOID </span><span class="s4">= </span><span class="s1">Algorithm</span><span class="s4">.</span><span class="s1">PRIVATEOID</span>

<span class="s0">### END generated Algorithm constants</span>
</pre>
</body>
</html>