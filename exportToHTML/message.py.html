<html>
<head>
<title>message.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
message.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (C) Dnspython Contributors, see LICENSE for text of ISC license</span>

<span class="s0"># Copyright (C) 2001-2017 Nominum, Inc.</span>
<span class="s0">#</span>
<span class="s0"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="s0"># documentation for any purpose with or without fee is hereby granted,</span>
<span class="s0"># provided that the above copyright notice and this permission notice</span>
<span class="s0"># appear in all copies.</span>
<span class="s0">#</span>
<span class="s0"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND NOMINUM DISCLAIMS ALL WARRANTIES</span>
<span class="s0"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="s0"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL NOMINUM BE LIABLE FOR</span>
<span class="s0"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="s0"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="s0"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="s0"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="s2">&quot;&quot;&quot;DNS Messages&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">contextlib</span>
<span class="s3">import </span><span class="s1">enum</span>
<span class="s3">import </span><span class="s1">io</span>
<span class="s3">import </span><span class="s1">time</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span><span class="s4">, </span><span class="s1">cast</span>

<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">entropy</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">enum</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">OPT</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">TSIG</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">ttl</span>
<span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">wire</span>


<span class="s3">class </span><span class="s1">ShortHeader</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The DNS packet passed to from_wire() is too short.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">TrailingJunk</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The DNS packet passed to from_wire() has extra junk at the end of it.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">UnknownHeaderField</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The header field name was not recognized when converting from text 
    into a message.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">BadEDNS</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;An OPT record occurred somewhere other than 
    the additional data section.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">BadTSIG</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A TSIG record occurred somewhere other than the end of 
    the additional data section.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">UnknownTSIGKey</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;A TSIG with an unknown key was received.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">Truncated</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The truncated flag is set.&quot;&quot;&quot;</span>

    <span class="s1">supp_kwargs </span><span class="s4">= {</span><span class="s5">&quot;message&quot;</span><span class="s4">}</span>

    <span class="s0"># We do this as otherwise mypy complains about unexpected keyword argument</span>
    <span class="s0"># idna_exception</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">message</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;As much of the message as could be processed. 
 
        Returns a ``dns.message.Message``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;message&quot;</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">NotQueryResponse</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Message is not a response to a query.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">ChainTooLong</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The CNAME chain is too long.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">AnswerForNXDOMAIN</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">DNSException</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;The rcode is NXDOMAIN but an answer was found.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">NoPreviousName</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;No previous name was known.&quot;&quot;&quot;</span>


<span class="s3">class </span><span class="s1">MessageSection</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">enum</span><span class="s4">.</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Message sections&quot;&quot;&quot;</span>

    <span class="s1">QUESTION </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">ANSWER </span><span class="s4">= </span><span class="s6">1</span>
    <span class="s1">AUTHORITY </span><span class="s4">= </span><span class="s6">2</span>
    <span class="s1">ADDITIONAL </span><span class="s4">= </span><span class="s6">3</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">_maximum</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s6">3</span>


<span class="s3">class </span><span class="s1">MessageError</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">exception</span><span class="s4">: </span><span class="s1">Exception</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">: </span><span class="s1">int</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">exception </span><span class="s4">= </span><span class="s1">exception</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">offset </span><span class="s4">= </span><span class="s1">offset</span>


<span class="s1">DEFAULT_EDNS_PAYLOAD </span><span class="s4">= </span><span class="s6">1232</span>
<span class="s1">MAX_CHAIN </span><span class="s4">= </span><span class="s6">16</span>

<span class="s1">IndexKeyType </span><span class="s4">= </span><span class="s1">Tuple</span><span class="s4">[</span>
    <span class="s1">int</span><span class="s4">,</span>
    <span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
    <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">,</span>
    <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">,</span>
    <span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">],</span>
    <span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">],</span>
<span class="s4">]</span>
<span class="s1">IndexType </span><span class="s4">= </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">IndexKeyType</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]</span>
<span class="s1">SectionType </span><span class="s4">= </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">str</span><span class="s4">, </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]]</span>


<span class="s3">class </span><span class="s1">Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;A DNS message.&quot;&quot;&quot;</span>

    <span class="s1">_section_enum </span><span class="s4">= </span><span class="s1">MessageSection</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">id</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">id </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">entropy</span><span class="s4">.</span><span class="s1">random_16</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s1">id</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]] = [[], [], [], []]</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">request_payload </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">pad </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">request_mac </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">xfr </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig_ctx</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">: </span><span class="s1">IndexType </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">MessageError</span><span class="s4">] = []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">time </span><span class="s4">= </span><span class="s6">0.0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">wire</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">question</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;The question section.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">question</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">question</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">v</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] = </span><span class="s1">v</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">answer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;The answer section.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">answer</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">answer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">v</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] = </span><span class="s1">v</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">authority</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;The authority section.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">2</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">authority</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">authority</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">v</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">2</span><span class="s4">] = </span><span class="s1">v</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">additional</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;The additional data section.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">3</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">additional</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">additional</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">v</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s6">3</span><span class="s4">] = </span><span class="s1">v</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">&quot;&lt;DNS message, ID &quot; </span><span class="s4">+ </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">id</span><span class="s4">) + </span><span class="s5">&quot;&gt;&quot;</span>

    <span class="s3">def </span><span class="s1">__str__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">to_text</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">relativize</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s4">**</span><span class="s1">kw</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert the message to text. 
 
        The *origin*, *relativize*, and any other keyword 
        arguments are passed to the RRset ``to_wire()`` method. 
 
        Returns a ``str``. 
        &quot;&quot;&quot;</span>

        <span class="s1">s </span><span class="s4">= </span><span class="s1">io</span><span class="s4">.</span><span class="s1">StringIO</span><span class="s4">()</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;id %d</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">id</span><span class="s4">)</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;opcode </span><span class="s3">{</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">())</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;rcode </span><span class="s3">{</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">())</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;flags </span><span class="s3">{</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">)</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&gt;= </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;edns </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;eflags </span><span class="s3">{</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">edns_to_text</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags</span><span class="s4">)</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;payload %d</span><span class="s3">\n</span><span class="s5">&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">payload</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">opt </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options</span><span class="s4">:</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;option </span><span class="s3">{</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">()</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">which </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">.</span><span class="s1">__members__</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">f&quot;;</span><span class="s3">{</span><span class="s1">name</span><span class="s3">}\n</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">which</span><span class="s4">):</span>
                <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">to_text</span><span class="s4">(</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">relativize</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">))</span>
                <span class="s1">s</span><span class="s4">.</span><span class="s1">write</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">)</span>
        <span class="s0">#</span>
        <span class="s0"># We strip off the final \n so the caller can print the result without</span>
        <span class="s0"># doing weird things to get around eccentricities in Python print</span>
        <span class="s0"># formatting</span>
        <span class="s0">#</span>
        <span class="s3">return </span><span class="s1">s</span><span class="s4">.</span><span class="s1">getvalue</span><span class="s4">()[:-</span><span class="s6">1</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__eq__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Two messages are equal if they have the same content in the 
        header, question, answer, and authority sections. 
 
        Returns a ``bool``. 
        &quot;&quot;&quot;</span>

        <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">other</span><span class="s4">, </span><span class="s1">Message</span><span class="s4">):</span>
            <span class="s3">return False</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">!= </span><span class="s1">other</span><span class="s4">.</span><span class="s1">id</span><span class="s4">:</span>
            <span class="s3">return False</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">!= </span><span class="s1">other</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">:</span>
            <span class="s3">return False</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">section </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">):</span>
            <span class="s1">other_section </span><span class="s4">= </span><span class="s1">other</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">section</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">n </span><span class="s3">not in </span><span class="s1">other_section</span><span class="s4">:</span>
                    <span class="s3">return False</span>
            <span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">other_section</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">n </span><span class="s3">not in </span><span class="s1">section</span><span class="s4">:</span>
                    <span class="s3">return False</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">__ne__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s3">return not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__eq__</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">is_response</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">: </span><span class="s5">&quot;Message&quot;</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Is *other*, also a ``dns.message.Message``, a response to this 
        message? 
 
        Returns a ``bool``. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">other</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">QR </span><span class="s4">== </span><span class="s6">0</span>
            <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">!= </span><span class="s1">other</span><span class="s4">.</span><span class="s1">id</span>
            <span class="s3">or </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">from_flags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">) != </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">from_flags</span><span class="s4">(</span><span class="s1">other</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s3">return False</span>
        <span class="s3">if </span><span class="s1">other</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">() </span><span class="s3">in </span><span class="s4">{</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">FORMERR</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">SERVFAIL</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">NOTIMP</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">REFUSED</span><span class="s4">,</span>
        <span class="s4">}:</span>
            <span class="s0"># We don't check the question section in these cases if</span>
            <span class="s0"># the other question section is empty, even though they</span>
            <span class="s0"># still really ought to have a question section.</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">other</span><span class="s4">.</span><span class="s1">question</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s3">return True</span>
        <span class="s3">if </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">is_update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">):</span>
            <span class="s0"># This is assuming the &quot;sender doesn't include anything</span>
            <span class="s0"># from the update&quot;, but we don't care to check the other</span>
            <span class="s0"># case, which is that all the sections are returned and</span>
            <span class="s0"># identical.</span>
            <span class="s3">return True</span>
        <span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">question</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">n </span><span class="s3">not in </span><span class="s1">other</span><span class="s4">.</span><span class="s1">question</span><span class="s4">:</span>
                <span class="s3">return False</span>
        <span class="s3">for </span><span class="s1">n </span><span class="s3">in </span><span class="s1">other</span><span class="s4">.</span><span class="s1">question</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">n </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">question</span><span class="s4">:</span>
                <span class="s3">return False</span>
        <span class="s3">return True</span>

    <span class="s3">def </span><span class="s1">section_number</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return the &quot;section number&quot; of the specified section for use 
        in indexing. 
 
        *section* is one of the section attributes of this message. 
 
        Raises ``ValueError`` if the section isn't known. 
 
        Returns an ``int``. 
        &quot;&quot;&quot;</span>

        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">our_section </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">section </span><span class="s3">is </span><span class="s1">our_section</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">(</span><span class="s1">i</span><span class="s4">)</span>
        <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;unknown section&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">number</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the section list associated with the specified section 
        number. 
 
        *number* is a section number `int` or the text form of a section 
        name. 
 
        Raises ``ValueError`` if the section isn't known. 
 
        Returns a ``list``. 
        &quot;&quot;&quot;</span>

        <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">number</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">section</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">find_rrset</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">section</span><span class="s4">: </span><span class="s1">SectionType</span><span class="s4">,</span>
        <span class="s1">name</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">,</span>
        <span class="s1">covers</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">NONE</span><span class="s4">,</span>
        <span class="s1">deleting</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">create</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">force_unique</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">idna_codec</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">IDNACodec</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Find the RRset with the given attributes in the specified section. 
 
        *section*, an ``int`` section number, a ``str`` section name, or one of 
        the section attributes of this message.  This specifies the 
        the section of the message to search.  For example:: 
 
            my_message.find_rrset(my_message.answer, name, rdclass, rdtype) 
            my_message.find_rrset(dns.message.ANSWER, name, rdclass, rdtype) 
            my_message.find_rrset(&quot;ANSWER&quot;, name, rdclass, rdtype) 
 
        *name*, a ``dns.name.Name`` or ``str``, the name of the RRset. 
 
        *rdclass*, an ``int`` or ``str``, the class of the RRset. 
 
        *rdtype*, an ``int`` or ``str``, the type of the RRset. 
 
        *covers*, an ``int`` or ``str``, the covers value of the RRset. 
        The default is ``dns.rdatatype.NONE``. 
 
        *deleting*, an ``int``, ``str``, or ``None``, the deleting value of the 
        RRset.  The default is ``None``. 
 
        *create*, a ``bool``.  If ``True``, create the RRset if it is not found. 
        The created RRset is appended to *section*. 
 
        *force_unique*, a ``bool``.  If ``True`` and *create* is also ``True``, 
        create a new RRset regardless of whether a matching RRset exists 
        already.  The default is ``False``.  This is useful when creating 
        DDNS Update messages, as order matters for them. 
 
        *idna_codec*, a ``dns.name.IDNACodec``, specifies the IDNA 
        encoder/decoder.  If ``None``, the default IDNA 2003 encoder/decoder 
        is used. 
 
        Raises ``KeyError`` if the RRset was not found and create was 
        ``False``. 
 
        Returns a ``dns.rrset.RRset object``. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">section</span><span class="s4">, </span><span class="s1">int</span><span class="s4">):</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">section</span>
            <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">section_number</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">section</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">section</span><span class="s4">)</span>
            <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">section_number</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_number</span><span class="s4">(</span><span class="s1">section</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">name </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">idna_codec</span><span class="s4">=</span><span class="s1">idna_codec</span><span class="s4">)</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdtype</span><span class="s4">)</span>
        <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">)</span>
        <span class="s1">covers </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">covers</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">deleting </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">deleting </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">deleting</span><span class="s4">)</span>
        <span class="s1">key </span><span class="s4">= (</span><span class="s1">section_number</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">covers</span><span class="s4">, </span><span class="s1">deleting</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">force_unique</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">rrset </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s3">return </span><span class="s1">rrset</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">section</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">full_match</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">covers</span><span class="s4">, </span><span class="s1">deleting</span><span class="s4">):</span>
                        <span class="s3">return </span><span class="s1">rrset</span>
        <span class="s3">if not </span><span class="s1">create</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">KeyError</span>
        <span class="s1">rrset </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">covers</span><span class="s4">, </span><span class="s1">deleting</span><span class="s4">)</span>
        <span class="s1">section</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">rrset</span>
        <span class="s3">return </span><span class="s1">rrset</span>

    <span class="s3">def </span><span class="s1">get_rrset</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">section</span><span class="s4">: </span><span class="s1">SectionType</span><span class="s4">,</span>
        <span class="s1">name</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
        <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">,</span>
        <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">,</span>
        <span class="s1">covers</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">NONE</span><span class="s4">,</span>
        <span class="s1">deleting</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">create</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">force_unique</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">idna_codec</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">IDNACodec</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Get the RRset with the given attributes in the specified section. 
 
        If the RRset is not found, None is returned. 
 
        *section*, an ``int`` section number, a ``str`` section name, or one of 
        the section attributes of this message.  This specifies the 
        the section of the message to search.  For example:: 
 
            my_message.get_rrset(my_message.answer, name, rdclass, rdtype) 
            my_message.get_rrset(dns.message.ANSWER, name, rdclass, rdtype) 
            my_message.get_rrset(&quot;ANSWER&quot;, name, rdclass, rdtype) 
 
        *name*, a ``dns.name.Name`` or ``str``, the name of the RRset. 
 
        *rdclass*, an ``int`` or ``str``, the class of the RRset. 
 
        *rdtype*, an ``int`` or ``str``, the type of the RRset. 
 
        *covers*, an ``int`` or ``str``, the covers value of the RRset. 
        The default is ``dns.rdatatype.NONE``. 
 
        *deleting*, an ``int``, ``str``, or ``None``, the deleting value of the 
        RRset.  The default is ``None``. 
 
        *create*, a ``bool``.  If ``True``, create the RRset if it is not found. 
        The created RRset is appended to *section*. 
 
        *force_unique*, a ``bool``.  If ``True`` and *create* is also ``True``, 
        create a new RRset regardless of whether a matching RRset exists 
        already.  The default is ``False``.  This is useful when creating 
        DDNS Update messages, as order matters for them. 
 
        *idna_codec*, a ``dns.name.IDNACodec``, specifies the IDNA 
        encoder/decoder.  If ``None``, the default IDNA 2003 encoder/decoder 
        is used. 
 
        Returns a ``dns.rrset.RRset object`` or ``None``. 
        &quot;&quot;&quot;</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                <span class="s1">section</span><span class="s4">,</span>
                <span class="s1">name</span><span class="s4">,</span>
                <span class="s1">rdclass</span><span class="s4">,</span>
                <span class="s1">rdtype</span><span class="s4">,</span>
                <span class="s1">covers</span><span class="s4">,</span>
                <span class="s1">deleting</span><span class="s4">,</span>
                <span class="s1">create</span><span class="s4">,</span>
                <span class="s1">force_unique</span><span class="s4">,</span>
                <span class="s1">idna_codec</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s1">rrset </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">return </span><span class="s1">rrset</span>

    <span class="s3">def </span><span class="s1">section_count</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section</span><span class="s4">: </span><span class="s1">SectionType</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns the number of records in the specified section. 
 
        *section*, an ``int`` section number, a ``str`` section name, or one of 
        the section attributes of this message.  This specifies the 
        the section of the message to count.  For example:: 
 
            my_message.section_count(my_message.answer) 
            my_message.section_count(dns.message.ANSWER) 
            my_message.section_count(&quot;ANSWER&quot;) 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">section</span><span class="s4">, </span><span class="s1">int</span><span class="s4">):</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">section</span>
            <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">section_number</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">section</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">section</span><span class="s4">)</span>
            <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_from_number</span><span class="s4">(</span><span class="s1">section_number</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">section_number </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">section_number</span><span class="s4">(</span><span class="s1">section</span><span class="s4">)</span>
        <span class="s1">count </span><span class="s4">= </span><span class="s1">sum</span><span class="s4">(</span><span class="s1">max</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">rrs</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">rrs </span><span class="s3">in </span><span class="s1">section</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">section_number </span><span class="s4">== </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ADDITIONAL</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">count </span><span class="s4">+= </span><span class="s6">1</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">count </span><span class="s4">+= </span><span class="s6">1</span>
        <span class="s3">return </span><span class="s1">count</span>

    <span class="s3">def </span><span class="s1">_compute_opt_reserve</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Compute the size required for the OPT RR, padding excluded&quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span>
        <span class="s0"># 1 byte for the root name, 10 for the standard RR fields</span>
        <span class="s1">size </span><span class="s4">= </span><span class="s6">11</span>
        <span class="s0"># This would be more efficient if options had a size() method, but we won't</span>
        <span class="s0"># worry about that for now.  We also don't worry if there is an existing padding</span>
        <span class="s0"># option, as it is unlikely and probably harmless, as the worst case is that we</span>
        <span class="s0"># may add another, and this seems to be legal.</span>
        <span class="s3">for </span><span class="s1">option </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">options</span><span class="s4">:</span>
            <span class="s1">wire </span><span class="s4">= </span><span class="s1">option</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">()</span>
            <span class="s0"># We add 4 here to account for the option type and length</span>
            <span class="s1">size </span><span class="s4">+= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">) + </span><span class="s6">4</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pad</span><span class="s4">:</span>
            <span class="s0"># Padding will be added, so again add the option type and length.</span>
            <span class="s1">size </span><span class="s4">+= </span><span class="s6">4</span>
        <span class="s3">return </span><span class="s1">size</span>

    <span class="s3">def </span><span class="s1">_compute_tsig_reserve</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Compute the size required for the TSIG RR&quot;&quot;&quot;</span>
        <span class="s0"># This would be more efficient if TSIGs had a size method, but we won't</span>
        <span class="s0"># worry about for now.  Also, we can't really cope with the potential</span>
        <span class="s0"># compressibility of the TSIG owner name, so we estimate with the uncompressed</span>
        <span class="s0"># size.  We will disable compression when TSIG and padding are both is active</span>
        <span class="s0"># so that the padding comes out right.</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span>
        <span class="s1">f </span><span class="s4">= </span><span class="s1">io</span><span class="s4">.</span><span class="s1">BytesIO</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">to_wire</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">f</span><span class="s4">.</span><span class="s1">getvalue</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">to_wire</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">max_size</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">multi</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">tsig_ctx</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">prepend_length</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">prefer_truncation</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
        <span class="s4">**</span><span class="s1">kw</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return a string containing the message in DNS compressed wire 
        format. 
 
        Additional keyword arguments are passed to the RRset ``to_wire()`` 
        method. 
 
        *origin*, a ``dns.name.Name`` or ``None``, the origin to be appended 
        to any relative names.  If ``None``, and the message has an origin 
        attribute that is not ``None``, then it will be used. 
 
        *max_size*, an ``int``, the maximum size of the wire format 
        output; default is 0, which means &quot;the message's request 
        payload, if nonzero, or 65535&quot;. 
 
        *multi*, a ``bool``, should be set to ``True`` if this message is 
        part of a multiple message sequence. 
 
        *tsig_ctx*, a ``dns.tsig.HMACTSig`` or ``dns.tsig.GSSTSig`` object, the 
        ongoing TSIG context, used when signing zone transfers. 
 
        *prepend_length*, a ``bool``, should be set to ``True`` if the caller 
        wants the message length prepended to the message itself.  This is 
        useful for messages sent over TCP, TLS (DoT), or QUIC (DoQ). 
 
        *prefer_truncation*, a ``bool``, should be set to ``True`` if the caller 
        wants the message to be truncated if it would otherwise exceed the 
        maximum length.  If the truncation occurs before the additional section, 
        the TC bit will be set. 
 
        Raises ``dns.exception.TooBig`` if *max_size* was exceeded. 
 
        Returns a ``bytes``. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">origin </span><span class="s3">is None and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">origin </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">origin </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">origin</span>
        <span class="s3">if </span><span class="s1">max_size </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">request_payload </span><span class="s4">!= </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">max_size </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">request_payload</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">max_size </span><span class="s4">= </span><span class="s6">65535</span>
        <span class="s3">if </span><span class="s1">max_size </span><span class="s4">&lt; </span><span class="s6">512</span><span class="s4">:</span>
            <span class="s1">max_size </span><span class="s4">= </span><span class="s6">512</span>
        <span class="s3">elif </span><span class="s1">max_size </span><span class="s4">&gt; </span><span class="s6">65535</span><span class="s4">:</span>
            <span class="s1">max_size </span><span class="s4">= </span><span class="s6">65535</span>
        <span class="s1">r </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">Renderer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">id</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">max_size</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">)</span>
        <span class="s1">opt_reserve </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compute_opt_reserve</span><span class="s4">()</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">reserve</span><span class="s4">(</span><span class="s1">opt_reserve</span><span class="s4">)</span>
        <span class="s1">tsig_reserve </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_compute_tsig_reserve</span><span class="s4">()</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">reserve</span><span class="s4">(</span><span class="s1">tsig_reserve</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">question</span><span class="s4">:</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">add_question</span><span class="s4">(</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">answer</span><span class="s4">:</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">add_rrset</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">ANSWER</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">authority</span><span class="s4">:</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">add_rrset</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">AUTHORITY</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">rrset </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">additional</span><span class="s4">:</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">add_rrset</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">ADDITIONAL</span><span class="s4">, </span><span class="s1">rrset</span><span class="s4">, **</span><span class="s1">kw</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">TooBig</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">prefer_truncation</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">r</span><span class="s4">.</span><span class="s1">section </span><span class="s4">&lt; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">ADDITIONAL</span><span class="s4">:</span>
                    <span class="s1">r</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">TC</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">release_reserved</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">r</span><span class="s4">.</span><span class="s1">add_opt</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pad</span><span class="s4">, </span><span class="s1">opt_reserve</span><span class="s4">, </span><span class="s1">tsig_reserve</span><span class="s4">)</span>
        <span class="s1">r</span><span class="s4">.</span><span class="s1">write_header</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">new_tsig</span><span class="s4">, </span><span class="s1">ctx</span><span class="s4">) = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">sign</span><span class="s4">(</span>
                <span class="s1">r</span><span class="s4">.</span><span class="s1">get_wire</span><span class="s4">(),</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
                <span class="s1">int</span><span class="s4">(</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()),</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">request_mac</span><span class="s4">,</span>
                <span class="s1">tsig_ctx</span><span class="s4">,</span>
                <span class="s1">multi</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">clear</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">new_tsig</span><span class="s4">)</span>
            <span class="s1">r</span><span class="s4">.</span><span class="s1">add_rrset</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">renderer</span><span class="s4">.</span><span class="s1">ADDITIONAL</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">)</span>
            <span class="s1">r</span><span class="s4">.</span><span class="s1">write_header</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">multi</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig_ctx </span><span class="s4">= </span><span class="s1">ctx</span>
        <span class="s1">wire </span><span class="s4">= </span><span class="s1">r</span><span class="s4">.</span><span class="s1">get_wire</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">wire </span><span class="s4">= </span><span class="s1">wire</span>
        <span class="s3">if </span><span class="s1">prepend_length</span><span class="s4">:</span>
            <span class="s1">wire </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">).</span><span class="s1">to_bytes</span><span class="s4">(</span><span class="s6">2</span><span class="s4">, </span><span class="s5">&quot;big&quot;</span><span class="s4">) + </span><span class="s1">wire</span>
        <span class="s3">return </span><span class="s1">wire</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_make_tsig</span><span class="s4">(</span>
        <span class="s1">keyname</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">, </span><span class="s1">time_signed</span><span class="s4">, </span><span class="s1">fudge</span><span class="s4">, </span><span class="s1">mac</span><span class="s4">, </span><span class="s1">original_id</span><span class="s4">, </span><span class="s1">error</span><span class="s4">, </span><span class="s1">other</span>
    <span class="s4">):</span>
        <span class="s1">tsig </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">(</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">,</span>
            <span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">,</span>
            <span class="s1">algorithm</span><span class="s4">,</span>
            <span class="s1">time_signed</span><span class="s4">,</span>
            <span class="s1">fudge</span><span class="s4">,</span>
            <span class="s1">mac</span><span class="s4">,</span>
            <span class="s1">original_id</span><span class="s4">,</span>
            <span class="s1">error</span><span class="s4">,</span>
            <span class="s1">other</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span><span class="s1">keyname</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">tsig</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">use_tsig</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
        <span class="s1">keyname</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">fudge</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">300</span><span class="s4">,</span>
        <span class="s1">original_id</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">tsig_error</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">other_data</span><span class="s4">: </span><span class="s1">bytes </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span><span class="s4">,</span>
        <span class="s1">algorithm</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">default_algorithm</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;When sending, a TSIG signature using the specified key 
        should be added. 
 
        *key*, a ``dns.tsig.Key`` is the key to use.  If a key is specified, 
        the *keyring* and *algorithm* fields are not used. 
 
        *keyring*, a ``dict``, ``callable`` or ``dns.tsig.Key``, is either 
        the TSIG keyring or key to use. 
 
        The format of a keyring dict is a mapping from TSIG key name, as 
        ``dns.name.Name`` to ``dns.tsig.Key`` or a TSIG secret, a ``bytes``. 
        If a ``dict`` *keyring* is specified but a *keyname* is not, the key 
        used will be the first key in the *keyring*.  Note that the order of 
        keys in a dictionary is not defined, so applications should supply a 
        keyname when a ``dict`` keyring is used, unless they know the keyring 
        contains only one key.  If a ``callable`` keyring is specified, the 
        callable will be called with the message and the keyname, and is 
        expected to return a key. 
 
        *keyname*, a ``dns.name.Name``, ``str`` or ``None``, the name of 
        this TSIG key to use; defaults to ``None``.  If *keyring* is a 
        ``dict``, the key must be defined in it.  If *keyring* is a 
        ``dns.tsig.Key``, this is ignored. 
 
        *fudge*, an ``int``, the TSIG time fudge. 
 
        *original_id*, an ``int``, the TSIG original id.  If ``None``, 
        the message's id is used. 
 
        *tsig_error*, an ``int``, the TSIG error code. 
 
        *other_data*, a ``bytes``, the TSIG other data. 
 
        *algorithm*, a ``dns.name.Name`` or ``str``, the TSIG algorithm to use.  This is 
        only used if *keyring* is a ``dict``, and the key entry is a ``bytes``. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">keyring</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">):</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s1">keyring</span>
            <span class="s1">keyname </span><span class="s4">= </span><span class="s1">key</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s3">elif </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">keyring</span><span class="s4">):</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s1">keyring</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">keyname</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">keyname</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
                <span class="s1">keyname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">keyname</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">keyname </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">keyname </span><span class="s4">= </span><span class="s1">next</span><span class="s4">(</span><span class="s1">iter</span><span class="s4">(</span><span class="s1">keyring</span><span class="s4">))</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s1">keyring</span><span class="s4">[</span><span class="s1">keyname</span><span class="s4">]</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">):</span>
                <span class="s1">key </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">(</span><span class="s1">keyname</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">algorithm</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s4">= </span><span class="s1">key</span>
        <span class="s3">if </span><span class="s1">original_id </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">original_id </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">id</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tsig </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_tsig</span><span class="s4">(</span>
            <span class="s1">keyname</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">,</span>
            <span class="s6">0</span><span class="s4">,</span>
            <span class="s1">fudge</span><span class="s4">,</span>
            <span class="s7">b&quot;</span><span class="s3">\x00</span><span class="s7">&quot; </span><span class="s4">* </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">mac_sizes</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">],</span>
            <span class="s1">original_id</span><span class="s4">,</span>
            <span class="s1">tsig_error</span><span class="s4">,</span>
            <span class="s1">other_data</span><span class="s4">,</span>
        <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">keyname</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">keyalgorithm</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">algorithm</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">mac</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">mac</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">tsig_error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">error</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">had_tsig</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_make_opt</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">payload</span><span class="s4">=</span><span class="s1">DEFAULT_EDNS_PAYLOAD</span><span class="s4">, </span><span class="s1">options</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">opt </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdtypes</span><span class="s4">.</span><span class="s1">ANY</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">(</span><span class="s1">payload</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">, </span><span class="s1">options </span><span class="s3">or </span><span class="s4">())</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span><span class="s4">, </span><span class="s1">int</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">), </span><span class="s1">opt</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">use_edns</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">edns</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]] = </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">ednsflags</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
        <span class="s1">payload</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">DEFAULT_EDNS_PAYLOAD</span><span class="s4">,</span>
        <span class="s1">request_payload</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">options</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">Option</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">pad</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Configure EDNS behavior. 
 
        *edns*, an ``int``, is the EDNS level to use.  Specifying ``None``, ``False``, 
        or ``-1`` means &quot;do not use EDNS&quot;, and in this case the other parameters are 
        ignored.  Specifying ``True`` is equivalent to specifying 0, i.e. &quot;use EDNS0&quot;. 
 
        *ednsflags*, an ``int``, the EDNS flag values. 
 
        *payload*, an ``int``, is the EDNS sender's payload field, which is the maximum 
        size of UDP datagram the sender can handle.  I.e. how big a response to this 
        message can be. 
 
        *request_payload*, an ``int``, is the EDNS payload size to use when sending this 
        message.  If not specified, defaults to the value of *payload*. 
 
        *options*, a list of ``dns.edns.Option`` objects or ``None``, the EDNS options. 
 
        *pad*, a non-negative ``int``.  If 0, the default, do not pad; otherwise add 
        padding bytes to make the message size a multiple of *pad*.  Note that if 
        padding is non-zero, an EDNS PADDING option will always be added to the 
        message. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">edns </span><span class="s3">is None or </span><span class="s1">edns </span><span class="s3">is False</span><span class="s4">:</span>
            <span class="s1">edns </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s3">elif </span><span class="s1">edns </span><span class="s3">is True</span><span class="s4">:</span>
            <span class="s1">edns </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">if </span><span class="s1">edns </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">opt </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">request_payload </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># make sure the EDNS version in ednsflags agrees with edns</span>
            <span class="s1">ednsflags </span><span class="s4">&amp;= </span><span class="s6">0xFF00FFFF</span>
            <span class="s1">ednsflags </span><span class="s4">|= </span><span class="s1">edns </span><span class="s4">&lt;&lt; </span><span class="s6">16</span>
            <span class="s3">if </span><span class="s1">options </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">options </span><span class="s4">= []</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">opt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_opt</span><span class="s4">(</span><span class="s1">ednsflags</span><span class="s4">, </span><span class="s1">payload</span><span class="s4">, </span><span class="s1">options</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">request_payload </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">request_payload </span><span class="s4">= </span><span class="s1">payload</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">request_payload </span><span class="s4">= </span><span class="s1">request_payload</span>
            <span class="s3">if </span><span class="s1">pad </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">&quot;pad must be non-negative&quot;</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">pad </span><span class="s4">= </span><span class="s1">pad</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">edns</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">&amp; </span><span class="s6">0xFF0000</span><span class="s4">) &gt;&gt; </span><span class="s6">16</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">-</span><span class="s6">1</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">ednsflags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">ttl</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span>

    <span class="s4">@</span><span class="s1">ednsflags</span><span class="s4">.</span><span class="s1">setter</span>
    <span class="s3">def </span><span class="s1">ednsflags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">v</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">ttl </span><span class="s4">= </span><span class="s1">v</span>
        <span class="s3">elif </span><span class="s1">v</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">opt </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_opt</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">payload</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">payload</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s6">0</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">options</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">options</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">want_dnssec</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">wanted</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Enable or disable 'DNSSEC desired' flag in requests. 
 
        *wanted*, a ``bool``.  If ``True``, then DNSSEC data is 
        desired in the response, EDNS is enabled if required, and then 
        the DO bit is set.  If ``False``, the DO bit is cleared if 
        EDNS is enabled. 
        &quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">wanted</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">|= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">DO</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">&amp;= ~</span><span class="s1">int</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">DO</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">rcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">Rcode</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return the rcode. 
 
        Returns a ``dns.rcode.Rcode``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">from_flags</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">), </span><span class="s1">int</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">set_rcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rcode</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">Rcode</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Set the rcode. 
 
        *rcode*, a ``dns.rcode.Rcode``, is the rcode to set. 
        &quot;&quot;&quot;</span>
        <span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">evalue</span><span class="s4">) = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">to_flags</span><span class="s4">(</span><span class="s1">rcode</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp;= </span><span class="s6">0xFFF0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">value</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">&amp;= </span><span class="s6">0x00FFFFFF</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">|= </span><span class="s1">evalue</span>

    <span class="s3">def </span><span class="s1">opcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">Opcode</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return the opcode. 
 
        Returns a ``dns.opcode.Opcode``. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">from_flags</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">set_opcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">opcode</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">Opcode</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Set the opcode. 
 
        *opcode*, a ``dns.opcode.Opcode``, is the opcode to set. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp;= </span><span class="s6">0x87FF</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">to_flags</span><span class="s4">(</span><span class="s1">opcode</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_options</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">otype</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">OptionType</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">Option</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the list of options of the specified type.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">option </span><span class="s3">for </span><span class="s1">option </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">options </span><span class="s3">if </span><span class="s1">option</span><span class="s4">.</span><span class="s1">otype </span><span class="s4">== </span><span class="s1">otype</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">extended_errors</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">EDEOption</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Return the list of Extended DNS Error (EDE) options in the message&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">cast</span><span class="s4">(</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">EDEOption</span><span class="s4">], </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_options</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">OptionType</span><span class="s4">.</span><span class="s1">EDE</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">_get_one_rr_per_rrset</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s0"># What the caller picked is fine.</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s0"># pylint: disable=unused-argument</span>

    <span class="s3">def </span><span class="s1">_parse_rr_header</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>

    <span class="s0"># pylint: enable=unused-argument</span>

    <span class="s3">def </span><span class="s1">_parse_special_rr_header</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">position</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">section </span><span class="s4">!= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ADDITIONAL</span>
                <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">opt</span>
                <span class="s3">or </span><span class="s1">name </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">root</span>
            <span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">BadEDNS</span>
        <span class="s3">elif </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">section </span><span class="s4">!= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ADDITIONAL</span>
                <span class="s3">or </span><span class="s1">rdclass </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">ANY</span>
                <span class="s3">or </span><span class="s1">position </span><span class="s4">!= </span><span class="s1">count </span><span class="s4">- </span><span class="s6">1</span>
            <span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">BadTSIG</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">ChainingResult</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;The result of a call to dns.message.QueryMessage.resolve_chaining(). 
 
    The ``answer`` attribute is the answer RRSet, or ``None`` if it doesn't 
    exist. 
 
    The ``canonical_name`` attribute is the canonical name after all 
    chaining has been applied (this is the same name as ``rrset.name`` in cases 
    where rrset is not ``None``). 
 
    The ``minimum_ttl`` attribute is the minimum TTL, i.e. the TTL to 
    use if caching the data.  It is the smallest of all the CNAME TTLs 
    and either the answer TTL if it exists or the SOA TTL and SOA 
    minimum values for negative answers. 
 
    The ``cnames`` attribute is a list of all the CNAME RRSets followed to 
    get to the canonical name. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">canonical_name</span><span class="s4">: </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">,</span>
        <span class="s1">answer</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">],</span>
        <span class="s1">minimum_ttl</span><span class="s4">: </span><span class="s1">int</span><span class="s4">,</span>
        <span class="s1">cnames</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">RRset</span><span class="s4">],</span>
    <span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">canonical_name </span><span class="s4">= </span><span class="s1">canonical_name</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">answer </span><span class="s4">= </span><span class="s1">answer</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">minimum_ttl </span><span class="s4">= </span><span class="s1">minimum_ttl</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">cnames </span><span class="s4">= </span><span class="s1">cnames</span>


<span class="s3">class </span><span class="s1">QueryMessage</span><span class="s4">(</span><span class="s1">Message</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">resolve_chaining</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; ChainingResult</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Follow the CNAME chain in the response to determine the answer 
        RRset. 
 
        Raises ``dns.message.NotQueryResponse`` if the message is not 
        a response. 
 
        Raises ``dns.message.ChainTooLong`` if the CNAME chain is too long. 
 
        Raises ``dns.message.AnswerForNXDOMAIN`` if the rcode is NXDOMAIN 
        but an answer was found. 
 
        Raises ``dns.exception.FormError`` if the question count is not 1. 
 
        Returns a ChainingResult object. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">QR </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotQueryResponse</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">question</span><span class="s4">) != </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span>
        <span class="s1">question </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">question</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">qname </span><span class="s4">= </span><span class="s1">question</span><span class="s4">.</span><span class="s1">name</span>
        <span class="s1">min_ttl </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">.</span><span class="s1">MAX_TTL</span>
        <span class="s1">answer </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">count </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">cnames </span><span class="s4">= []</span>
        <span class="s3">while </span><span class="s1">count </span><span class="s4">&lt; </span><span class="s1">MAX_CHAIN</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">answer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">answer</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">question</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">question</span><span class="s4">.</span><span class="s1">rdtype</span>
                <span class="s4">)</span>
                <span class="s1">min_ttl </span><span class="s4">= </span><span class="s1">min</span><span class="s4">(</span><span class="s1">min_ttl</span><span class="s4">, </span><span class="s1">answer</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">)</span>
                <span class="s3">break</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">question</span><span class="s4">.</span><span class="s1">rdtype </span><span class="s4">!= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CNAME</span><span class="s4">:</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s1">crrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">answer</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">question</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">CNAME</span>
                        <span class="s4">)</span>
                        <span class="s1">cnames</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">crrset</span><span class="s4">)</span>
                        <span class="s1">min_ttl </span><span class="s4">= </span><span class="s1">min</span><span class="s4">(</span><span class="s1">min_ttl</span><span class="s4">, </span><span class="s1">crrset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">)</span>
                        <span class="s3">for </span><span class="s1">rd </span><span class="s3">in </span><span class="s1">crrset</span><span class="s4">:</span>
                            <span class="s1">qname </span><span class="s4">= </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">target</span>
                            <span class="s3">break</span>
                        <span class="s1">count </span><span class="s4">+= </span><span class="s6">1</span>
                        <span class="s3">continue</span>
                    <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                        <span class="s0"># Exit the chaining loop</span>
                        <span class="s3">break</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s0"># Exit the chaining loop</span>
                    <span class="s3">break</span>
        <span class="s3">if </span><span class="s1">count </span><span class="s4">&gt;= </span><span class="s1">MAX_CHAIN</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ChainTooLong</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">() == </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">NXDOMAIN </span><span class="s3">and </span><span class="s1">answer </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">AnswerForNXDOMAIN</span>
        <span class="s3">if </span><span class="s1">answer </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s0"># Further minimize the TTL with NCACHE.</span>
            <span class="s1">auname </span><span class="s4">= </span><span class="s1">qname</span>
            <span class="s3">while True</span><span class="s4">:</span>
                <span class="s0"># Look for an SOA RR whose owner name is a superdomain</span>
                <span class="s0"># of qname.</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">srrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">authority</span><span class="s4">, </span><span class="s1">auname</span><span class="s4">, </span><span class="s1">question</span><span class="s4">.</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA</span>
                    <span class="s4">)</span>
                    <span class="s1">min_ttl </span><span class="s4">= </span><span class="s1">min</span><span class="s4">(</span><span class="s1">min_ttl</span><span class="s4">, </span><span class="s1">srrset</span><span class="s4">.</span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">srrset</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">minimum</span><span class="s4">)</span>
                    <span class="s3">break</span>
                <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                    <span class="s3">try</span><span class="s4">:</span>
                        <span class="s1">auname </span><span class="s4">= </span><span class="s1">auname</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">()</span>
                    <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">NoParent</span><span class="s4">:</span>
                        <span class="s3">break</span>
        <span class="s3">return </span><span class="s1">ChainingResult</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">answer</span><span class="s4">, </span><span class="s1">min_ttl</span><span class="s4">, </span><span class="s1">cnames</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">canonical_name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Return the canonical name of the first name in the question 
        section. 
 
        Raises ``dns.message.NotQueryResponse`` if the message is not 
        a response. 
 
        Raises ``dns.message.ChainTooLong`` if the CNAME chain is too long. 
 
        Raises ``dns.message.AnswerForNXDOMAIN`` if the rcode is NXDOMAIN 
        but an answer was found. 
 
        Raises ``dns.exception.FormError`` if the question count is not 1. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">resolve_chaining</span><span class="s4">().</span><span class="s1">canonical_name</span>


<span class="s3">def </span><span class="s1">_maybe_import_update</span><span class="s4">():</span>
    <span class="s0"># We avoid circular imports by doing this here.  We do it in another</span>
    <span class="s0"># function as doing it in _message_factory_from_opcode() makes &quot;dns&quot;</span>
    <span class="s0"># a local symbol, and the first line fails :)</span>

    <span class="s0"># pylint: disable=redefined-outer-name,import-outside-toplevel,unused-import</span>
    <span class="s3">import </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">update  </span><span class="s0"># noqa: F401</span>


<span class="s3">def </span><span class="s1">_message_factory_from_opcode</span><span class="s4">(</span><span class="s1">opcode</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">opcode </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">QUERY</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">QueryMessage</span>
    <span class="s3">elif </span><span class="s1">opcode </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">UPDATE</span><span class="s4">:</span>
        <span class="s1">_maybe_import_update</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">update</span><span class="s4">.</span><span class="s1">UpdateMessage</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">Message</span>


<span class="s3">class </span><span class="s1">_WireReader</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Wire format reader. 
 
    parser: the binary parser 
    message: The message object being built 
    initialize_message: Callback to set message parsing options 
    question_only: Are we only reading the question? 
    one_rr_per_rrset: Put each RR into its own RRset? 
    keyring: TSIG keyring 
    ignore_trailing: Ignore trailing junk at end of request? 
    multi: Is this message part of a multi-message sequence? 
    DNS dynamic updates. 
    continue_on_error: try to extract as much information as possible from 
    the message, accumulating MessageErrors in the *errors* attribute instead of 
    raising them. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">wire</span><span class="s4">,</span>
        <span class="s1">initialize_message</span><span class="s4">,</span>
        <span class="s1">question_only</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">multi</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">continue_on_error</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">parser </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">wire</span><span class="s4">.</span><span class="s1">Parser</span><span class="s4">(</span><span class="s1">wire</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">initialize_message </span><span class="s4">= </span><span class="s1">initialize_message</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">question_only </span><span class="s4">= </span><span class="s1">question_only</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset </span><span class="s4">= </span><span class="s1">one_rr_per_rrset</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ignore_trailing </span><span class="s4">= </span><span class="s1">ignore_trailing</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s4">= </span><span class="s1">keyring</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">multi </span><span class="s4">= </span><span class="s1">multi</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">continue_on_error </span><span class="s4">= </span><span class="s1">continue_on_error</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">errors </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">_get_question</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section_number</span><span class="s4">, </span><span class="s1">qcount</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read the next *qcount* records from the wire data and add them to 
        the question section. 
        &quot;&quot;&quot;</span>
        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s3">is not None</span>
        <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">section_number</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">qcount</span><span class="s4">):</span>
            <span class="s1">qname </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">get_name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">)</span>
            <span class="s4">(</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">get_struct</span><span class="s4">(</span><span class="s5">&quot;!HH&quot;</span><span class="s4">)</span>
            <span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_parse_rr_header</span><span class="s4">(</span>
                <span class="s1">section_number</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                <span class="s1">section</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">create</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">force_unique</span><span class="s4">=</span><span class="s3">True</span>
            <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_add_error</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">e</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">errors</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">MessageError</span><span class="s4">(</span><span class="s1">e</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">current</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">_get_section</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section_number</span><span class="s4">, </span><span class="s1">count</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read the next I{count} records from the wire data and add them to 
        the specified section. 
 
        section_number: the section of the message to which to add records 
        count: the number of records to read 
        &quot;&quot;&quot;</span>
        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s3">is not None</span>
        <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">section_number</span><span class="s4">]</span>
        <span class="s1">force_unique </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">count</span><span class="s4">):</span>
            <span class="s1">rr_start </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">current</span>
            <span class="s1">absolute_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">get_name</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">name </span><span class="s4">= </span><span class="s1">absolute_name</span><span class="s4">.</span><span class="s1">relativize</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">name </span><span class="s4">= </span><span class="s1">absolute_name</span>
            <span class="s4">(</span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">rdlen</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">get_struct</span><span class="s4">(</span><span class="s5">&quot;!HHIH&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">rdtype </span><span class="s3">in </span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">):</span>
                <span class="s4">(</span>
                    <span class="s1">rdclass</span><span class="s4">,</span>
                    <span class="s1">rdtype</span><span class="s4">,</span>
                    <span class="s1">deleting</span><span class="s4">,</span>
                    <span class="s1">empty</span><span class="s4">,</span>
                <span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_parse_special_rr_header</span><span class="s4">(</span>
                    <span class="s1">section_number</span><span class="s4">, </span><span class="s1">count</span><span class="s4">, </span><span class="s1">i</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">deleting</span><span class="s4">, </span><span class="s1">empty</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_parse_rr_header</span><span class="s4">(</span>
                    <span class="s1">section_number</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span>
                <span class="s4">)</span>
            <span class="s1">rdata_start </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">current</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">empty</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">rdlen </span><span class="s4">&gt; </span><span class="s6">0</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span>
                    <span class="s1">rd </span><span class="s4">= </span><span class="s3">None</span>
                    <span class="s1">covers </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">NONE</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">with </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">restrict_to</span><span class="s4">(</span><span class="s1">rdlen</span><span class="s4">):</span>
                        <span class="s1">rd </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">from_wire_parser</span><span class="s4">(</span>
                            <span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span>
                        <span class="s4">)</span>
                    <span class="s1">covers </span><span class="s4">= </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">covers</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">xfr </span><span class="s3">and </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">SOA</span><span class="s4">:</span>
                    <span class="s1">force_unique </span><span class="s4">= </span><span class="s3">True</span>
                <span class="s3">if </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">OPT</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">opt </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">ttl</span><span class="s4">, </span><span class="s1">rd</span><span class="s4">)</span>
                <span class="s3">elif </span><span class="s1">rdtype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">TSIG</span><span class="s4">:</span>
                    <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s3">is None or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring </span><span class="s3">is True</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">UnknownTSIGKey</span><span class="s4">(</span><span class="s5">&quot;got signed message without keyring&quot;</span><span class="s4">)</span>
                    <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
                        <span class="s1">key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">absolute_name</span><span class="s4">)</span>
                        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">):</span>
                            <span class="s1">key </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">Key</span><span class="s4">(</span><span class="s1">absolute_name</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">algorithm</span><span class="s4">)</span>
                    <span class="s3">elif </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">):</span>
                        <span class="s1">key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">, </span><span class="s1">absolute_name</span><span class="s4">)</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">key </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">keyring</span>
                    <span class="s3">if </span><span class="s1">key </span><span class="s3">is None</span><span class="s4">:</span>
                        <span class="s3">raise </span><span class="s1">UnknownTSIGKey</span><span class="s4">(</span><span class="s5">f&quot;key '</span><span class="s3">{</span><span class="s1">name</span><span class="s3">}</span><span class="s5">' unknown&quot;</span><span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">key</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">keyring </span><span class="s4">= </span><span class="s1">key</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">tsig_ctx </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">validate</span><span class="s4">(</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">wire</span><span class="s4">,</span>
                            <span class="s1">key</span><span class="s4">,</span>
                            <span class="s1">absolute_name</span><span class="s4">,</span>
                            <span class="s1">rd</span><span class="s4">,</span>
                            <span class="s1">int</span><span class="s4">(</span><span class="s1">time</span><span class="s4">.</span><span class="s1">time</span><span class="s4">()),</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">request_mac</span><span class="s4">,</span>
                            <span class="s1">rr_start</span><span class="s4">,</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">tsig_ctx</span><span class="s4">,</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">multi</span><span class="s4">,</span>
                        <span class="s4">)</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">tsig </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rrset</span><span class="s4">.</span><span class="s1">from_rdata</span><span class="s4">(</span><span class="s1">absolute_name</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">rd</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
                        <span class="s1">section</span><span class="s4">,</span>
                        <span class="s1">name</span><span class="s4">,</span>
                        <span class="s1">rdclass</span><span class="s4">,</span>
                        <span class="s1">rdtype</span><span class="s4">,</span>
                        <span class="s1">covers</span><span class="s4">,</span>
                        <span class="s1">deleting</span><span class="s4">,</span>
                        <span class="s3">True</span><span class="s4">,</span>
                        <span class="s1">force_unique</span><span class="s4">,</span>
                    <span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">rd </span><span class="s3">is not None</span><span class="s4">:</span>
                        <span class="s3">if </span><span class="s1">ttl </span><span class="s4">&gt; </span><span class="s6">0x7FFFFFFF</span><span class="s4">:</span>
                            <span class="s1">ttl </span><span class="s4">= </span><span class="s6">0</span>
                        <span class="s1">rrset</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">rd</span><span class="s4">, </span><span class="s1">ttl</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">continue_on_error</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_add_error</span><span class="s4">(</span><span class="s1">e</span><span class="s4">)</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">seek</span><span class="s4">(</span><span class="s1">rdata_start </span><span class="s4">+ </span><span class="s1">rdlen</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s3">raise</span>

    <span class="s3">def </span><span class="s1">read</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read a wire format DNS message and build a dns.message.Message 
        object.&quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">remaining</span><span class="s4">() &lt; </span><span class="s6">12</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ShortHeader</span>
        <span class="s4">(</span><span class="s1">id</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">, </span><span class="s1">qcount</span><span class="s4">, </span><span class="s1">ancount</span><span class="s4">, </span><span class="s1">aucount</span><span class="s4">, </span><span class="s1">adcount</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">get_struct</span><span class="s4">(</span>
            <span class="s5">&quot;!HHHHHH&quot;</span>
        <span class="s4">)</span>
        <span class="s1">factory </span><span class="s4">= </span><span class="s1">_message_factory_from_opcode</span><span class="s4">(</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">from_flags</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s1">factory</span><span class="s4">(</span><span class="s1">id</span><span class="s4">=</span><span class="s1">id</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">Flag</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">wire </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">wire</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">initialize_message</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_get_one_rr_per_rrset</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset</span>
        <span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_get_question</span><span class="s4">(</span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">QUESTION</span><span class="s4">, </span><span class="s1">qcount</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">question_only</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_get_section</span><span class="s4">(</span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ANSWER</span><span class="s4">, </span><span class="s1">ancount</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_get_section</span><span class="s4">(</span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">AUTHORITY</span><span class="s4">, </span><span class="s1">aucount</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_get_section</span><span class="s4">(</span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ADDITIONAL</span><span class="s4">, </span><span class="s1">adcount</span><span class="s4">)</span>
            <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ignore_trailing </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">remaining</span><span class="s4">() != </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">TrailingJunk</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">multi </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">tsig_ctx </span><span class="s3">and not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">had_tsig</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">tsig_ctx</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">parser</span><span class="s4">.</span><span class="s1">wire</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">continue_on_error</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_add_error</span><span class="s4">(</span><span class="s1">e</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span>


<span class="s3">def </span><span class="s1">from_wire</span><span class="s4">(</span>
    <span class="s1">wire</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">,</span>
    <span class="s1">keyring</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Any</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">request_mac</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s7">b&quot;&quot;</span><span class="s4">,</span>
    <span class="s1">xfr</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">tsig_ctx</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">HMACTSig</span><span class="s4">, </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tsig</span><span class="s4">.</span><span class="s1">GSSTSig</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">multi</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">question_only</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ignore_trailing</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">raise_on_truncation</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">continue_on_error</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert a DNS wire format message into a message object. 
 
    *keyring*, a ``dns.tsig.Key``, ``dict``, ``bool``, or ``None``, the key or keyring 
    to use if the message is signed.  If ``None`` or ``True``, then trying to decode 
    a message with a TSIG will fail as it cannot be validated.  If ``False``, then 
    TSIG validation is disabled. 
 
    *request_mac*, a ``bytes`` or ``None``.  If the message is a response to a 
    TSIG-signed request, *request_mac* should be set to the MAC of that request. 
 
    *xfr*, a ``bool``, should be set to ``True`` if this message is part of a zone 
    transfer. 
 
    *origin*, a ``dns.name.Name`` or ``None``.  If the message is part of a zone 
    transfer, *origin* should be the origin name of the zone.  If not ``None``, names 
    will be relativized to the origin. 
 
    *tsig_ctx*, a ``dns.tsig.HMACTSig`` or ``dns.tsig.GSSTSig`` object, the ongoing TSIG 
    context, used when validating zone transfers. 
 
    *multi*, a ``bool``, should be set to ``True`` if this message is part of a multiple 
    message sequence. 
 
    *question_only*, a ``bool``.  If ``True``, read only up to the end of the question 
    section. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, put each RR into its own RRset. 
 
    *ignore_trailing*, a ``bool``.  If ``True``, ignore trailing junk at end of the 
    message. 
 
    *raise_on_truncation*, a ``bool``.  If ``True``, raise an exception if the TC bit is 
    set. 
 
    *continue_on_error*, a ``bool``.  If ``True``, try to continue parsing even if 
    errors occur.  Erroneous rdata will be ignored.  Errors will be accumulated as a 
    list of MessageError objects in the message's ``errors`` attribute.  This option is 
    recommended only for DNS analysis tools, or for use in a server as part of an error 
    handling path.  The default is ``False``. 
 
    Raises ``dns.message.ShortHeader`` if the message is less than 12 octets long. 
 
    Raises ``dns.message.TrailingJunk`` if there were octets in the message past the end 
    of the proper DNS message, and *ignore_trailing* is ``False``. 
 
    Raises ``dns.message.BadEDNS`` if an OPT record was in the wrong section, or 
    occurred more than once. 
 
    Raises ``dns.message.BadTSIG`` if a TSIG record was not the last record of the 
    additional data section. 
 
    Raises ``dns.message.Truncated`` if the TC flag is set and *raise_on_truncation* is 
    ``True``. 
 
    Returns a ``dns.message.Message``. 
    &quot;&quot;&quot;</span>

    <span class="s0"># We permit None for request_mac solely for backwards compatibility</span>
    <span class="s3">if </span><span class="s1">request_mac </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">request_mac </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">initialize_message</span><span class="s4">(</span><span class="s1">message</span><span class="s4">):</span>
        <span class="s1">message</span><span class="s4">.</span><span class="s1">request_mac </span><span class="s4">= </span><span class="s1">request_mac</span>
        <span class="s1">message</span><span class="s4">.</span><span class="s1">xfr </span><span class="s4">= </span><span class="s1">xfr</span>
        <span class="s1">message</span><span class="s4">.</span><span class="s1">origin </span><span class="s4">= </span><span class="s1">origin</span>
        <span class="s1">message</span><span class="s4">.</span><span class="s1">tsig_ctx </span><span class="s4">= </span><span class="s1">tsig_ctx</span>

    <span class="s1">reader </span><span class="s4">= </span><span class="s1">_WireReader</span><span class="s4">(</span>
        <span class="s1">wire</span><span class="s4">,</span>
        <span class="s1">initialize_message</span><span class="s4">,</span>
        <span class="s1">question_only</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s1">ignore_trailing</span><span class="s4">,</span>
        <span class="s1">keyring</span><span class="s4">,</span>
        <span class="s1">multi</span><span class="s4">,</span>
        <span class="s1">continue_on_error</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">read</span><span class="s4">()</span>
    <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">reader</span><span class="s4">.</span><span class="s1">message</span>
            <span class="s3">and </span><span class="s4">(</span><span class="s1">reader</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">TC</span><span class="s4">)</span>
            <span class="s3">and </span><span class="s1">raise_on_truncation</span>
        <span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">Truncated</span><span class="s4">(</span><span class="s1">message</span><span class="s4">=</span><span class="s1">reader</span><span class="s4">.</span><span class="s1">message</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise</span>
    <span class="s0"># Reading a truncated message might not have any errors, so we</span>
    <span class="s0"># have to do this check here too.</span>
    <span class="s3">if </span><span class="s1">m</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">TC </span><span class="s3">and </span><span class="s1">raise_on_truncation</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">Truncated</span><span class="s4">(</span><span class="s1">message</span><span class="s4">=</span><span class="s1">m</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">continue_on_error</span><span class="s4">:</span>
        <span class="s1">m</span><span class="s4">.</span><span class="s1">errors </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">errors</span>

    <span class="s3">return </span><span class="s1">m</span>


<span class="s3">class </span><span class="s1">_TextReader</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Text format reader. 
 
    tok: the tokenizer. 
    message: The message object being built. 
    DNS dynamic updates. 
    last_name: The most recently read name when building a message object. 
    one_rr_per_rrset: Put each RR into its own RRset? 
    origin: The origin for relative names 
    relativize: relativize names? 
    relativize_to: the origin to relativize to. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">text</span><span class="s4">,</span>
        <span class="s1">idna_codec</span><span class="s4">,</span>
        <span class="s1">one_rr_per_rrset</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">origin</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">relativize</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">relativize_to</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tok </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">tokenizer</span><span class="s4">.</span><span class="s1">Tokenizer</span><span class="s4">(</span><span class="s1">text</span><span class="s4">, </span><span class="s1">idna_codec</span><span class="s4">=</span><span class="s1">idna_codec</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">last_name </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset </span><span class="s4">= </span><span class="s1">one_rr_per_rrset</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">origin </span><span class="s4">= </span><span class="s1">origin</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">relativize </span><span class="s4">= </span><span class="s1">relativize</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">relativize_to </span><span class="s4">= </span><span class="s1">relativize_to</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= -</span><span class="s6">1</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">payload </span><span class="s4">= </span><span class="s1">DEFAULT_EDNS_PAYLOAD</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">rcode </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">opcode </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">QUERY</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s6">0</span>

    <span class="s3">def </span><span class="s1">_header_line</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">_</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Process one line from the text format header section.&quot;&quot;&quot;</span>

        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
        <span class="s1">what </span><span class="s4">= </span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span>
        <span class="s3">if </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;id&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">id </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_int</span><span class="s4">()</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;flags&quot;</span><span class="s4">:</span>
            <span class="s3">while True</span><span class="s4">:</span>
                <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
                <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">unget</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
                    <span class="s3">break</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">| </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;edns&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_int</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">| (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&lt;&lt; </span><span class="s6">16</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;eflags&quot;</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s3">while True</span><span class="s4">:</span>
                <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
                <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">unget</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
                    <span class="s3">break</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags </span><span class="s4">| </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">edns_from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;payload&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">payload </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_int</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;opcode&quot;</span><span class="s4">:</span>
            <span class="s1">text </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_string</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">opcode </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">| </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">.</span><span class="s1">to_flags</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">what </span><span class="s4">== </span><span class="s5">&quot;rcode&quot;</span><span class="s4">:</span>
            <span class="s1">text </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_string</span><span class="s4">()</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">rcode </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">text</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">UnknownHeaderField</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_eol</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_question_line</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section_number</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Process one line from the text format question section.&quot;&quot;&quot;</span>

        <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">section_number</span><span class="s4">]</span>
        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">want_leading</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_whitespace</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">last_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">as_name</span><span class="s4">(</span>
                <span class="s1">token</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">relativize</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">relativize_to</span>
            <span class="s4">)</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">last_name</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NoPreviousName</span>
        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s0"># Class</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
            <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
                <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span>
        <span class="s0"># Type</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">_</span><span class="s4">, </span><span class="s1">_</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_parse_rr_header</span><span class="s4">(</span>
            <span class="s1">section_number</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
            <span class="s1">section</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">create</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">force_unique</span><span class="s4">=</span><span class="s3">True</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_eol</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_rr_line</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">section_number</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Process one line from the text format answer, authority, or 
        additional data sections. 
        &quot;&quot;&quot;</span>

        <span class="s1">section </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">sections</span><span class="s4">[</span><span class="s1">section_number</span><span class="s4">]</span>
        <span class="s0"># Name</span>
        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">want_leading</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_whitespace</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">last_name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">as_name</span><span class="s4">(</span>
                <span class="s1">token</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">relativize</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">relativize_to</span>
            <span class="s4">)</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">last_name</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NoPreviousName</span>
        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s0"># TTL</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">ttl </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
            <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
                <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s1">ttl </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s0"># Class</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
            <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
            <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_identifier</span><span class="s4">():</span>
                <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
            <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span>
        <span class="s0"># Type</span>
        <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">deleting</span><span class="s4">, </span><span class="s1">empty</span><span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">_parse_rr_header</span><span class="s4">(</span>
            <span class="s1">section_number</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span>
        <span class="s4">)</span>
        <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">empty </span><span class="s3">and not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_eol_or_eof</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">SyntaxError</span>
        <span class="s3">if not </span><span class="s1">empty </span><span class="s3">and </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_eol_or_eof</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">UnexpectedEnd</span>
        <span class="s3">if not </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_eol_or_eof</span><span class="s4">():</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">unget</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
            <span class="s1">rd </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdata</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span>
                <span class="s1">rdclass</span><span class="s4">,</span>
                <span class="s1">rdtype</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">relativize</span><span class="s4">,</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">relativize_to</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s1">covers </span><span class="s4">= </span><span class="s1">rd</span><span class="s4">.</span><span class="s1">covers</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">rd </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">covers </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">NONE</span>
        <span class="s1">rrset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span>
            <span class="s1">section</span><span class="s4">,</span>
            <span class="s1">name</span><span class="s4">,</span>
            <span class="s1">rdclass</span><span class="s4">,</span>
            <span class="s1">rdtype</span><span class="s4">,</span>
            <span class="s1">covers</span><span class="s4">,</span>
            <span class="s1">deleting</span><span class="s4">,</span>
            <span class="s3">True</span><span class="s4">,</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">if </span><span class="s1">rd </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">rrset</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">rd</span><span class="s4">, </span><span class="s1">ttl</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_make_message</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">factory </span><span class="s4">= </span><span class="s1">_message_factory_from_opcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">)</span>
        <span class="s1">message </span><span class="s4">= </span><span class="s1">factory</span><span class="s4">(</span><span class="s1">id</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">id</span><span class="s4">)</span>
        <span class="s1">message</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&gt;= </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">message</span><span class="s4">.</span><span class="s1">use_edns</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ednsflags</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">payload</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">:</span>
            <span class="s1">message</span><span class="s4">.</span><span class="s1">set_rcode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">rcode</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">origin</span><span class="s4">:</span>
            <span class="s1">message</span><span class="s4">.</span><span class="s1">origin </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">origin</span>
        <span class="s3">return </span><span class="s1">message</span>

    <span class="s3">def </span><span class="s1">read</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Read a text format DNS message and build a dns.message.Message 
        object.&quot;&quot;&quot;</span>

        <span class="s1">line_method </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_header_line</span>
        <span class="s1">section_number </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">while </span><span class="s6">1</span><span class="s4">:</span>
            <span class="s1">token </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_eol_or_eof</span><span class="s4">():</span>
                <span class="s3">break</span>
            <span class="s3">if </span><span class="s1">token</span><span class="s4">.</span><span class="s1">is_comment</span><span class="s4">():</span>
                <span class="s1">u </span><span class="s4">= </span><span class="s1">token</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">upper</span><span class="s4">()</span>
                <span class="s3">if </span><span class="s1">u </span><span class="s4">== </span><span class="s5">&quot;HEADER&quot;</span><span class="s4">:</span>
                    <span class="s1">line_method </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_header_line</span>

                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">:</span>
                    <span class="s1">message </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s0"># If we don't have a message, create one with the current</span>
                    <span class="s0"># opcode, so that we know which section names to parse.</span>
                    <span class="s1">message </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_message</span><span class="s4">()</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">section_number </span><span class="s4">= </span><span class="s1">message</span><span class="s4">.</span><span class="s1">_section_enum</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">u</span><span class="s4">)</span>
                    <span class="s0"># We found a section name.  If we don't have a message,</span>
                    <span class="s0"># use the one we just created.</span>
                    <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">:</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s1">message</span>
                        <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset </span><span class="s4">= </span><span class="s1">message</span><span class="s4">.</span><span class="s1">_get_one_rr_per_rrset</span><span class="s4">(</span>
                            <span class="s1">self</span><span class="s4">.</span><span class="s1">one_rr_per_rrset</span>
                        <span class="s4">)</span>
                    <span class="s3">if </span><span class="s1">section_number </span><span class="s4">== </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">QUESTION</span><span class="s4">:</span>
                        <span class="s1">line_method </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_question_line</span>
                    <span class="s3">else</span><span class="s4">:</span>
                        <span class="s1">line_method </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_rr_line</span>
                <span class="s3">except </span><span class="s1">Exception</span><span class="s4">:</span>
                    <span class="s0"># It's just a comment.</span>
                    <span class="s3">pass</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">get_eol</span><span class="s4">()</span>
                <span class="s3">continue</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">tok</span><span class="s4">.</span><span class="s1">unget</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
            <span class="s1">line_method</span><span class="s4">(</span><span class="s1">section_number</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_make_message</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">message</span>


<span class="s3">def </span><span class="s1">from_text</span><span class="s4">(</span>
    <span class="s1">text</span><span class="s4">: </span><span class="s1">str</span><span class="s4">,</span>
    <span class="s1">idna_codec</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">IDNACodec</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">origin</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">relativize</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s1">relativize_to</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Convert the text format message into a message object. 
 
    The reader stops after reading the first blank line in the input to 
    facilitate reading multiple messages from a single file with 
    ``dns.message.from_file()``. 
 
    *text*, a ``str``, the text format message. 
 
    *idna_codec*, a ``dns.name.IDNACodec``, specifies the IDNA 
    encoder/decoder.  If ``None``, the default IDNA 2003 encoder/decoder 
    is used. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, then each RR is put 
    into its own rrset.  The default is ``False``. 
 
    *origin*, a ``dns.name.Name`` (or ``None``), the 
    origin to use for relative names. 
 
    *relativize*, a ``bool``.  If true, name will be relativized. 
 
    *relativize_to*, a ``dns.name.Name`` (or ``None``), the origin to use 
    when relativizing names.  If not set, the *origin* value will be used. 
 
    Raises ``dns.message.UnknownHeaderField`` if a header is unknown. 
 
    Raises ``dns.exception.SyntaxError`` if the text is badly formed. 
 
    Returns a ``dns.message.Message object`` 
    &quot;&quot;&quot;</span>

    <span class="s0"># 'text' can also be a file, but we don't publish that fact</span>
    <span class="s0"># since it's an implementation detail.  The official file</span>
    <span class="s0"># interface is from_file().</span>

    <span class="s1">reader </span><span class="s4">= </span><span class="s1">_TextReader</span><span class="s4">(</span>
        <span class="s1">text</span><span class="s4">, </span><span class="s1">idna_codec</span><span class="s4">, </span><span class="s1">one_rr_per_rrset</span><span class="s4">, </span><span class="s1">origin</span><span class="s4">, </span><span class="s1">relativize</span><span class="s4">, </span><span class="s1">relativize_to</span>
    <span class="s4">)</span>
    <span class="s3">return </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">read</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">from_file</span><span class="s4">(</span>
    <span class="s1">f</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
    <span class="s1">idna_codec</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">IDNACodec</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">one_rr_per_rrset</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Read the next text format message from the specified file. 
 
    Message blocks are separated by a single blank line. 
 
    *f*, a ``file`` or ``str``.  If *f* is text, it is treated as the 
    pathname of a file to open. 
 
    *idna_codec*, a ``dns.name.IDNACodec``, specifies the IDNA 
    encoder/decoder.  If ``None``, the default IDNA 2003 encoder/decoder 
    is used. 
 
    *one_rr_per_rrset*, a ``bool``.  If ``True``, then each RR is put 
    into its own rrset.  The default is ``False``. 
 
    Raises ``dns.message.UnknownHeaderField`` if a header is unknown. 
 
    Raises ``dns.exception.SyntaxError`` if the text is badly formed. 
 
    Returns a ``dns.message.Message object`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">cm</span><span class="s4">: </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">AbstractContextManager </span><span class="s4">= </span><span class="s1">open</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">cm </span><span class="s4">= </span><span class="s1">contextlib</span><span class="s4">.</span><span class="s1">nullcontext</span><span class="s4">(</span><span class="s1">f</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">cm </span><span class="s3">as </span><span class="s1">f</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">f</span><span class="s4">, </span><span class="s1">idna_codec</span><span class="s4">, </span><span class="s1">one_rr_per_rrset</span><span class="s4">)</span>
    <span class="s3">assert False  </span><span class="s0"># for mypy  lgtm[py/unreachable-statement]</span>


<span class="s3">def </span><span class="s1">make_query</span><span class="s4">(</span>
    <span class="s1">qname</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdtype</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">, </span><span class="s1">str</span><span class="s4">],</span>
    <span class="s1">rdclass</span><span class="s4">: </span><span class="s1">Union</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">, </span><span class="s1">str</span><span class="s4">] = </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">IN</span><span class="s4">,</span>
    <span class="s1">use_edns</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">bool</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">want_dnssec</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">ednsflags</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">payload</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">request_payload</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">options</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">List</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">Option</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">idna_codec</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">IDNACodec</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">id</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">flags</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">RD</span><span class="s4">,</span>
    <span class="s1">pad</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; QueryMessage</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Make a query message. 
 
    The query name, type, and class may all be specified either 
    as objects of the appropriate type, or as strings. 
 
    The query will have a randomly chosen query id, and its DNS flags 
    will be set to dns.flags.RD. 
 
    qname, a ``dns.name.Name`` or ``str``, the query name. 
 
    *rdtype*, an ``int`` or ``str``, the desired rdata type. 
 
    *rdclass*, an ``int`` or ``str``,  the desired rdata class; the default 
    is class IN. 
 
    *use_edns*, an ``int``, ``bool`` or ``None``.  The EDNS level to use; the 
    default is ``None``.  If ``None``, EDNS will be enabled only if other 
    parameters (*ednsflags*, *payload*, *request_payload*, or *options*) are 
    set. 
    See the description of dns.message.Message.use_edns() for the possible 
    values for use_edns and their meanings. 
 
    *want_dnssec*, a ``bool``.  If ``True``, DNSSEC data is desired. 
 
    *ednsflags*, an ``int``, the EDNS flag values. 
 
    *payload*, an ``int``, is the EDNS sender's payload field, which is the 
    maximum size of UDP datagram the sender can handle.  I.e. how big 
    a response to this message can be. 
 
    *request_payload*, an ``int``, is the EDNS payload size to use when 
    sending this message.  If not specified, defaults to the value of 
    *payload*. 
 
    *options*, a list of ``dns.edns.Option`` objects or ``None``, the EDNS 
    options. 
 
    *idna_codec*, a ``dns.name.IDNACodec``, specifies the IDNA 
    encoder/decoder.  If ``None``, the default IDNA 2003 encoder/decoder 
    is used. 
 
    *id*, an ``int`` or ``None``, the desired query id.  The default is 
    ``None``, which generates a random query id. 
 
    *flags*, an ``int``, the desired query flags.  The default is 
    ``dns.flags.RD``. 
 
    *pad*, a non-negative ``int``.  If 0, the default, do not pad; otherwise add 
    padding bytes to make the message size a multiple of *pad*.  Note that if 
    padding is non-zero, an EDNS PADDING option will always be added to the 
    message. 
 
    Returns a ``dns.message.QueryMessage`` 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">str</span><span class="s4">):</span>
        <span class="s1">qname </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">from_text</span><span class="s4">(</span><span class="s1">qname</span><span class="s4">, </span><span class="s1">idna_codec</span><span class="s4">=</span><span class="s1">idna_codec</span><span class="s4">)</span>
    <span class="s1">rdtype </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdatatype</span><span class="s4">.</span><span class="s1">RdataType</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdtype</span><span class="s4">)</span>
    <span class="s1">rdclass </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">rdataclass</span><span class="s4">.</span><span class="s1">RdataClass</span><span class="s4">.</span><span class="s1">make</span><span class="s4">(</span><span class="s1">rdclass</span><span class="s4">)</span>
    <span class="s1">m </span><span class="s4">= </span><span class="s1">QueryMessage</span><span class="s4">(</span><span class="s1">id</span><span class="s4">=</span><span class="s1">id</span><span class="s4">)</span>
    <span class="s1">m</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">Flag</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>
    <span class="s1">m</span><span class="s4">.</span><span class="s1">find_rrset</span><span class="s4">(</span><span class="s1">m</span><span class="s4">.</span><span class="s1">question</span><span class="s4">, </span><span class="s1">qname</span><span class="s4">, </span><span class="s1">rdclass</span><span class="s4">, </span><span class="s1">rdtype</span><span class="s4">, </span><span class="s1">create</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">force_unique</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s0"># only pass keywords on to use_edns if they have been set to a</span>
    <span class="s0"># non-None value.  Setting a field will turn EDNS on if it hasn't</span>
    <span class="s0"># been configured.</span>
    <span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = {}</span>
    <span class="s3">if </span><span class="s1">ednsflags </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;ednsflags&quot;</span><span class="s4">] = </span><span class="s1">ednsflags</span>
    <span class="s3">if </span><span class="s1">payload </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;payload&quot;</span><span class="s4">] = </span><span class="s1">payload</span>
    <span class="s3">if </span><span class="s1">request_payload </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;request_payload&quot;</span><span class="s4">] = </span><span class="s1">request_payload</span>
    <span class="s3">if </span><span class="s1">options </span><span class="s3">is not None</span><span class="s4">:</span>
        <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;options&quot;</span><span class="s4">] = </span><span class="s1">options</span>
    <span class="s3">if </span><span class="s1">kwargs </span><span class="s3">and </span><span class="s1">use_edns </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">use_edns </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;edns&quot;</span><span class="s4">] = </span><span class="s1">use_edns</span>
    <span class="s1">kwargs</span><span class="s4">[</span><span class="s5">&quot;pad&quot;</span><span class="s4">] = </span><span class="s1">pad</span>
    <span class="s1">m</span><span class="s4">.</span><span class="s1">use_edns</span><span class="s4">(**</span><span class="s1">kwargs</span><span class="s4">)</span>
    <span class="s1">m</span><span class="s4">.</span><span class="s1">want_dnssec</span><span class="s4">(</span><span class="s1">want_dnssec</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">m</span>


<span class="s3">class </span><span class="s1">CopyMode</span><span class="s4">(</span><span class="s1">enum</span><span class="s4">.</span><span class="s1">Enum</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    How should sections be copied when making an update response? 
    &quot;&quot;&quot;</span>

    <span class="s1">NOTHING </span><span class="s4">= </span><span class="s6">0</span>
    <span class="s1">QUESTION </span><span class="s4">= </span><span class="s6">1</span>
    <span class="s1">EVERYTHING </span><span class="s4">= </span><span class="s6">2</span>


<span class="s3">def </span><span class="s1">make_response</span><span class="s4">(</span>
    <span class="s1">query</span><span class="s4">: </span><span class="s1">Message</span><span class="s4">,</span>
    <span class="s1">recursion_available</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">our_payload</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">8192</span><span class="s4">,</span>
    <span class="s1">fudge</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">300</span><span class="s4">,</span>
    <span class="s1">tsig_error</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span><span class="s4">,</span>
    <span class="s1">pad</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">int</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s1">copy_mode</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">CopyMode</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
<span class="s4">) </span><span class="s1">-&gt; Message</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Make a message which is a response for the specified query. 
    The message returned is really a response skeleton; it has all of the infrastructure 
    required of a response, but none of the content. 
 
    Response section(s) which are copied are shallow copies of the matching section(s) 
    in the query, so the query's RRsets should not be changed. 
 
    *query*, a ``dns.message.Message``, the query to respond to. 
 
    *recursion_available*, a ``bool``, should RA be set in the response? 
 
    *our_payload*, an ``int``, the payload size to advertise in EDNS responses. 
 
    *fudge*, an ``int``, the TSIG time fudge. 
 
    *tsig_error*, an ``int``, the TSIG error. 
 
    *pad*, a non-negative ``int`` or ``None``.  If 0, the default, do not pad; otherwise 
    if not ``None`` add padding bytes to make the message size a multiple of *pad*. Note 
    that if padding is non-zero, an EDNS PADDING option will always be added to the 
    message.  If ``None``, add padding following RFC 8467, namely if the request is 
    padded, pad the response to 468 otherwise do not pad. 
 
    *copy_mode*, a ``dns.message.CopyMode`` or ``None``, determines how sections are 
    copied.  The default, ``None`` copies sections according to the default for the 
    message's opcode, which is currently ``dns.message.CopyMode.QUESTION`` for all 
    opcodes.   ``dns.message.CopyMode.QUESTION`` copies only the question section. 
    ``dns.message.CopyMode.EVERYTHING`` copies all sections other than OPT or TSIG 
    records, which are created appropriately if needed. ``dns.message.CopyMode.NOTHING`` 
    copies no sections; note that this mode is for server testing purposes and is 
    otherwise not recommended for use.  In particular, ``dns.message.is_response()`` 
    will be ``False`` if you create a response this way and the rcode is not 
    ``FORMERR``, ``SERVFAIL``, ``NOTIMP``, or ``REFUSED``. 
 
    Returns a ``dns.message.Message`` object whose specific class is appropriate for the 
    query.  For example, if query is a ``dns.update.UpdateMessage``, the response will 
    be one too. 
    &quot;&quot;&quot;</span>

    <span class="s3">if </span><span class="s1">query</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">QR</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">exception</span><span class="s4">.</span><span class="s1">FormError</span><span class="s4">(</span><span class="s5">&quot;specified query message is not a query&quot;</span><span class="s4">)</span>
    <span class="s1">opcode </span><span class="s4">= </span><span class="s1">query</span><span class="s4">.</span><span class="s1">opcode</span><span class="s4">()</span>
    <span class="s1">factory </span><span class="s4">= </span><span class="s1">_message_factory_from_opcode</span><span class="s4">(</span><span class="s1">opcode</span><span class="s4">)</span>
    <span class="s1">response </span><span class="s4">= </span><span class="s1">factory</span><span class="s4">(</span><span class="s1">id</span><span class="s4">=</span><span class="s1">query</span><span class="s4">.</span><span class="s1">id</span><span class="s4">)</span>
    <span class="s1">response</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">QR </span><span class="s4">| (</span><span class="s1">query</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">RD</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">recursion_available</span><span class="s4">:</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">.</span><span class="s1">RA</span>
    <span class="s1">response</span><span class="s4">.</span><span class="s1">set_opcode</span><span class="s4">(</span><span class="s1">opcode</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">copy_mode </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">copy_mode </span><span class="s4">= </span><span class="s1">CopyMode</span><span class="s4">.</span><span class="s1">QUESTION</span>
    <span class="s3">if </span><span class="s1">copy_mode </span><span class="s4">!= </span><span class="s1">CopyMode</span><span class="s4">.</span><span class="s1">NOTHING</span><span class="s4">:</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">question </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">query</span><span class="s4">.</span><span class="s1">question</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">copy_mode </span><span class="s4">== </span><span class="s1">CopyMode</span><span class="s4">.</span><span class="s1">EVERYTHING</span><span class="s4">:</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">answer </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">query</span><span class="s4">.</span><span class="s1">answer</span><span class="s4">)</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">authority </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">query</span><span class="s4">.</span><span class="s1">authority</span><span class="s4">)</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">additional </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">query</span><span class="s4">.</span><span class="s1">additional</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">query</span><span class="s4">.</span><span class="s1">edns </span><span class="s4">&gt;= </span><span class="s6">0</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">pad </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s0"># Set response padding per RFC 8467</span>
            <span class="s1">pad </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s3">for </span><span class="s1">option </span><span class="s3">in </span><span class="s1">query</span><span class="s4">.</span><span class="s1">options</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">option</span><span class="s4">.</span><span class="s1">otype </span><span class="s4">== </span><span class="s1">dns</span><span class="s4">.</span><span class="s1">edns</span><span class="s4">.</span><span class="s1">OptionType</span><span class="s4">.</span><span class="s1">PADDING</span><span class="s4">:</span>
                    <span class="s1">pad </span><span class="s4">= </span><span class="s6">468</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">use_edns</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s1">our_payload</span><span class="s4">, </span><span class="s1">query</span><span class="s4">.</span><span class="s1">payload</span><span class="s4">, </span><span class="s1">pad</span><span class="s4">=</span><span class="s1">pad</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">query</span><span class="s4">.</span><span class="s1">had_tsig</span><span class="s4">:</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">use_tsig</span><span class="s4">(</span>
            <span class="s1">query</span><span class="s4">.</span><span class="s1">keyring</span><span class="s4">,</span>
            <span class="s1">query</span><span class="s4">.</span><span class="s1">keyname</span><span class="s4">,</span>
            <span class="s1">fudge</span><span class="s4">,</span>
            <span class="s3">None</span><span class="s4">,</span>
            <span class="s1">tsig_error</span><span class="s4">,</span>
            <span class="s7">b&quot;&quot;</span><span class="s4">,</span>
            <span class="s1">query</span><span class="s4">.</span><span class="s1">keyalgorithm</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">response</span><span class="s4">.</span><span class="s1">request_mac </span><span class="s4">= </span><span class="s1">query</span><span class="s4">.</span><span class="s1">mac</span>
    <span class="s3">return </span><span class="s1">response</span>


<span class="s0">### BEGIN generated MessageSection constants</span>

<span class="s1">QUESTION </span><span class="s4">= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">QUESTION</span>
<span class="s1">ANSWER </span><span class="s4">= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ANSWER</span>
<span class="s1">AUTHORITY </span><span class="s4">= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">AUTHORITY</span>
<span class="s1">ADDITIONAL </span><span class="s4">= </span><span class="s1">MessageSection</span><span class="s4">.</span><span class="s1">ADDITIONAL</span>

<span class="s0">### END generated MessageSection constants</span>
</pre>
</body>
</html>